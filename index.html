<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AIè¼”åŠ©åˆ¶è‡ª-ç·šä¸ŠèªéŸ³å¾ªç’°æ’­æ”¾éŸ³æ„Ÿè¨“ç·´å™¨</title>
  <style>
    :root {
      --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af; --border:#1f2937;
      --btn:#1f2937; --btn-hover:#374151; --key-white:#e5e7eb; --key-black:#111827;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Microsoft JhengHei","PingFang TC","Heiti TC",sans-serif;background:radial-gradient(1000px 600px at 80% -10%,#1f293766,transparent),radial-gradient(800px 500px at -10% 20%,#14532d66,transparent),var(--bg);color:var(--text)}
    .container{max-width:1080px;margin:0 auto;padding:24px 16px 84px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:20px}
    .title{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#16a34a,#22c55e);display:grid;place-items:center;color:#fff;font-weight:800}
    h1{margin:0;font-size:22px;letter-spacing:.3px}
    .panel{background:#111827ee;border:1px solid var(--border);border-radius:12px;padding:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:1000px){.grid{grid-template-columns:420px 1fr}}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .grow{flex:1 1 auto}
    label{color:var(--muted);font-size:13px}
    select,input[type=range]{width:100%;background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    .btn{background:var(--btn);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px 14px;cursor:pointer;transition:background .15s,transform .02s}
    .btn:hover{background:var(--btn-hover)} .btn:active{transform:translateY(1px)}
    .answers{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .answer-btn{padding:12px 10px;background:#0b1220;border:1px solid var(--border);border-radius:12px;color:var(--text);cursor:pointer}
    .score{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px;border-radius:12px;background:#0b1220;border:1px solid var(--border)}
    .hint{color:var(--muted);font-size:13px}
    .status-hints-container{display:flex;align-items:center;gap:8px;margin-top:12px;flex-wrap:wrap;justify-content:center}
    .status-hint{font-size:15px;font-weight:600;padding:10px 16px;border-radius:8px;background:#0b1220;border:2px solid var(--border);transition:all 0.3s ease;white-space:nowrap;min-width:110px;text-align:center;position:relative}
    .status-hint.active{color:#22c55e;border-color:#22c55e;background:linear-gradient(135deg,#14532d88,#22c55e44);box-shadow:0 0 16px rgba(34,197,94,0.4),inset 0 0 20px rgba(34,197,94,0.1);transform:scale(1.08);font-weight:700}
    .status-hint.inactive{color:var(--muted);opacity:0.35;border-color:var(--border)}
    .status-arrow{color:var(--muted);font-size:24px;font-weight:bold;opacity:0.5;transition:all 0.3s ease;padding:0 4px}
    .status-arrow.active{color:#22c55e;opacity:1;transform:scale(1.3);text-shadow:0 0 8px rgba(34,197,94,0.6)}

    /* Piano */
    .kbd-wrap{margin-top:12px}
    .piano{position:relative;height:160px;user-select:none}
    .white-keys{display:flex;height:100%}
    .white-key{position:relative;flex:1 1 0;background:var(--key-white);border:1px solid #374151;border-bottom-width:6px;border-radius:0 0 6px 6px;margin-right:-1px}
    .white-key.active{background:#c7f9cc;border-color:#22c55e}
    .black-key{position:absolute;top:0;height:62%;background:linear-gradient(#222,#000);border:1px solid #000;border-bottom-width:6px;border-radius:0 0 6px 6px;transform:translateX(-50%);z-index:5}
    .black-key.active{background:#22c55e;border-color:#14532d}
    .solfege{margin-top:10px;padding:10px;border:1px solid var(--border);border-radius:10px;background:#0b1220;font-size:14px}
    .solfege b{color:#22c55e}
    /* Key labels */
    .key-label{position:absolute;left:50%;transform:translateX(-50%);bottom:6px;font-size:12px;line-height:1.05;font-weight:600;pointer-events:none;user-select:none;text-align:center;white-space:pre}
    .key-label--white{color:#111827}
    .key-label--black{color:#e5e7eb;font-size:11px;bottom:4px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">
        <div class="logo">â™ª</div>
        <div>
          <h1>AIè¼”åŠ©åˆ¶è‡ª-ç·šä¸ŠèªéŸ³å¾ªç’°æ’­æ”¾éŸ³æ„Ÿè¨“ç·´å™¨</h1>
          <div class="hint">å–®éŸ³ï¼šå…ˆæ’­ 3 æ¬¡çµ„å…§ C åšåŸºæº–ï¼Œå†å‡ºé¡Œï¼›ç”¨é»éµä½œç­”</div>
        </div>
      </div>
      <button id="playBtn" class="btn">æ’­æ”¾é¡Œç›® (ç©ºç™½)</button>
    </header>

    <div class="grid">
      <section class="panel">
        <div class="row">
          <div class="grow">
            <label for="mode">æ¨¡å¼</label>
            <select id="mode">
              <option value="note">éŸ³é«˜è¾¨è­˜ï¼ˆå–®éŸ³ï¼‰</option>
              <option value="interval_up">éŸ³ç¨‹è¾¨è­˜ï¼ˆä¸Šè¡Œï¼‰</option>
              <option value="interval_down">éŸ³ç¨‹è¾¨è­˜ï¼ˆä¸‹è¡Œï¼‰</option>
              <option value="interval_harm">éŸ³ç¨‹è¾¨è­˜ï¼ˆå’Œè²/åŒæ™‚ï¼‰</option>
              <option value="triad">å’Œå¼¦è¾¨è­˜ï¼ˆä¸‰å’Œå¼¦ï¼‰</option>
              <option value="seventh">å’Œå¼¦è¾¨è­˜ï¼ˆä¸ƒå’Œå¼¦ï¼‰</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="grow">
            <label for="wave">éŸ³è‰²</label>
            <select id="wave">
              <option value="sine">Sine</option>
              <option value="triangle">Triangle</option>
              <option value="square">Square</option>
              <option value="sawtooth">Sawtooth</option>
              <option value="piano">Pianoï¼ˆé‹¼ç´-åˆæˆï¼‰</option>
            </select>
          </div>
          <div style="width:160px">
            <label for="volume">éŸ³é‡</label>
            <input id="volume" type="range" min="0" max="1" step="0.01" value="0.25">
          </div>
        </div>

        <!-- å–®éŸ³å‡ºé¡ŒéŸ³åŸŸé™åˆ¶ï¼šç™½éµ/å…¨éƒ¨ -->
        <div class="row">
          <div class="grow">
            <label for="noteScope">å–®éŸ³å‡ºé¡Œå…§å®¹</label>
            <select id="noteScope">
              <option value="all">ç™½éµ + é»‘éµï¼ˆå…¨éƒ¨ï¼‰</option>
              <option value="white">åªå‡ºç™½éµï¼ˆC D E F G A Bï¼‰</option>
            </select>
          </div>
        </div>

        <!-- å–®éŸ³ï¼šè‡ªå‹•å…¬å¸ƒç­”æ¡ˆè¨ˆæ™‚ -->
        <div class="row">
          <div class="grow">
            <label for="revealAfter">è‡ªå‹•å…¬å¸ƒç­”æ¡ˆï¼ˆç§’ï¼‰</label>
            <select id="revealAfter">
              <option value="1">1 ç§’</option>
              <option value="3">3 ç§’</option>
              <option value="5">5 ç§’</option>
              <option value="7">7 ç§’</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="grow">
            <label>ç›®å‰çµ„åˆ¥ï¼ˆCnâ€“C(n+1)ï¼‰</label>
            <div class="row">
              <button id="prevGroup" class="btn">â—€ ä¸Šä¸€çµ„</button>
              <div id="groupLabel" class="grow" style="text-align:center;font-weight:700">C4â€“C5</div>
              <button id="nextGroup" class="btn">ä¸‹ä¸€çµ„ â–¶</button>
            </div>
            <div class="hint" style="margin-top:6px">æ‰€æœ‰é¡Œç›®é™åˆ¶åœ¨æ­¤çµ„ï¼Œå«ä¸Šç•Œ Cã€‚</div>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <button id="repeatBtn" class="btn">é‡æ’­ (R)</button>
          <button id="giveUpBtn" class="btn">çœ‹ç­”æ¡ˆ</button>
          <button id="nextBtn" class="btn">ä¸‹ä¸€é¡Œ (N)</button>
        </div>
      </section>

      <section class="panel">
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div>
            <div style="font-size:13px;color:#9ca3af">ç›®å‰é¡Œç›®</div>
            <div id="questionLabel" style="font-size:20px;font-weight:700">â€”</div>
          </div>
          <div class="score">
            <div>âœ… <span id="correctCount">0</span></div>
            <div>âŒ <span id="wrongCount">0</span></div>
            <div>ğŸ¯ <span id="streak">0</span></div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div id="answers" class="answers"></div>
        </div>

        <div class="kbd-wrap">
          <div class="hint">å¯ç›´æ¥é»æ“Šé‹¼ç´éµä½œç­”ï¼ˆå–®éŸ³æ¨¡å¼ï¼‰</div>
          <div id="piano" class="piano"></div>
          <div id="solfege" class="solfege">ç­”æ¡ˆï¼šâ€”</div>
          
          <div id="statusHints" style="display:none;margin-top:12px">
            <div class="status-hints-container">
              <div id="hintRef" class="status-hint inactive">å‚è€ƒéŸ³</div>
              <div id="arrow1" class="status-arrow">â†’</div>
              <div id="hintQuestion" class="status-hint inactive">é¢˜ç›®éŸ³</div>
              <div id="arrow2" class="status-arrow">â†’</div>
              <div id="hintAnswer" class="status-hint inactive">ç­”æ¡ˆéŸ³</div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ---------- Notes / MIDI ----------
    const PCN = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const SOLFEGE = ['Do','Di','Re','Ri','Mi','Fa','Fi','So','Si','La','Li','Ti'];
    const MIDI_C1 = 24, MIDI_C7 = 96;
    function midiToFreq(m){ return 440 * Math.pow(2,(m-69)/12); }
    function midiToName(m){ return PCN[m%12] + (Math.floor(m/12)-1); }
    // é»‘éµé¡¯ç¤ºå‡/é™é›™éŸ³åï¼Œä¾‹å¦‚ C#4/Db4
    function midiBlackLabel(m){
      const pc = m % 12;
      const octave = Math.floor(m/12) - 1;
      const sharp = PCN[pc] + octave;
      const FLAT = {1:'Db',3:'Eb',6:'Gb',8:'Ab',10:'Bb'};
      if (FLAT[pc]) return sharp + '\n' + FLAT[pc] + octave; // å…©è¡Œé¡¯ç¤ºï¼Œé¿å…æ“ å‡ºéµå¸½
      return sharp;
    }
    function nameRange(cStart){ return midiToName(cStart) + 'â€“' + midiToName(cStart+12); }
    function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
    function shuffle(a){ const x=a.slice(); for(let i=x.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]];} return x; }

    // ---------- Audio ----------
    let audioCtx, masterGain;
    let __activeNodes = [];
    function ensureAudio(){
      if(!audioCtx){
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        masterGain = audioCtx.createGain();
        masterGain.gain.value = Number(volumeEl.value || 0.25);
        masterGain.connect(audioCtx.destination);
      }
      if(audioCtx.state==='suspended') audioCtx.resume();
    }
    function stopAllSounds(){
      if (!__activeNodes.length) return;
      __activeNodes.forEach(n=>{ try{ n.stop(0); }catch(_){} try{ n.disconnect(); }catch(_){} });
      __activeNodes = [];
    }
    // å¼·åˆ¶åœæ­¢æ‰€æœ‰éŸ³é »ã€èªéŸ³å’Œå®šæ™‚å™¨
    function stopAllAudioAndSpeech(){
      // åœæ­¢æ‰€æœ‰éŸ³é »
      stopAllSounds();
      // åœæ­¢èªéŸ³åˆæˆ
      try {
        speechSynthesis.cancel();
      } catch(_) {}
      // æ¸…é™¤è‡ªå‹•å…¬å¸ƒç­”æ¡ˆçš„å®šæ™‚å™¨
      clearRevealTimer();
    }
    function playPianoTone(freq, dur=900, when=0){
      ensureAudio();
      const t0 = audioCtx.currentTime + when;
      const t1 = t0 + dur/1000;
      const releaseTail = 0.8; // å°¾éŸ³å»¶é•·ï¼ˆç§’ï¼‰- å¢åŠ è‡³0.8ç§’

      // Envelope (percussive)
      const eg = audioCtx.createGain();
      eg.gain.setValueAtTime(0.0001, t0);
      eg.gain.exponentialRampToValueAtTime(1.0, t0 + 0.008);
      // ä¸»è¦éŸ³é‡è¡°æ¸›åˆ°è¼ƒå°å€¼ï¼Œä¿ç•™å°¾éŸ³
      eg.gain.exponentialRampToValueAtTime(0.08, t1); // å¾0.02æé«˜åˆ°0.08ï¼Œè®“å°¾éŸ³æ›´æ˜é¡¯
      // å°¾éŸ³å†ç·©æ…¢æ·¡å‡º
      eg.gain.exponentialRampToValueAtTime(0.0001, t1 + releaseTail);

      // Gentle lowpass to soften highs
      const lp = audioCtx.createBiquadFilter();
      lp.type = 'lowpass';
      lp.frequency.setValueAtTime(Math.min(6000, freq * 12), t0);
      lp.Q.value = 0.8;
      eg.connect(lp).connect(masterGain);

      // å¢åŠ æ›´å¤šæ³›éŸ³ï¼Œä½¿éŸ³è‰²æ›´é£½æ»¿
      const partials = [
        { mult: 1.0, gain: 1.0, detune: -4 },      // åŸºéŸ³
        { mult: 2.0, gain: 0.35, detune: +3 },    // ç¬¬äºŒæ³›éŸ³ï¼ˆæé«˜å¢ç›Šï¼‰
        { mult: 3.0, gain: 0.22, detune: -1 },    // ç¬¬ä¸‰æ³›éŸ³ï¼ˆæé«˜å¢ç›Šï¼‰
        { mult: 4.0, gain: 0.12, detune: +2 },    // ç¬¬å››æ³›éŸ³ï¼ˆæ–°å¢ï¼‰
        { mult: 5.0, gain: 0.08, detune: -2 },    // ç¬¬äº”æ³›éŸ³ï¼ˆæ–°å¢ï¼‰
      ];
      partials.forEach(p => {
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(freq * p.mult, t0);
        try { osc.detune.setValueAtTime(p.detune, t0); } catch(_){ }
        g.gain.setValueAtTime(p.gain, t0);
        osc.connect(g).connect(eg);
        osc.start(t0);
        osc.stop(t1 + releaseTail + 0.01);
        __activeNodes.push(osc);
        osc.onended = () => {
          try { osc.disconnect(); } catch(_){ }
          __activeNodes = __activeNodes.filter(n => n !== osc);
        };
      });
    }

    function playTone(freq, dur=900, type='sine', fade=15, when=0){
      if (type === 'piano') return playPianoTone(freq, dur, when);
      ensureAudio();
      const t0 = audioCtx.currentTime + when, t1 = t0 + dur/1000;
      const o = audioCtx.createOscillator(), g = audioCtx.createGain();
      o.type = type; o.frequency.setValueAtTime(freq, t0);
      g.gain.setValueAtTime(0, t0); g.gain.linearRampToValueAtTime(1, t0+fade/1000);
      g.gain.setValueAtTime(1, t1-fade/1000); g.gain.linearRampToValueAtTime(0.0001, t1);
      o.connect(g).connect(masterGain);
      o.start(t0);
      o.stop(t1+0.02);
      __activeNodes.push(o);
      o.onended = () => {
        try { o.disconnect(); } catch(_){ }
        __activeNodes = __activeNodes.filter(n => n !== o);
      };
    }

    // ---------- Elements ----------
    const modeEl = document.getElementById('mode');
    const waveEl = document.getElementById('wave');
    const volumeEl = document.getElementById('volume');
    const noteScopeEl = document.getElementById('noteScope');
    const playBtn = document.getElementById('playBtn');
    const repeatBtn = document.getElementById('repeatBtn');
    const giveUpBtn = document.getElementById('giveUpBtn');
    const nextBtn = document.getElementById('nextBtn');
    const answersEl = document.getElementById('answers');
    const questionLabel = document.getElementById('questionLabel');
    const correctEl = document.getElementById('correctCount');
    const wrongEl = document.getElementById('wrongCount');
    const streakEl = document.getElementById('streak');
    const pianoEl = document.getElementById('piano');
    const solfegeEl = document.getElementById('solfege');
    const prevGroupBtn = document.getElementById('prevGroup');
    const nextGroupBtn = document.getElementById('nextGroup');
    const groupLabelEl = document.getElementById('groupLabel');
    const revealEl = document.getElementById('revealAfter');
    const statusHintsEl = document.getElementById('statusHints');
    const hintRefEl = document.getElementById('hintRef');
    const hintQuestionEl = document.getElementById('hintQuestion');
    const hintAnswerEl = document.getElementById('hintAnswer');
    const arrow1El = document.getElementById('arrow1');
    const arrow2El = document.getElementById('arrow2');

    // ---------- State ----------
    const state = {
      wave:'sine',
      score:{correct:0,wrong:0,streak:0},
      groupC:60, // C4
      current:null,
      noteScope:'all', // 'all' | 'white'
      revealSeconds:5 // 1 | 3 | 5 | 7ï¼ˆå–®éŸ³æ¨¡å¼å’ŒéŸ³ç¨‹æ¨¡å¼ç”¨ï¼‰
    };
    function currentLow(){ return state.groupC; }
    function currentHigh(){ return state.groupC + 12; } // å«ä¸Šç•Œ C

    // ---------- Piano ----------
    function buildPiano(){
      pianoEl.innerHTML = '';
      const whiteWrap = document.createElement('div');
      whiteWrap.className = 'white-keys';
      const whiteSteps = [0,2,4,5,7,9,11,12]; // C D E F G A B C
      const whiteMidis = whiteSteps.map(st => state.groupC + st);
      whiteMidis.forEach(m => {
        const wk = document.createElement('div');
        wk.className = 'white-key';
        wk.dataset.midi = String(m);
        wk.addEventListener('mousedown', ()=>playKey(m));
        wk.addEventListener('touchstart', (e)=>{e.preventDefault(); playKey(m);}, {passive:false});
        const lbl = document.createElement('div');
        lbl.className = 'key-label key-label--white';
        lbl.textContent = midiToName(m);
        wk.appendChild(lbl);
        whiteWrap.appendChild(wk);
      });
      pianoEl.appendChild(whiteWrap);

      const whiteWidth = 100 / whiteSteps.length; // 8
      [
        { st:1, afterWhiteIdx:0 }, // C#
        { st:3, afterWhiteIdx:1 }, // D#
        { st:6, afterWhiteIdx:3 }, // F#
        { st:8, afterWhiteIdx:4 }, // G#
        { st:10,afterWhiteIdx:5 }  // A#
      ].forEach(b=>{
        const m = state.groupC + b.st;
        const left = (b.afterWhiteIdx+1)*whiteWidth;
        const bk = document.createElement('div');
        bk.className = 'black-key';
        bk.dataset.midi = String(m);
        bk.style.left = left + '%';
        bk.style.width = (whiteWidth*0.6) + '%';
        bk.addEventListener('mousedown', ()=>playKey(m));
        bk.addEventListener('touchstart', (e)=>{e.preventDefault(); playKey(m);}, {passive:false});
        const lbl = document.createElement('div');
        lbl.className = 'key-label key-label--black';
        lbl.textContent = midiBlackLabel(m);
        bk.appendChild(lbl);
        pianoEl.appendChild(bk);
      });

      groupLabelEl.textContent = nameRange(state.groupC);
    }
    function highlightKeys(midis, ms){
      const set = new Set(midis.map(Number));
      const nodes = pianoEl.querySelectorAll('[data-midi]');
      nodes.forEach(n => { if(set.has(Number(n.dataset.midi))) n.classList.add('active'); });
      setTimeout(()=>nodes.forEach(n=>n.classList.remove('active')), ms);
    }
    // æ‰‹åŠ¨é«˜äº®é’¢ç´é”®ï¼ˆä¸è‡ªåŠ¨ç†„ç­ï¼‰
    function highlightKeysManual(midis){
      const set = new Set(midis.map(Number));
      const nodes = pianoEl.querySelectorAll('[data-midi]');
      nodes.forEach(n => { if(set.has(Number(n.dataset.midi))) n.classList.add('active'); });
    }
    // æ¸…é™¤æŒ‡å®šé’¢ç´é”®çš„é«˜äº®
    function clearKeysHighlight(midis){
      const set = new Set(midis.map(Number));
      const nodes = pianoEl.querySelectorAll('[data-midi]');
      nodes.forEach(n => { if(set.has(Number(n.dataset.midi))) n.classList.remove('active'); });
    }
    // ç­”æ¡ˆéŸ³ï¼šé‹¼ç´éµèˆ‡ã€Œç­”æ¡ˆéŸ³ã€æç¤ºå­—äº®èµ·
    function highlightAnswer(midi){
      const midis = Array.isArray(midi) ? midi : [midi];
      const set = new Set(midis.map(Number));
      const nodes = pianoEl.querySelectorAll('[data-midi]');
      nodes.forEach(n => { if(set.has(Number(n.dataset.midi))) n.classList.add('active'); });
      updateStatusHint(hintAnswerEl, true);
    }
    // ç­”æ¡ˆéŸ³ï¼šé‹¼ç´éµèˆ‡ã€Œç­”æ¡ˆéŸ³ã€æç¤ºå­—ä¸€èµ·ç†„æ»…
    function clearAnswerHighlight(midi){
      const midis = Array.isArray(midi) ? midi : [midi];
      const set = new Set(midis.map(Number));
      const nodes = pianoEl.querySelectorAll('[data-midi]');
      nodes.forEach(n => { if(set.has(Number(n.dataset.midi))) n.classList.remove('active'); });
      updateStatusHint(null, false);
    }
    // åªçœ‹ç­”æ¡ˆï¼šåªé«˜äº®é‹¼ç´éµï¼Œä¸æ’­æ”¾éŸ³é »ï¼Œä¸å½±éŸ¿å…¶ä»–åŠŸèƒ½
    function showAnswerOnly(){
      if(!state.current) return;
      const q = state.current;
      // ä¸æ¸…é™¤å®šæ™‚å™¨ï¼Œä¿æŒè‡ªå‹•å…¬å¸ƒç­”æ¡ˆåŠŸèƒ½æ­£å¸¸é‹ä½œ
      // ä¸æ”¹è®Šç‹€æ…‹æç¤ºï¼Œä¿æŒç•¶å‰ç‹€æ…‹
      
      if(q.type === 'note'){
        // å–®éŸ³æ¨¡å¼ï¼šåªé«˜äº®é‹¼ç´éµï¼Œä¸æ”¹è®Šç‹€æ…‹æç¤º
        const ansMidi = Number(q.answerKey);
        const midis = [ansMidi];
        const set = new Set(midis.map(Number));
        const nodes = pianoEl.querySelectorAll('[data-midi]');
        nodes.forEach(n => { if(set.has(Number(n.dataset.midi))) n.classList.add('active'); });
        solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+midiToName(ansMidi)+'</b>';
      } else if(q.type === 'interval_up' || q.type === 'interval_down'){
        // éŸ³ç¨‹è¾¨è­˜æ¨¡å¼ï¼šåªé«˜äº®é‹¼ç´éµï¼Œä¸æ”¹è®Šç‹€æ…‹æç¤º
        // éœ€è¦é«˜äº®å…©å€‹éŸ³ï¼šbaseMidiï¼ˆåŸºæº–éŸ³ï¼‰å’Œ ansMidiï¼ˆç›®æ¨™éŸ³ï¼‰
        const ansMidi = Number(q.answerKey);
        const baseMidi = Number(q.baseMidi);
        const intervalSteps = Number(q.intervalSteps);
        const midis = [baseMidi, ansMidi]; // é«˜äº®å…©å€‹éŸ³
        const set = new Set(midis.map(Number));
        const nodes = pianoEl.querySelectorAll('[data-midi]');
        nodes.forEach(n => { if(set.has(Number(n.dataset.midi))) n.classList.add('active'); });
        const answerText = formatIntervalAnswer(baseMidi, ansMidi, intervalSteps);
        solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+answerText+'</b>';
      } else {
        // å…¶ä»–æ¨¡å¼ï¼ˆå’Œè²éŸ³ç¨‹ã€å’Œå¼¦ï¼‰ç›´æ¥æäº¤ç­”æ¡ˆ
        submitAnswer(q.answerKey);
      }
    }
    function solfegeTextForMidi(midi){
      const pc = Number(midi) % 12;
      const map = ['do','å‡do','re','å‡re','mi','fa','å‡fa','so','å‡so','la','é™si','si'];
      return map[pc];
    }
    // æ ¼å¼åŒ–éŸ³ç¨‹ç­”æ¡ˆæ˜¾ç¤ºï¼šä¾‹å¦‚ "C4 to B4 å¤§ä¸ƒåº¦"
    function formatIntervalAnswer(baseMidi, targetMidi, intervalSteps){
      const baseName = midiToName(baseMidi);
      const targetName = midiToName(targetMidi);
      const interval = INTERVALS.find(i => i.st === intervalSteps);
      const intervalLabel = interval ? interval.label : '';
      return `${baseName} to ${targetName} ${intervalLabel}`;
    }
    function playKey(midi){
      playTone(midiToFreq(midi), 900, state.wave);
      highlightKeys([midi], 900);
      // å–®éŸ³æ¨¡å¼é¡¯ç¤ºéŸ³åï¼ŒéŸ³ç¨‹æ¨¡å¼é¡¯ç¤ºå”±å
      if (state.current && state.current.type === 'note') {
        solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+midiToName(midi)+'</b>';
      } else {
        solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+solfegeTextForMidi(midi)+'</b>';
      }
      // å–®éŸ³æ¨¡å¼ï¼šé»éµå³ä½œç­”ï¼ˆå…è¨±å¤šæ¬¡å˜—è©¦ï¼‰
      if (state.current && state.current.type === 'note') {
        submitAnswer(midi);
      }
      // éŸ³ç¨‹è¾¨è­˜ï¼ˆä¸Šè¡Œ/ä¸‹è¡Œï¼‰ï¼šé»éµå³ä½œç­”
      if (state.current && (state.current.type === 'interval_up' || state.current.type === 'interval_down')) {
        submitAnswer(midi);
      }
    }
    // ---------- Status Hints ----------
    function updateStatusHint(hintEl, isActive){
      // é‡ç½®æ‰€æœ‰æç¤ºå­—å’Œç®­å¤´
      hintRefEl.classList.remove('active', 'inactive');
      hintQuestionEl.classList.remove('active', 'inactive');
      hintAnswerEl.classList.remove('active', 'inactive');
      arrow1El.classList.remove('active');
      arrow2El.classList.remove('active');
      
      // è®¾ç½®æ‰€æœ‰æç¤ºå­—ä¸ºæœªæ¿€æ´»çŠ¶æ€
      hintRefEl.classList.add('inactive');
      hintQuestionEl.classList.add('inactive');
      hintAnswerEl.classList.add('inactive');
      
      if(hintEl && isActive){
        hintEl.classList.remove('inactive');
        hintEl.classList.add('active');
        
        // æ ¹æ®æ¿€æ´»çš„æç¤ºå­—ï¼Œé«˜äº®ç›¸åº”çš„ç®­å¤´
        if(hintEl === hintRefEl){
          // å‚è€ƒéŸ³æ¿€æ´»æ—¶ï¼Œç®­å¤´ä¸æ¿€æ´»
        } else if(hintEl === hintQuestionEl){
          // é¢˜ç›®éŸ³æ¿€æ´»æ—¶ï¼Œç®­å¤´1æ¿€æ´»ï¼ˆä»å‚è€ƒéŸ³åˆ°é¢˜ç›®éŸ³ï¼‰
          arrow1El.classList.add('active');
        } else if(hintEl === hintAnswerEl){
          // ç­”æ¡ˆéŸ³æ¿€æ´»æ—¶ï¼Œç®­å¤´2æ¿€æ´»ï¼ˆä»é¢˜ç›®éŸ³åˆ°ç­”æ¡ˆéŸ³ï¼‰
          arrow2El.classList.add('active');
        }
      }
    }
    function showStatusHints(show){
      if(show){
        statusHintsEl.style.display = 'block';
      } else {
        statusHintsEl.style.display = 'none';
        updateStatusHint(null, false);
      }
    }

    // ---------- Questions ----------
    function isBlackPC(pc){ return pc===1||pc===3||pc===6||pc===8||pc===10; }
    function randomMidiInGroup(){
      const low=currentLow(), high=currentHigh();
      if (state.noteScope === 'white') {
        const whites=[]; for(let m=low;m<=high;m++){ if(!isBlackPC(m%12)) whites.push(m); }
        return whites[Math.floor(Math.random()*whites.length)];
      }
      return randInt(low, high);
    }

    // å–®éŸ³ï¼šå…ˆæ’­ 3 æ¬¡ Cï¼Œå†æ’­é¡Œç›®éŸ³ï¼›æ’­æ”¾æ™‚ä¸äº®éµ
    function genNoteQuestion(){
      const ans = randomMidiInGroup();
      function play(){
        ensureAudio();
        const ref = currentLow();       // è©²çµ„ C
        const refDur = 600, refGap = 0.15;
        const questionDur = 1000; // é¢˜ç›®éŸ³æ’­æ”¾æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
        
        // æ˜¾ç¤ºå‚è€ƒéŸ³æç¤º
        updateStatusHint(hintRefEl, true);
        
        for (let i=0;i<3;i++){
          const when = i*(refDur/1000 + refGap);
          playTone(midiToFreq(ref), refDur, state.wave, 10, when);
        }
        
        // è®¡ç®—é¢˜ç›®éŸ³å¼€å§‹æ’­æ”¾çš„æ—¶é—´ï¼ˆç§’ï¼‰
        const qWhen = 3*(refDur/1000 + refGap);
        const qWhenMs = qWhen * 1000;
        
        // åœ¨é¢˜ç›®éŸ³æ’­æ”¾æ—¶ï¼Œåˆ‡æ¢æç¤ºå­—
        setTimeout(() => {
          updateStatusHint(hintQuestionEl, true);
        }, qWhenMs);
        
        playTone(midiToFreq(ans), questionDur, state.wave, 15, qWhen);
        solfegeEl.innerHTML = 'ç­”æ¡ˆï¼šâ€”';
        
        // è¿”å›é¢˜ç›®éŸ³æ’­æ”¾å®Œæˆçš„æ—¶é—´ï¼ˆç›¸å¯¹äº audioCtx.currentTimeï¼‰
        const questionEndTime = qWhen + questionDur / 1000;
        return questionEndTime;
      }
      return {
        type:'note',
        label:'å–®éŸ³ï¼šå…ˆè½ 3 æ¬¡ C åŸºæº–éŸ³ï¼Œä¹‹å¾Œè«‹åœ¨é‹¼ç´ä¸Šé»é¸ç­”æ¡ˆ',
        answerKey:ans,
        options:[],
        play
      };
    }

    const INTERVALS = [
      { st:1, label:'å°äºŒåº¦' },{ st:2, label:'å¤§äºŒåº¦' },{ st:3, label:'å°ä¸‰åº¦' },{ st:4, label:'å¤§ä¸‰åº¦' },
      { st:5, label:'å®Œå…¨å››åº¦' },{ st:6, label:'ä¸‰å…¨éŸ³' },{ st:7, label:'å®Œå…¨äº”åº¦' },{ st:8, label:'å°å…­åº¦' },
      { st:9, label:'å¤§å…­åº¦' },{ st:10,label:'å°ä¸ƒåº¦' },{ st:11,label:'å¤§ä¸ƒåº¦' },{ st:12,label:'å…«åº¦' },
    ];
    const TRIADS = [
      { q:'maj', label:'å¤§ä¸‰å’Œå¼¦', steps:[0,4,7] },
      { q:'min', label:'å°ä¸‰å’Œå¼¦', steps:[0,3,7] },
      { q:'dim', label:'æ¸›ä¸‰å’Œå¼¦', steps:[0,3,6] },
      { q:'aug', label:'å¢ä¸‰å’Œå¼¦', steps:[0,4,8] },
    ];
    const SEVENTHS = [
      { q:'maj7', label:'å¤§ä¸ƒå’Œå¼¦ (maj7)', steps:[0,4,7,11] },
      { q:'7',    label:'å±¬ä¸ƒå’Œå¼¦ (7)',     steps:[0,4,7,10] },
      { q:'min7', label:'å°ä¸ƒå’Œå¼¦ (min7)',  steps:[0,3,7,10] },
      { q:'m7b5', label:'åŠæ¸›ä¸ƒ (m7â™­5)',    steps:[0,3,6,10] },
      { q:'dim7', label:'æ¸›ä¸ƒ (dim7)',       steps:[0,3,6,9]  },
    ];

    function genInterval(kind){
      const intv = shuffle(INTERVALS)[0];
      const low=currentLow(), high=currentHigh();
      let base, other;
      if(kind==='up'){
        // ä¸Šè¡Œï¼šbaseæ˜¯ä½éŸ³ï¼Œotheræ˜¯é«˜éŸ³ï¼ˆbase + intv.stï¼‰
        base = randInt(low, Math.max(low, high-intv.st));
        other = base + intv.st;
        // ç¢ºä¿ other ç¢ºå¯¦æ¯” base é«˜
        if(other <= base) other = base + intv.st;
      } else if(kind==='down'){
        // ä¸‹è¡Œï¼šbaseæ˜¯é«˜éŸ³ï¼Œotheræ˜¯ä½éŸ³ï¼ˆbase - intv.stï¼‰
        base = randInt(Math.min(high, low+intv.st), high);
        other = base - intv.st;
        // ç¢ºä¿ other ç¢ºå¯¦æ¯” base ä½
        if(other >= base) other = base - intv.st;
      } else {
        base = randInt(low, Math.max(low, high-intv.st));
        other = base + intv.st;
      }

      // å’Œè²éŸ³ç¨‹æ¨¡å¼ä¿æŒåŸä¾†çš„é¸é …æŒ‰éˆ•æ–¹å¼
      if(kind==='harm'){
        const label = 'è«‹è¾¨è­˜éŸ³ç¨‹ï¼ˆå’Œè²/åŒæ™‚ï¼‰';
        const answerKey = String(intv.st);
        const opts = shuffle(INTERVALS).slice(0,6).map(i=>({key:String(i.st), text:i.label}));
        if(!opts.find(o=>o.key===answerKey)) opts[0]={key:answerKey, text:intv.label};
        const options = shuffle(opts);

        function play(){
          const bf=midiToFreq(base), of=midiToFreq(other);
          playTone(bf,1100,state.wave,15,0);
          playTone(of,1100,state.wave,15,0);
          highlightKeys([base,other],1100);
          return 1.1; // è¿”å›æ’­æ”¾æ—¶é•¿ï¼ˆç§’ï¼‰ï¼Œè™½ç„¶æ­¤æ¨¡å¼ä¸ä½¿ç”¨è‡ªåŠ¨å…¬å¸ƒç­”æ¡ˆ
        }
        return { type:'interval_harm', label, answerKey, options, play };
      }

      // ä¸Šè¡Œ/ä¸‹è¡Œæ¨¡å¼ï¼šä½¿ç”¨å¾ªç’°æ’­æ”¾å’Œé‹¼ç´éµç›¤ä½œç­”
      const label = kind==='up'?'éŸ³ç¨‹è¾¨è­˜ï¼ˆä¸Šè¡Œï¼‰ï¼šå…ˆè½ 3 æ¬¡åŸºæº–éŸ³ï¼Œä¹‹å¾Œè«‹åœ¨é‹¼ç´ä¸Šé»é¸ç›®æ¨™éŸ³':kind==='down'?'éŸ³ç¨‹è¾¨è­˜ï¼ˆä¸‹è¡Œï¼‰ï¼šå…ˆè½ 3 æ¬¡åŸºæº–éŸ³ï¼Œä¹‹å¾Œè«‹åœ¨é‹¼ç´ä¸Šé»é¸ç›®æ¨™éŸ³':'è«‹è¾¨è­˜éŸ³ç¨‹ï¼ˆå’Œè²/åŒæ™‚ï¼‰';
      
      // å°æ–¼ä¸Šè¡Œï¼šbaseæ˜¯ä½éŸ³ï¼Œotheræ˜¯é«˜éŸ³ï¼ˆbase + intv.stï¼‰
      // å°æ–¼ä¸‹è¡Œï¼šbaseæ˜¯é«˜éŸ³ï¼Œotheræ˜¯ä½éŸ³ï¼ˆbase - intv.stï¼‰
      // ä½†ç‚ºäº†è®“æ’­æ”¾é †åºæ›´æ¸…æ™°ï¼Œæˆ‘å€‘éœ€è¦ç¢ºä¿ï¼š
      // ä¸Šè¡Œï¼šå…ˆæ’­æ”¾ä½éŸ³ï¼ˆbaseï¼‰ï¼Œå†æ’­æ”¾é«˜éŸ³ï¼ˆotherï¼‰
      // ä¸‹è¡Œï¼šå…ˆæ’­æ”¾é«˜éŸ³ï¼ˆbaseï¼‰ï¼Œå†æ’­æ”¾ä½éŸ³ï¼ˆotherï¼‰
      
      // ä¿å­˜åŸºæº–éŸ³ã€ç›®æ¨™éŸ³å’ŒéŸ³ç¨‹æ­¥æ•¸
      const answerKey = other; // ç›®æ¨™éŸ³çš„MIDIå€¼
      const baseMidi = base;
      const intervalSteps = intv.st; // æ­£ç¢ºçš„éŸ³ç¨‹æ­¥æ•¸

      function play(){
        ensureAudio();
        const refDur = 600, refGap = 0.15;
        const refMidi = currentLow(); // åƒè€ƒéŸ³æ°¸é æ˜¯ C
        const firstNoteDur = 600; // ç¬¬ä¸€ä¸ªéŸ³æ’­æ”¾æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
        const secondNoteDur = 1000; // ç¬¬äºŒä¸ªéŸ³æ’­æ”¾æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
        const gapBetweenNotes = 0.7; // ä¸¤ä¸ªéŸ³ä¹‹é—´çš„é—´éš”ï¼ˆç§’ï¼‰
        
        // æ˜¾ç¤ºå‚è€ƒéŸ³æç¤º
        updateStatusHint(hintRefEl, true);
        
        // å…ˆæ’­æ”¾åƒè€ƒéŸ³ C 3æ¬¡ï¼ˆå¾ªç’°æ’­æ”¾ï¼‰
        for (let i=0;i<3;i++){
          const when = i*(refDur/1000 + refGap);
          playTone(midiToFreq(refMidi), refDur, state.wave, 10, when);
        }
        
        // è®¡ç®—é¢˜ç›®éŸ³å¼€å§‹æ’­æ”¾çš„æ—¶é—´ï¼ˆç§’ï¼‰
        // åœ¨3æ¬¡åƒè€ƒéŸ³æ’­æ”¾å®Œå¾Œï¼Œç¨ç­‰ç‰‡åˆ»å†æ’­æ”¾é¡Œç›®éŸ³ï¼Œé¿å…éŸ³é »é‡ç–Š
        const gapAfterRef = 0.2; // åƒè€ƒéŸ³å’Œé¡Œç›®éŸ³ä¹‹é–“çš„é–“éš”
        const qWhen = 3*(refDur/1000 + refGap) + gapAfterRef;
        const qWhenMs = qWhen * 1000;
        
        // åœ¨é¢˜ç›®éŸ³æ’­æ”¾æ—¶ï¼Œåˆ‡æ¢æç¤ºå­—
        setTimeout(() => {
          updateStatusHint(hintQuestionEl, true);
        }, qWhenMs);
        
        // æ’­æ”¾é¡Œç›®éŸ³ï¼šå…ˆæ’­æ”¾é¡Œç›®éŸ³çš„ç¬¬ä¸€å€‹éŸ³ï¼ˆbaseï¼‰ï¼Œå†æ’­æ”¾é¡Œç›®éŸ³çš„ç¬¬äºŒå€‹éŸ³ï¼ˆotherï¼‰
        // ä¸Šè¡Œï¼šbaseï¼ˆä½ï¼‰â†’ otherï¼ˆé«˜ï¼‰ï¼›ä¸‹è¡Œï¼šbaseï¼ˆé«˜ï¼‰â†’ otherï¼ˆä½ï¼‰
        // æ’­æ”¾é¡Œç›®éŸ³æ™‚ä¸äº®é‹¼ç´éµï¼Œåªæœ‰åœ¨æ’­æ”¾ç­”æ¡ˆéŸ³æ™‚æ‰äº®
        playTone(midiToFreq(base), firstNoteDur, state.wave, 15, qWhen);
        playTone(midiToFreq(other), secondNoteDur, state.wave, 15, qWhen + gapBetweenNotes);
        solfegeEl.innerHTML = 'ç­”æ¡ˆï¼šâ€”';
        
        // è¿”å›é¢˜ç›®éŸ³æ’­æ”¾å®Œæˆçš„æ—¶é—´ï¼ˆç›¸å¯¹äº audioCtx.currentTimeï¼‰
        // ç¬¬äºŒä¸ªéŸ³å¼€å§‹æ—¶é—´ + ç¬¬äºŒä¸ªéŸ³æ’­æ”¾æ—¶é•¿
        const questionEndTime = qWhen + gapBetweenNotes + secondNoteDur / 1000;
        return questionEndTime;
      }
      return { 
        type:'interval_'+kind, 
        label, 
        answerKey:answerKey, // ç›®æ¨™éŸ³MIDIå€¼
        baseMidi:baseMidi, // åŸºæº–éŸ³MIDIå€¼
        intervalSteps:intervalSteps, // æ­£ç¢ºéŸ³ç¨‹æ­¥æ•¸
        options:[], 
        play 
      };
    }
    function chooseRoot(steps){
      const low=currentLow(), high=currentHigh();
      return randInt(low, Math.max(low, high - Math.max(...steps)));
    }
    function genTriad(){ const t=shuffle(TRIADS)[0]; const r=chooseRoot(t.steps); const tones=t.steps.map(s=>r+s); const freqs=tones.map(midiToFreq);
      const options = shuffle(TRIADS).map(x=>({key:x.q, text:x.label}));
      function play(){ freqs.forEach(f=>playTone(f,1100,state.wave,15,0)); highlightKeys(tones,1100); }
      return { type:'triad', label:'è«‹è¾¨è­˜å’Œå¼¦ï¼ˆä¸‰å’Œå¼¦ï¼‰', answerKey:t.q, options, play };
    }
    function genSeventh(){ const s=shuffle(SEVENTHS)[0]; const r=chooseRoot(s.steps); const tones=s.steps.map(x=>r+x); const freqs=tones.map(midiToFreq);
      const options = shuffle(SEVENTHS).map(x=>({key:x.q, text:x.label}));
      function play(){ freqs.forEach(f=>playTone(f,1200,state.wave,15,0)); highlightKeys(tones,1200); }
      return { type:'seventh', label:'è«‹è¾¨è­˜å’Œå¼¦ï¼ˆä¸ƒå’Œå¼¦ï¼‰', answerKey:s.q, options, play };
    }

    // ---------- Flow ----------
    function renderAnswers(q){
      answersEl.innerHTML='';
      if (q.type === 'note') {
        const tip = document.createElement('div');
        tip.className = 'hint';
        tip.textContent = 'è«‹ç›´æ¥åœ¨ä¸‹æ–¹é‹¼ç´ä¸Šé»é¸ä½ è½åˆ°çš„éŸ³é«˜';
        answersEl.appendChild(tip);
        return;
      }
      // éŸ³ç¨‹è¾¨è­˜ï¼ˆä¸Šè¡Œ/ä¸‹è¡Œï¼‰ä¹Ÿç”¨é‹¼ç´éµç›¤ä½œç­”
      if (q.type === 'interval_up' || q.type === 'interval_down') {
        const tip = document.createElement('div');
        tip.className = 'hint';
        tip.textContent = 'è«‹ç›´æ¥åœ¨ä¸‹æ–¹é‹¼ç´ä¸Šé»é¸ä½ è½åˆ°çš„ç›®æ¨™éŸ³';
        answersEl.appendChild(tip);
        return;
      }
      // å…¶ä»–æ¨¡å¼ï¼ˆå’Œè²éŸ³ç¨‹ã€å’Œå¼¦ï¼‰ä»ç”¨é¸é …æŒ‰éˆ•
      q.options.forEach(opt=>{
        const b=document.createElement('button');
        b.className='answer-btn';
        b.textContent=opt.text;
        b.addEventListener('click',()=>submitAnswer(opt.key));
        answersEl.appendChild(b);
      });
    }
    // ---------- Auto reveal (å–®éŸ³) ----------
    let __revealTimerId = null;
    // ç¡®ä¿è¯­éŸ³åˆ—è¡¨å·²åŠ è½½
    function ensureVoicesLoaded(callback){
      const voices = speechSynthesis.getVoices();
      if(voices.length > 0){
        callback();
      } else {
        // å¦‚æœè¯­éŸ³åˆ—è¡¨æœªåŠ è½½ï¼Œç­‰å¾…åŠ è½½å®Œæˆ
        speechSynthesis.onvoiceschanged = () => {
          speechSynthesis.onvoiceschanged = null;
          callback();
        };
      }
    }
    
    function speakText(text, onEnd){
      try {
        ensureVoicesLoaded(() => {
          const u = new SpeechSynthesisUtterance(String(text));
          u.lang = 'en-US';
          
          // ä¼˜åŒ–è¯­éŸ³å‚æ•°ï¼Œä½¿å…¶æ›´é¥±æ»¡ã€æ›´äººæ€§åŒ–
          u.rate = 0.85;  // è¯­é€Ÿç¨æ…¢ï¼Œæ›´æ¸…æ™°ï¼ˆé»˜è®¤1.0ï¼ŒèŒƒå›´0.1-10ï¼‰
          u.pitch = 1.1;  // éŸ³è°ƒç¨é«˜ï¼Œæ›´ç”ŸåŠ¨ï¼ˆé»˜è®¤1.0ï¼ŒèŒƒå›´0-2ï¼‰
          u.volume = 1.0; // éŸ³é‡æœ€å¤§ï¼ˆé»˜è®¤1.0ï¼ŒèŒƒå›´0-1ï¼‰
          
          // å°è¯•é€‰æ‹©æ›´è‡ªç„¶çš„è¯­éŸ³
          const voices = speechSynthesis.getVoices();
          // ä¼˜å…ˆé€‰æ‹©æ›´è‡ªç„¶çš„è¯­éŸ³ï¼ˆé€šå¸¸åç§°åŒ…å« "Natural" æˆ– "Neural"ï¼‰
          const preferredVoices = voices.filter(v => 
            v.lang.startsWith('en') && (
              v.name.toLowerCase().includes('natural') ||
              v.name.toLowerCase().includes('neural') ||
              v.name.toLowerCase().includes('premium') ||
              v.name.toLowerCase().includes('enhanced')
            )
          );
          if(preferredVoices.length > 0){
            u.voice = preferredVoices[0];
          } else {
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¼˜å…ˆè¯­éŸ³ï¼Œé€‰æ‹©è´¨é‡è¾ƒå¥½çš„è‹±æ–‡è¯­éŸ³
            const englishVoices = voices.filter(v => v.lang.startsWith('en-US'));
            if(englishVoices.length > 0){
              // ä¼˜å…ˆé€‰æ‹©éç³»ç»Ÿé»˜è®¤çš„è¯­éŸ³ï¼ˆé€šå¸¸è´¨é‡æ›´å¥½ï¼‰
              const nonDefaultVoice = englishVoices.find(v => !v.name.toLowerCase().includes('sapi')) || englishVoices[0];
              u.voice = nonDefaultVoice;
            }
          }
          
          if (typeof onEnd === 'function') {
            u.onend = () => { try { onEnd(); } catch(_) {} };
          }
          speechSynthesis.cancel();
          speechSynthesis.speak(u);
        });
      } catch(_) {}
    }
    function englishNoteNameForMidi(midi){
      const pc = Number(midi) % 12;
      const octave = Math.floor(Number(midi) / 12) - 1; // è·å–ç»„å·ï¼ˆå…«åº¦ï¼‰
      const FLAT_MAP = {1:'Db',3:'Eb',6:'Gb',8:'Ab',10:'Bb'};
      const sharpName = PCN[pc];
      let text = sharpName.replace('#', '-Sharp');
      // æ·»åŠ ç»„å·æ•°å­—ï¼Œç”¨è‹±æ–‡å•è¯è¡¨ç¤ºä»¥ä¾¿è¯­éŸ³åˆæˆ
      const numberWords = ['zero', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine'];
      const octaveWord = octave >= 0 && octave < 10 ? numberWords[octave] : String(octave);
      text += ' ' + octaveWord;
      
      if(FLAT_MAP[pc]){
        const flatName = FLAT_MAP[pc];
        text += ', ' + flatName.replace('b', '-flat') + ' ' + octaveWord;
      }
      return text;
    }
    // ç”ŸæˆéŸ³ç¨‹èªéŸ³æ–‡æœ¬ï¼Œä¾‹å¦‚ "C to B, major seventh"
    function intervalSpeechText(baseMidi, targetMidi, intervalSteps){
      // ç²å–åŸºæº–éŸ³å’Œç›®æ¨™éŸ³çš„è‹±æ–‡åç¨±ï¼ˆç”¨æ–¼èªéŸ³ï¼‰
      // ä½¿ç”¨ englishNoteNameForMidi ä½†åªå–ç¬¬ä¸€å€‹åç¨±ï¼ˆä¸»è¦åç¨±ï¼‰
      const baseFullName = englishNoteNameForMidi(baseMidi);
      const targetFullName = englishNoteNameForMidi(targetMidi);
      // åªå–ç¬¬ä¸€å€‹åç¨±ï¼ˆä¸»è¦åç¨±ï¼‰ï¼Œå»æ‰é€—è™Ÿå¾Œçš„éƒ¨åˆ†
      const baseName = baseFullName.split(',')[0].trim();
      const targetName = targetFullName.split(',')[0].trim();
      
      // ç²å–éŸ³ç¨‹åº¦æ•¸çš„è‹±æ–‡åç¨±
      const interval = INTERVALS.find(i => i.st === intervalSteps);
      let intervalName = '';
      if(interval){
        // å°‡ä¸­æ–‡éŸ³ç¨‹åç¨±è½‰æ›ç‚ºè‹±æ–‡
        const intervalMap = {
          'å°äºŒåº¦': 'minor second',
          'å¤§äºŒåº¦': 'major second',
          'å°ä¸‰åº¦': 'minor third',
          'å¤§ä¸‰åº¦': 'major third',
          'å®Œå…¨å››åº¦': 'perfect fourth',
          'ä¸‰å…¨éŸ³': 'tritone',
          'å®Œå…¨äº”åº¦': 'perfect fifth',
          'å°å…­åº¦': 'minor sixth',
          'å¤§å…­åº¦': 'major sixth',
          'å°ä¸ƒåº¦': 'minor seventh',
          'å¤§ä¸ƒåº¦': 'major seventh',
          'å…«åº¦': 'octave'
        };
        intervalName = intervalMap[interval.label] || interval.label;
      }
      
      return `${baseName} to ${targetName}, ${intervalName}`;
    }
    function clearRevealTimer(){
      if(__revealTimerId){ clearTimeout(__revealTimerId); __revealTimerId=null; }
    }
    function scheduleReveal(questionEndTime){
      clearRevealTimer();
      if(!state.current || (state.current.type !== 'note' && state.current.type !== 'interval_up' && state.current.type !== 'interval_down')) return;
      const sec = Number(state.revealSeconds||0);
      if(!sec || Number.isNaN(sec)) return;
      
      // å¦‚æœæä¾›äº†é¢˜ç›®éŸ³æ’­æ”¾å®Œæˆçš„æ—¶é—´ï¼Œä»é‚£ä¸ªæ—¶é—´ç‚¹å¼€å§‹è®¡æ—¶
      // å¦åˆ™ä»å½“å‰æ—¶é—´å¼€å§‹è®¡æ—¶ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
      let delayMs = sec * 1000;
      if(questionEndTime !== undefined && questionEndTime !== null){
        ensureAudio();
        const currentTime = audioCtx.currentTime;
        const elapsed = currentTime - questionEndTime;
        // å¦‚æœé¢˜ç›®éŸ³å·²ç»æ’­æ”¾å®Œæˆï¼Œç«‹å³å¼€å§‹è®¡æ—¶
        // å¦‚æœé¢˜ç›®éŸ³è¿˜åœ¨æ’­æ”¾ï¼Œç­‰å¾…æ’­æ”¾å®Œæˆåå†è®¡æ—¶
        if(elapsed >= 0){
          // é¢˜ç›®éŸ³å·²ç»æ’­æ”¾å®Œæˆï¼Œä»å½“å‰æ—¶é—´å¼€å§‹è®¡æ—¶
          delayMs = sec * 1000;
        } else {
          // é¢˜ç›®éŸ³è¿˜åœ¨æ’­æ”¾ï¼Œç­‰å¾…æ’­æ”¾å®Œæˆåå†è®¡æ—¶
          delayMs = (-elapsed * 1000) + (sec * 1000);
        }
      }
      
      __revealTimerId = setTimeout(()=>{
        if(!state.current || state.current.__answered) return;
        const ansMidi = Number(state.current.answerKey);
        
        // æ’­æ”¾ç­”æ¡ˆéŸ³ç¬¦
        if(state.current.type === 'note'){
          // å–®éŸ³æ¨¡å¼ï¼šåªæ’­æ”¾ç›®æ¨™éŸ³
          // æ¿€æ´»ç­”æ¡ˆéŸ³çŠ¶æ€æç¤º
          highlightAnswer(ansMidi);
          
          const answerFreq = midiToFreq(ansMidi);
          playTone(answerFreq, 1000, state.wave, 15, 0);
          // æ’­æ”¾ç­”æ¡ˆéŸ³æ™‚æ‰é¡¯ç¤ºã€Œç­”æ¡ˆï¼šã€ä½¿ç”¨éŸ³å
          solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+midiToName(ansMidi)+'</b>';
          
          // ç­‰éŸ³ç¬¦æ’­æ”¾å®Œæˆå¾Œå†å¿µèªéŸ³
          setTimeout(() => {
            const engName = englishNoteNameForMidi(ansMidi);
            speakText(engName, () => {
              // èªéŸ³æ’­ç•¢å¾Œï¼Œå…ˆè®“ç­”æ¡ˆç‡ˆè™Ÿä¸€èµ·ç†„æ»…ï¼Œå†ç¨ç­‰å‡ºä¸‹ä¸€é¡Œ
              clearAnswerHighlight(ansMidi);
              setTimeout(()=>{ newQuestion(); }, 600);
            });
          }, 1000); // ç­‰å¾…éŸ³ç¬¦æ’­æ”¾å®Œæˆï¼ˆ1000msï¼‰
        } else if(state.current.type === 'interval_up' || state.current.type === 'interval_down'){
          // éŸ³ç¨‹è¾¨è­˜ï¼šæ’­æ”¾é¡Œç›®éŸ³ï¼ˆé¡Œç›®éŸ³çš„ç¬¬ä¸€å€‹éŸ³+ç¬¬äºŒå€‹éŸ³ï¼‰
          const baseMidi = Number(state.current.baseMidi); // é¡Œç›®éŸ³çš„ç¬¬ä¸€å€‹éŸ³
          const intervalSteps = Number(state.current.intervalSteps);
          
          // æ¿€æ´»ç­”æ¡ˆéŸ³çŠ¶æ€æç¤º
          updateStatusHint(hintAnswerEl, true);
          
          if(state.current.type === 'interval_up'){
            // ä¸Šè¡Œï¼šbaseï¼ˆä½ï¼‰â†’ ansMidiï¼ˆé«˜ï¼‰
            // ä¸éŸ³é¢‘åŒæ­¥é«˜äº®ï¼šå…ˆé«˜äº®ç¬¬ä¸€ä¸ªéŸ³ï¼Œå†é«˜äº®ç¬¬äºŒä¸ªéŸ³ï¼Œä¿æŒé«˜äº®ç›´åˆ°è¯­éŸ³æ’­æ”¾å®Œæˆ
            playTone(midiToFreq(baseMidi), 600, state.wave, 15, 0);
            highlightKeysManual([baseMidi]);
            
            playTone(midiToFreq(ansMidi), 1000, state.wave, 15, 0.7);
            setTimeout(()=>highlightKeysManual([ansMidi]), 700);
            
            // æ’­æ”¾ç­”æ¡ˆéŸ³æ™‚æ‰é¡¯ç¤ºã€Œç­”æ¡ˆï¼šã€æ ¼å¼ç‚ºé¡Œç›®éŸ³çš„éŸ³ç¨‹ï¼Œä¾‹å¦‚ "A4 to B4 å¤§äºŒåº¦"
            const answerText = formatIntervalAnswer(baseMidi, ansMidi, intervalSteps);
            solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+answerText+'</b>';
          } else {
            // ä¸‹è¡Œï¼šbaseï¼ˆé«˜ï¼‰â†’ ansMidiï¼ˆä½ï¼‰
            // ä¸éŸ³é¢‘åŒæ­¥é«˜äº®ï¼šå…ˆé«˜äº®ç¬¬ä¸€ä¸ªéŸ³ï¼Œå†é«˜äº®ç¬¬äºŒä¸ªéŸ³ï¼Œä¿æŒé«˜äº®ç›´åˆ°è¯­éŸ³æ’­æ”¾å®Œæˆ
            playTone(midiToFreq(baseMidi), 600, state.wave, 15, 0);
            highlightKeysManual([baseMidi]);
            
            playTone(midiToFreq(ansMidi), 1000, state.wave, 15, 0.7);
            setTimeout(()=>highlightKeysManual([ansMidi]), 700);
            
            // æ’­æ”¾ç­”æ¡ˆéŸ³æ™‚æ‰é¡¯ç¤ºã€Œç­”æ¡ˆï¼šã€æ ¼å¼ç‚ºé¡Œç›®éŸ³çš„éŸ³ç¨‹ï¼Œä¾‹å¦‚ "D4 to G4 å®Œå…¨å››åº¦"
            const answerText = formatIntervalAnswer(baseMidi, ansMidi, intervalSteps);
            solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+answerText+'</b>';
          }
          
          // ç­‰éŸ³ç¨‹æ’­æ”¾å®Œæˆå¾Œå†å¿µèªéŸ³ï¼ˆ600msåŸºæº–éŸ³ + 1000msç›®æ¨™éŸ³ + 100msé–“éš”ï¼‰
          setTimeout(() => {
            const speechText = intervalSpeechText(baseMidi, ansMidi, intervalSteps);
            speakText(speechText, () => {
              // èªéŸ³æ’­ç•¢å¾Œï¼Œå…ˆè®“ç­”æ¡ˆç‡ˆè™Ÿå’Œç‹€æ…‹æç¤ºä¸€èµ·ç†„æ»…ï¼Œå†ç¨ç­‰å‡ºä¸‹ä¸€é¡Œ
              clearKeysHighlight([baseMidi, ansMidi]);
              updateStatusHint(null, false);
              setTimeout(()=>{ newQuestion(); }, 600);
            });
          }, 1700); // ç­‰å¾…éŸ³ç¨‹æ’­æ”¾å®Œæˆï¼ˆ1700msï¼‰
        }
      }, delayMs);
    }
    function setQuestion(q){
      state.current=q;
      state.current.__answered=false;
      state.current.__countedWrong=false; // å–®éŸ³æ¨¡å¼ï¼šæœ¬é¡ŒéŒ¯èª¤åªè¨ˆä¸€æ¬¡
      questionLabel.textContent=q.label;
      renderAnswers(q);
      solfegeEl.innerHTML='ç­”æ¡ˆï¼šâ€”';
      clearRevealTimer();
      
      // æ¸…é™¤æ‰€æœ‰é‹¼ç´éµçš„é«˜äº®
      const nodes = pianoEl.querySelectorAll('[data-midi]');
      nodes.forEach(n => n.classList.remove('active'));
      
      // å–®éŸ³æ¨¡å¼å’ŒéŸ³ç¨‹è¾¨è­˜ï¼ˆä¸Šè¡Œ/ä¸‹è¡Œï¼‰æ˜¾ç¤ºæç¤ºå­—åŒºåŸŸ
      if(q.type === 'note' || q.type === 'interval_up' || q.type === 'interval_down'){
        showStatusHints(true);
        updateStatusHint(null, false); // åˆå§‹çŠ¶æ€ï¼šéƒ½ä¸äº®
      } else {
        showStatusHints(false);
      }
    }
    function newQuestion(){
      // å¼·åˆ¶åœæ­¢ä¸Šä¸€é¡Œå°šæœªçµæŸçš„è²éŸ³ã€èªéŸ³å’Œå®šæ™‚å™¨ï¼Œé¿å…éŸ³é »ç›¸æ’
      stopAllAudioAndSpeech();
      let q;
      const m=modeEl.value;
      if(m==='note') q=genNoteQuestion();
      else if(m==='interval_up') q=genInterval('up');
      else if(m==='interval_down') q=genInterval('down');
      else if(m==='interval_harm') q=genInterval('harm');
      else if(m==='triad') q=genTriad();
      else q=genSeventh();
      setQuestion(q);
      
      // è®°å½•æ’­æ”¾å¼€å§‹æ—¶é—´ï¼Œè®¡ç®—é¢˜ç›®éŸ³æ’­æ”¾å®Œæˆçš„ç»å¯¹æ—¶é—´
      ensureAudio();
      const playStartTime = audioCtx.currentTime;
      const questionEndTimeRelative = q.play();
      
      if(q.type==='note' || q.type==='interval_up' || q.type==='interval_down'){
        // è®¡ç®—é¢˜ç›®éŸ³æ’­æ”¾å®Œæˆçš„ç»å¯¹æ—¶é—´
        const questionEndTimeAbsolute = playStartTime + questionEndTimeRelative;
        scheduleReveal(questionEndTimeAbsolute);
      }
    }

    function submitAnswer(chosen){
      const q=state.current; if(!q) return;
      clearRevealTimer();
      let ok=false;
      if(q.type==='note'){ 
        ok=Number(chosen)===Number(q.answerKey); 
      } else if(q.type==='interval_up' || q.type==='interval_down'){
        // éŸ³ç¨‹è¾¨è­˜ï¼šé»æ“Šçš„éŸ³æ‡‰è©²ç­‰æ–¼æ­£ç¢ºçš„ç›®æ¨™éŸ³
        const clickedMidi = Number(chosen);
        ok = clickedMidi === Number(q.answerKey);
      } else { 
        ok=String(chosen)===String(q.answerKey); 
      }
      q.__answered = true;

      if (ok) {
        state.score.correct++;
        state.score.streak++;
        
        // å–®éŸ³æ¨¡å¼ï¼šç­”å°æ™‚é¡¯ç¤ºç­”æ¡ˆéŸ³æç¤ºä¸¦æ’­æ”¾ç­”æ¡ˆ
        if (q.type === 'note') {
          const ansMidi = Number(q.answerKey);
          const answerFreq = midiToFreq(ansMidi);
          playTone(answerFreq, 1000, state.wave, 15, 0);
          // ç­”æ¡ˆéŸ³éµèˆ‡æç¤ºå­—åŒæ­¥äº® 1000msï¼Œç„¶å¾Œä¸€èµ·ç†„æ»…
          highlightAnswer(ansMidi);
          setTimeout(()=>{ clearAnswerHighlight(ansMidi); }, 1000);
          // æ’­æ”¾ç­”æ¡ˆéŸ³æ™‚æ‰é¡¯ç¤ºã€Œç­”æ¡ˆï¼šã€ä½¿ç”¨éŸ³å
          solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+midiToName(ansMidi)+'</b>';
        }
        // éŸ³ç¨‹è¾¨è­˜ï¼šç­”å°æ™‚é¡¯ç¤ºç­”æ¡ˆéŸ³æç¤ºä¸¦æ’­æ”¾é¡Œç›®éŸ³
        if (q.type === 'interval_up' || q.type === 'interval_down') {
          const ansMidi = Number(q.answerKey);
          const baseMidi = Number(q.baseMidi); // é¡Œç›®éŸ³çš„ç¬¬ä¸€å€‹éŸ³
          const intervalSteps = Number(q.intervalSteps);
          
          // æ¿€æ´»ç­”æ¡ˆéŸ³çŠ¶æ€æç¤º
          updateStatusHint(hintAnswerEl, true);
          
          // æ’­æ”¾é¡Œç›®éŸ³ï¼šå…ˆæ’­æ”¾é¡Œç›®éŸ³çš„ç¬¬ä¸€å€‹éŸ³ï¼Œå†æ’­æ”¾é¡Œç›®éŸ³çš„ç¬¬äºŒå€‹éŸ³
          // ä¸éŸ³é¢‘åŒæ­¥é«˜äº®ï¼šå…ˆé«˜äº®ç¬¬ä¸€ä¸ªéŸ³ï¼Œå†é«˜äº®ç¬¬äºŒä¸ªéŸ³ï¼Œä¿æŒé«˜äº®ç›´åˆ°è¯­éŸ³æ’­æ”¾å®Œæˆ
          if(q.type === 'interval_up'){
            // ä¸Šè¡Œï¼šbaseï¼ˆä½ï¼‰â†’ ansMidiï¼ˆé«˜ï¼‰
            playTone(midiToFreq(baseMidi), 600, state.wave, 15, 0);
            highlightKeysManual([baseMidi]);
            
            playTone(midiToFreq(ansMidi), 1000, state.wave, 15, 0.7);
            setTimeout(()=>highlightKeysManual([ansMidi]), 700);
            
            // æ’­æ”¾ç­”æ¡ˆéŸ³æ™‚æ‰é¡¯ç¤ºã€Œç­”æ¡ˆï¼šã€æ ¼å¼ç‚ºé¡Œç›®éŸ³çš„éŸ³ç¨‹ï¼Œä¾‹å¦‚ "A4 to B4 å¤§äºŒåº¦"
            const answerText = formatIntervalAnswer(baseMidi, ansMidi, intervalSteps);
            solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+answerText+'</b>';
          } else {
            // ä¸‹è¡Œï¼šbaseï¼ˆé«˜ï¼‰â†’ ansMidiï¼ˆä½ï¼‰
            playTone(midiToFreq(baseMidi), 600, state.wave, 15, 0);
            highlightKeysManual([baseMidi]);
            
            playTone(midiToFreq(ansMidi), 1000, state.wave, 15, 0.7);
            setTimeout(()=>highlightKeysManual([ansMidi]), 700);
            
            // æ’­æ”¾ç­”æ¡ˆéŸ³æ™‚æ‰é¡¯ç¤ºã€Œç­”æ¡ˆï¼šã€æ ¼å¼ç‚ºé¡Œç›®éŸ³çš„éŸ³ç¨‹ï¼Œä¾‹å¦‚ "D4 to G4 å®Œå…¨å››åº¦"
            const answerText = formatIntervalAnswer(baseMidi, ansMidi, intervalSteps);
            solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+answerText+'</b>';
          }
          
          // ç­‰éŸ³ç¨‹æ’­æ”¾å®Œæˆå¾Œå†å¿µèªéŸ³
          setTimeout(() => {
            const speechText = intervalSpeechText(baseMidi, ansMidi, intervalSteps);
            speakText(speechText, () => {
              // èªéŸ³æ’­ç•¢å¾Œï¼Œå…ˆè®“ç­”æ¡ˆç‡ˆè™Ÿå’Œç‹€æ…‹æç¤ºä¸€èµ·ç†„æ»…
              clearKeysHighlight([baseMidi, ansMidi]);
              updateStatusHint(null, false);
            });
          }, 1700); // ç­‰å¾…éŸ³ç¨‹æ’­æ”¾å®Œæˆï¼ˆ1700msï¼‰
        }
      } else {
        // å–®éŸ³æ¨¡å¼ï¼šåŒä¸€é¡ŒéŒ¯èª¤åªè¨ˆä¸€æ¬¡
        if (q.type !== 'note' || !q.__countedWrong) {
          state.score.wrong++;
          if (q.type === 'note') q.__countedWrong = true;
        }
        // éŸ³ç¨‹è¾¨è­˜ï¼šåŒä¸€é¡ŒéŒ¯èª¤åªè¨ˆä¸€æ¬¡
        if ((q.type === 'interval_up' || q.type === 'interval_down') && !q.__countedWrong) {
          state.score.wrong++;
          q.__countedWrong = true;
        }
        state.score.streak = 0;
      }
      correctEl.textContent=state.score.correct; wrongEl.textContent=state.score.wrong; streakEl.textContent=state.score.streak;

      // å–®éŸ³æ¨¡å¼ï¼šç­”å°è‡ªå‹•ä¸‹ä¸€é¡Œ
      if (q.type==='note' && ok) { setTimeout(()=>newQuestion(), 1500); }
      // éŸ³ç¨‹è¾¨è­˜ï¼šç­”å°è‡ªå‹•ä¸‹ä¸€é¡Œ
      if ((q.type==='interval_up' || q.type==='interval_down') && ok) { setTimeout(()=>newQuestion(), 1500); }
    }

    // ---------- Group switch ----------
    function setGroup(cMidi){
      state.groupC = Math.max(MIDI_C1, Math.min(MIDI_C7, cMidi));
      buildPiano();
      localStorage.setItem('ear_groupC', String(state.groupC));
      newQuestion(); // å³æ™‚å‡ºé¡Œ
    }

    // ---------- Events ----------
    modeEl.addEventListener('change', newQuestion);
    waveEl.addEventListener('change', ()=>state.wave=waveEl.value);
    volumeEl.addEventListener('input', ()=>{ ensureAudio(); masterGain.gain.setTargetAtTime(Number(volumeEl.value), audioCtx.currentTime, 0.01); });
    noteScopeEl.addEventListener('change', ()=>{ state.noteScope = noteScopeEl.value; if (modeEl.value==='note') newQuestion(); });
    revealEl.addEventListener('change', ()=>{ state.revealSeconds = Number(revealEl.value); localStorage.setItem('ear_revealSeconds', String(state.revealSeconds)); if ((modeEl.value==='note' || modeEl.value==='interval_up' || modeEl.value==='interval_down') && state.current) { ensureAudio(); const playStartTime = audioCtx.currentTime; const questionEndTimeRelative = state.current.play(); const questionEndTimeAbsolute = playStartTime + questionEndTimeRelative; scheduleReveal(questionEndTimeAbsolute); } });
    playBtn.addEventListener('click', ()=>{ if(!state.current) newQuestion(); else { stopAllAudioAndSpeech(); ensureAudio(); const playStartTime = audioCtx.currentTime; const questionEndTimeRelative = state.current.play(); if(state.current.type==='note' || state.current.type==='interval_up' || state.current.type==='interval_down') { const questionEndTimeAbsolute = playStartTime + questionEndTimeRelative; scheduleReveal(questionEndTimeAbsolute); } } });
    repeatBtn.addEventListener('click', ()=>{ if(state.current) { stopAllAudioAndSpeech(); ensureAudio(); const playStartTime = audioCtx.currentTime; const questionEndTimeRelative = state.current.play(); if(state.current.type==='note' || state.current.type==='interval_up' || state.current.type==='interval_down') { const questionEndTimeAbsolute = playStartTime + questionEndTimeRelative; scheduleReveal(questionEndTimeAbsolute); } } });
    giveUpBtn.addEventListener('click', ()=>{ if(state.current){ showAnswerOnly(); } });
    nextBtn.addEventListener('click', newQuestion);
    prevGroupBtn.addEventListener('click', ()=>setGroup(state.groupC-12));
    nextGroupBtn.addEventListener('click', ()=>setGroup(state.groupC+12));
    document.addEventListener('keydown', (e)=>{
      if(['INPUT','SELECT','TEXTAREA'].includes(e.target.tagName)) return;
      if(e.code==='Space'){
        e.preventDefault();
        if(!state.current){
          newQuestion();
        }else{
          // é‡æ’­ï¼šå…ˆæ‰“æ–·æ‰€æœ‰è²éŸ³ã€èªéŸ³å’Œå®šæ™‚å™¨ï¼Œå†å¾é ­æ’­æ”¾ï¼Œä¸¦é‡æ–°å•Ÿå‹•è¨ˆæ™‚èˆ‡æç¤º
          stopAllAudioAndSpeech();
          ensureAudio();
          const playStartTime = audioCtx.currentTime;
          const questionEndTimeRelative = state.current.play();
          if(state.current.type==='note' || state.current.type==='interval_up' || state.current.type==='interval_down') {
            const questionEndTimeAbsolute = playStartTime + questionEndTimeRelative;
            scheduleReveal(questionEndTimeAbsolute);
          }
        }
      }
      if(e.key.toLowerCase()==='r'){
        e.preventDefault();
        if(state.current){
          // é‡æ’­ï¼šå…ˆæ‰“æ–·æ‰€æœ‰è²éŸ³ã€èªéŸ³å’Œå®šæ™‚å™¨ï¼Œå†å¾é ­æ’­æ”¾ï¼Œä¸¦é‡æ–°å•Ÿå‹•è¨ˆæ™‚èˆ‡æç¤º
          stopAllAudioAndSpeech();
          ensureAudio();
          const playStartTime = audioCtx.currentTime;
          const questionEndTimeRelative = state.current.play();
          if(state.current.type==='note' || state.current.type==='interval_up' || state.current.type==='interval_down') {
            const questionEndTimeAbsolute = playStartTime + questionEndTimeRelative;
            scheduleReveal(questionEndTimeAbsolute);
          }
        }
      }
      if(e.key.toLowerCase()==='n'){ e.preventDefault(); newQuestion(); }
      if(e.key==='ArrowLeft'){ e.preventDefault(); setGroup(state.groupC-12); }
      if(e.key==='ArrowRight'){ e.preventDefault(); setGroup(state.groupC+12); }
    });

    // ---------- Init ----------
    (function init(){
      const saved = Number(localStorage.getItem('ear_groupC'));
      if(!Number.isNaN(saved)) state.groupC = saved;
      const savedReveal = Number(localStorage.getItem('ear_revealSeconds'));
      if(!Number.isNaN(savedReveal) && [1,3,5,7].includes(savedReveal)) state.revealSeconds = savedReveal;
      buildPiano();
      groupLabelEl.textContent = nameRange(state.groupC);
      // åŒæ­¥ä¸‹æ‹‰ã€‚
      revealEl.value = String(state.revealSeconds);
      
      // é¢„åŠ è½½è¯­éŸ³åˆ—è¡¨ï¼Œç¡®ä¿è¯­éŸ³å¯ç”¨
      ensureVoicesLoaded(() => {
        // è¯­éŸ³åˆ—è¡¨å·²åŠ è½½
      });
    })();
  </script>
</body>
</html>