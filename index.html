<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AIè¼”åŠ©åˆ¶è‡ª-ç·šä¸ŠèªéŸ³å¾ªç’°æ’­æ”¾éŸ³æ„Ÿè¨“ç·´å™¨</title>
  <style>
    :root {
      --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af; --border:#1f2937;
      --btn:#1f2937; --btn-hover:#374151; --key-white:#e5e7eb; --key-black:#111827;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Microsoft JhengHei","PingFang TC","Heiti TC",sans-serif;background:radial-gradient(1000px 600px at 80% -10%,#1f293766,transparent),radial-gradient(800px 500px at -10% 20%,#14532d66,transparent),var(--bg);color:var(--text)}
    .container{max-width:1080px;margin:0 auto;padding:24px 16px 84px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:20px}
    .title{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#16a34a,#22c55e);display:grid;place-items:center;color:#fff;font-weight:800}
    h1{margin:0;font-size:22px;letter-spacing:.3px}
    .panel{background:#111827ee;border:1px solid var(--border);border-radius:12px;padding:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:1000px){.grid{grid-template-columns:420px 1fr}}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .grow{flex:1 1 auto}
    label{color:var(--muted);font-size:13px}
    select,input[type=range]{width:100%;background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    .btn{background:var(--btn);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px 14px;cursor:pointer;transition:background .15s,transform .02s}
    .btn:hover{background:var(--btn-hover)} .btn:active{transform:translateY(1px)}
    .answers{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .answer-btn{padding:12px 10px;background:#0b1220;border:1px solid var(--border);border-radius:12px;color:var(--text);cursor:pointer}
    .score{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px;border-radius:12px;background:#0b1220;border:1px solid var(--border)}
    .hint{color:var(--muted);font-size:13px}
    .status-hints-container{display:flex;align-items:center;gap:8px;margin-top:12px;flex-wrap:wrap;justify-content:center}
    .status-hint{font-size:15px;font-weight:600;padding:10px 16px;border-radius:8px;background:#0b1220;border:2px solid var(--border);transition:all 0.3s ease;white-space:nowrap;min-width:110px;text-align:center;position:relative}
    .status-hint.active{color:#22c55e;border-color:#22c55e;background:linear-gradient(135deg,#14532d88,#22c55e44);box-shadow:0 0 16px rgba(34,197,94,0.4),inset 0 0 20px rgba(34,197,94,0.1);transform:scale(1.08);font-weight:700}
    .status-hint.inactive{color:var(--muted);opacity:0.35;border-color:var(--border)}
    .status-arrow{color:var(--muted);font-size:24px;font-weight:bold;opacity:0.5;transition:all 0.3s ease;padding:0 4px}
    .status-arrow.active{color:#22c55e;opacity:1;transform:scale(1.3);text-shadow:0 0 8px rgba(34,197,94,0.6)}

    /* Piano */
    .kbd-wrap{margin-top:12px}
    .piano{position:relative;height:160px;user-select:none}
    .white-keys{display:flex;height:100%}
    .white-key{position:relative;flex:1 1 0;background:var(--key-white);border:1px solid #374151;border-bottom-width:6px;border-radius:0 0 6px 6px;margin-right:-1px}
    .white-key.active{background:#c7f9cc;border-color:#22c55e}
    .black-key{position:absolute;top:0;height:62%;background:linear-gradient(#222,#000);border:1px solid #000;border-bottom-width:6px;border-radius:0 0 6px 6px;transform:translateX(-50%);z-index:5}
    .black-key.active{background:#22c55e;border-color:#14532d}
    .solfege{margin-top:10px;padding:10px;border:1px solid var(--border);border-radius:10px;background:#0b1220;font-size:14px}
    .solfege b{color:#22c55e}
    /* Key labels */
    .key-label{position:absolute;left:50%;transform:translateX(-50%);bottom:6px;font-size:12px;line-height:1.05;font-weight:600;pointer-events:none;user-select:none;text-align:center;white-space:pre}
    .key-label--white{color:#111827}
    .key-label--black{color:#e5e7eb;font-size:11px;bottom:4px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">
        <div class="logo">â™ª</div>
        <div>
          <h1>AIè¼”åŠ©åˆ¶è‡ª-ç·šä¸ŠèªéŸ³å¾ªç’°æ’­æ”¾éŸ³æ„Ÿè¨“ç·´å™¨</h1>
          <div class="hint">å–®éŸ³ï¼šå…ˆæ’­ 3 æ¬¡çµ„å…§ C åšåŸºæº–ï¼Œå†å‡ºé¡Œï¼›ç”¨é»éµä½œç­”</div>
        </div>
      </div>
      <button id="playBtn" class="btn">æ’­æ”¾é¡Œç›® (ç©ºç™½)</button>
    </header>

    <div class="grid">
      <section class="panel">
        <div class="row">
          <div class="grow">
            <label for="mode">æ¨¡å¼</label>
            <select id="mode">
              <option value="note">éŸ³é«˜è¾¨è­˜ï¼ˆå–®éŸ³ï¼‰</option>
              <option value="interval_up">éŸ³ç¨‹è¾¨è­˜ï¼ˆä¸Šè¡Œï¼‰</option>
              <option value="interval_down">éŸ³ç¨‹è¾¨è­˜ï¼ˆä¸‹è¡Œï¼‰</option>
              <option value="interval_harm">éŸ³ç¨‹è¾¨è­˜ï¼ˆå’Œè²/åŒæ™‚ï¼‰</option>
              <option value="triad">å’Œå¼¦è¾¨è­˜ï¼ˆä¸‰å’Œå¼¦ï¼‰</option>
              <option value="seventh">å’Œå¼¦è¾¨è­˜ï¼ˆä¸ƒå’Œå¼¦ï¼‰</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="grow">
            <label for="wave">éŸ³è‰²</label>
            <select id="wave">
              <option value="sine">Sine</option>
              <option value="triangle">Triangle</option>
              <option value="square">Square</option>
              <option value="sawtooth">Sawtooth</option>
              <option value="piano">Pianoï¼ˆé‹¼ç´-åˆæˆï¼‰</option>
            </select>
          </div>
          <div style="width:160px">
            <label for="volume">éŸ³é‡</label>
            <input id="volume" type="range" min="0" max="1" step="0.01" value="0.25">
          </div>
        </div>

        <!-- å–®éŸ³å‡ºé¡ŒéŸ³åŸŸé™åˆ¶ï¼šç™½éµ/å…¨éƒ¨ -->
        <div class="row">
          <div class="grow">
            <label for="noteScope">å–®éŸ³å‡ºé¡Œå…§å®¹</label>
            <select id="noteScope">
              <option value="all">ç™½éµ + é»‘éµï¼ˆå…¨éƒ¨ï¼‰</option>
              <option value="white">åªå‡ºç™½éµï¼ˆC D E F G A Bï¼‰</option>
            </select>
          </div>
        </div>

        <!-- å–®éŸ³ï¼šè‡ªå‹•å…¬å¸ƒç­”æ¡ˆè¨ˆæ™‚ -->
        <div class="row">
          <div class="grow">
            <label for="revealAfter">è‡ªå‹•å…¬å¸ƒç­”æ¡ˆï¼ˆç§’ï¼‰</label>
            <select id="revealAfter">
              <option value="1">1 ç§’</option>
              <option value="3">3 ç§’</option>
              <option value="5">5 ç§’</option>
              <option value="7">7 ç§’</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="grow">
            <label>ç›®å‰çµ„åˆ¥ï¼ˆCnâ€“C(n+1)ï¼‰</label>
            <div class="row">
              <button id="prevGroup" class="btn">â—€ ä¸Šä¸€çµ„</button>
              <div id="groupLabel" class="grow" style="text-align:center;font-weight:700">C4â€“C5</div>
              <button id="nextGroup" class="btn">ä¸‹ä¸€çµ„ â–¶</button>
            </div>
            <div class="hint" style="margin-top:6px">æ‰€æœ‰é¡Œç›®é™åˆ¶åœ¨æ­¤çµ„ï¼Œå«ä¸Šç•Œ Cã€‚</div>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <button id="repeatBtn" class="btn">é‡æ’­ (R)</button>
          <button id="giveUpBtn" class="btn">çœ‹ç­”æ¡ˆ</button>
          <button id="nextBtn" class="btn">ä¸‹ä¸€é¡Œ (N)</button>
        </div>
      </section>

      <section class="panel">
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div>
            <div style="font-size:13px;color:#9ca3af">ç›®å‰é¡Œç›®</div>
            <div id="questionLabel" style="font-size:20px;font-weight:700">â€”</div>
          </div>
          <div class="score">
            <div>âœ… <span id="correctCount">0</span></div>
            <div>âŒ <span id="wrongCount">0</span></div>
            <div>ğŸ¯ <span id="streak">0</span></div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div id="answers" class="answers"></div>
        </div>

        <div class="kbd-wrap">
          <div class="hint">å¯ç›´æ¥é»æ“Šé‹¼ç´éµä½œç­”ï¼ˆå–®éŸ³æ¨¡å¼ï¼‰</div>
          <div id="piano" class="piano"></div>
          <div id="solfege" class="solfege">ç­”æ¡ˆï¼šâ€”</div>
          
          <div id="statusHints" style="display:none;margin-top:12px">
            <div class="status-hints-container">
              <div id="hintRef" class="status-hint inactive">å‚è€ƒéŸ³</div>
              <div id="arrow1" class="status-arrow">â†’</div>
              <div id="hintQuestion" class="status-hint inactive">é¢˜ç›®éŸ³</div>
              <div id="arrow2" class="status-arrow">â†’</div>
              <div id="hintAnswer" class="status-hint inactive">ç­”æ¡ˆéŸ³</div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ---------- Notes / MIDI ----------
    const PCN = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const SOLFEGE = ['Do','Di','Re','Ri','Mi','Fa','Fi','So','Si','La','Li','Ti'];
    const MIDI_C1 = 24, MIDI_C7 = 96;
    function midiToFreq(m){ return 440 * Math.pow(2,(m-69)/12); }
    function midiToName(m){ return PCN[m%12] + (Math.floor(m/12)-1); }
    // è·å–éŸ³åï¼ˆä¸å¸¦éŸ³åŒºï¼‰ï¼Œä¾‹å¦‚ C, C#, D, Db ç­‰
    function midiToNoteNameOnly(midi){
      const pc = Number(midi) % 12;
      return PCN[pc];
    }
    // é»‘éµé¡¯ç¤ºå‡/é™é›™éŸ³åï¼Œä¾‹å¦‚ C#4/Db4
    function midiBlackLabel(m){
      const pc = m % 12;
      const octave = Math.floor(m/12) - 1;
      const sharp = PCN[pc] + octave;
      const FLAT = {1:'Db',3:'Eb',6:'Gb',8:'Ab',10:'Bb'};
      if (FLAT[pc]) return sharp + '\n' + FLAT[pc] + octave; // å…©è¡Œé¡¯ç¤ºï¼Œé¿å…æ“ å‡ºéµå¸½
      return sharp;
    }
    function nameRange(cStart){ return midiToName(cStart) + 'â€“' + midiToName(cStart+12); }
    function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
    function shuffle(a){ const x=a.slice(); for(let i=x.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]];} return x; }

    // ---------- Audio ----------
    let audioCtx, masterGain;
    let __activeNodes = [];
    function ensureAudio(){
      if(!audioCtx){
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        masterGain = audioCtx.createGain();
        masterGain.gain.value = Number(volumeEl.value || 0.25);
        masterGain.connect(audioCtx.destination);
      }
      if(audioCtx.state==='suspended') audioCtx.resume();
    }
    function stopAllSounds(){
      if (!__activeNodes.length) return;
      __activeNodes.forEach(n=>{ try{ n.stop(0); }catch(_){} try{ n.disconnect(); }catch(_){} });
      __activeNodes = [];
    }
    // å¼·åˆ¶åœæ­¢æ‰€æœ‰éŸ³é »ã€èªéŸ³å’Œå®šæ™‚å™¨
    function stopAllAudioAndSpeech(){
      // åœæ­¢æ‰€æœ‰éŸ³é »
      stopAllSounds();
      // åœæ­¢èªéŸ³åˆæˆ
      try {
        speechSynthesis.cancel();
      } catch(_) {}
      // æ¸…é™¤è‡ªå‹•å…¬å¸ƒç­”æ¡ˆçš„å®šæ™‚å™¨
      clearRevealTimer();
    }
    function playPianoTone(freq, dur=900, when=0){
      ensureAudio();
      const t0 = audioCtx.currentTime + when;
      const t1 = t0 + dur/1000;
      const releaseTail = 0.8; // å°¾éŸ³å»¶é•·ï¼ˆç§’ï¼‰- å¢åŠ è‡³0.8ç§’

      // Envelope (percussive)
      const eg = audioCtx.createGain();
      eg.gain.setValueAtTime(0.0001, t0);
      eg.gain.exponentialRampToValueAtTime(1.0, t0 + 0.008);
      // ä¸»è¦éŸ³é‡è¡°æ¸›åˆ°è¼ƒå°å€¼ï¼Œä¿ç•™å°¾éŸ³
      eg.gain.exponentialRampToValueAtTime(0.08, t1); // å¾0.02æé«˜åˆ°0.08ï¼Œè®“å°¾éŸ³æ›´æ˜é¡¯
      // å°¾éŸ³å†ç·©æ…¢æ·¡å‡º
      eg.gain.exponentialRampToValueAtTime(0.0001, t1 + releaseTail);

      // Gentle lowpass to soften highs
      const lp = audioCtx.createBiquadFilter();
      lp.type = 'lowpass';
      lp.frequency.setValueAtTime(Math.min(6000, freq * 12), t0);
      lp.Q.value = 0.8;
      eg.connect(lp).connect(masterGain);

      // å¢åŠ æ›´å¤šæ³›éŸ³ï¼Œä½¿éŸ³è‰²æ›´é£½æ»¿
      const partials = [
        { mult: 1.0, gain: 1.0, detune: -4 },      // åŸºéŸ³
        { mult: 2.0, gain: 0.35, detune: +3 },    // ç¬¬äºŒæ³›éŸ³ï¼ˆæé«˜å¢ç›Šï¼‰
        { mult: 3.0, gain: 0.22, detune: -1 },    // ç¬¬ä¸‰æ³›éŸ³ï¼ˆæé«˜å¢ç›Šï¼‰
        { mult: 4.0, gain: 0.12, detune: +2 },    // ç¬¬å››æ³›éŸ³ï¼ˆæ–°å¢ï¼‰
        { mult: 5.0, gain: 0.08, detune: -2 },    // ç¬¬äº”æ³›éŸ³ï¼ˆæ–°å¢ï¼‰
      ];
      partials.forEach(p => {
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(freq * p.mult, t0);
        try { osc.detune.setValueAtTime(p.detune, t0); } catch(_){ }
        g.gain.setValueAtTime(p.gain, t0);
        osc.connect(g).connect(eg);
        osc.start(t0);
        osc.stop(t1 + releaseTail + 0.01);
        __activeNodes.push(osc);
        osc.onended = () => {
          try { osc.disconnect(); } catch(_){ }
          __activeNodes = __activeNodes.filter(n => n !== osc);
        };
      });
    }

    function playTone(freq, dur=900, type='sine', fade=15, when=0){
      if (type === 'piano') return playPianoTone(freq, dur, when);
      ensureAudio();
      const t0 = audioCtx.currentTime + when, t1 = t0 + dur/1000;
      const o = audioCtx.createOscillator(), g = audioCtx.createGain();
      o.type = type; o.frequency.setValueAtTime(freq, t0);
      g.gain.setValueAtTime(0, t0); g.gain.linearRampToValueAtTime(1, t0+fade/1000);
      g.gain.setValueAtTime(1, t1-fade/1000); g.gain.linearRampToValueAtTime(0.0001, t1);
      o.connect(g).connect(masterGain);
      o.start(t0);
      o.stop(t1+0.02);
      __activeNodes.push(o);
      o.onended = () => {
        try { o.disconnect(); } catch(_){ }
        __activeNodes = __activeNodes.filter(n => n !== o);
      };
    }

    // ---------- Elements ----------
    const modeEl = document.getElementById('mode');
    const waveEl = document.getElementById('wave');
    const volumeEl = document.getElementById('volume');
    const noteScopeEl = document.getElementById('noteScope');
    const playBtn = document.getElementById('playBtn');
    const repeatBtn = document.getElementById('repeatBtn');
    const giveUpBtn = document.getElementById('giveUpBtn');
    const nextBtn = document.getElementById('nextBtn');
    const answersEl = document.getElementById('answers');
    const questionLabel = document.getElementById('questionLabel');
    const correctEl = document.getElementById('correctCount');
    const wrongEl = document.getElementById('wrongCount');
    const streakEl = document.getElementById('streak');
    const pianoEl = document.getElementById('piano');
    const solfegeEl = document.getElementById('solfege');
    const prevGroupBtn = document.getElementById('prevGroup');
    const nextGroupBtn = document.getElementById('nextGroup');
    const groupLabelEl = document.getElementById('groupLabel');
    const revealEl = document.getElementById('revealAfter');
    const statusHintsEl = document.getElementById('statusHints');
    const hintRefEl = document.getElementById('hintRef');
    const hintQuestionEl = document.getElementById('hintQuestion');
    const hintAnswerEl = document.getElementById('hintAnswer');
    const arrow1El = document.getElementById('arrow1');
    const arrow2El = document.getElementById('arrow2');

    // ---------- State ----------
    const state = {
      wave:'sine',
      score:{correct:0,wrong:0,streak:0},
      groupC:60, // C4
      current:null,
      noteScope:'all', // 'all' | 'white'
      revealSeconds:5 // 1 | 3 | 5 | 7ï¼ˆå–®éŸ³æ¨¡å¼å’ŒéŸ³ç¨‹æ¨¡å¼ç”¨ï¼‰
    };
    function currentLow(){ return state.groupC; }
    function currentHigh(){ 
      // æ£€æŸ¥å½“å‰æ¨¡å¼ï¼Œå¦‚æœæ˜¯ä¸‰å’Œå¼¦æˆ–ä¸ƒå’Œå¼¦ï¼Œè¿”å›2ä¸ªéŸ³åŒºçš„ä¸Šç•Œ
      const currentMode = modeEl ? modeEl.value : 'note';
      const isChordMode = currentMode === 'triad' || currentMode === 'seventh';
      return state.groupC + (isChordMode ? 24 : 12); // å«ä¸Šç•Œ C
    }

    // ---------- Piano ----------
    function buildPiano(){
      pianoEl.innerHTML = '';
      // æ£€æŸ¥å½“å‰æ¨¡å¼ï¼Œå¦‚æœæ˜¯ä¸‰å’Œå¼¦æˆ–ä¸ƒå’Œå¼¦ï¼Œæ˜¾ç¤º2ä¸ªéŸ³åŒº
      const currentMode = modeEl ? modeEl.value : 'note';
      const isChordMode = currentMode === 'triad' || currentMode === 'seventh';
      const octaveCount = isChordMode ? 2 : 1; // ä¸‰å’Œå¼¦å’Œä¸ƒå’Œå¼¦æ˜¾ç¤º2ä¸ªéŸ³åŒº
      const totalKeys = isChordMode ? 15 : 8; // 2ä¸ªéŸ³åŒº = 15ä¸ªç™½é”®ï¼ˆCåˆ°Cï¼‰ï¼Œ1ä¸ªéŸ³åŒº = 8ä¸ªç™½é”®
      
      const whiteWrap = document.createElement('div');
      whiteWrap.className = 'white-keys';
      const whiteSteps = [0,2,4,5,7,9,11]; // C D E F G A Bï¼ˆä¸€ä¸ªå…«åº¦çš„ç™½é”®ï¼‰
      const whiteMidis = [];
      // ç”Ÿæˆæ‰€æœ‰ç™½é”®
      for(let octave = 0; octave < octaveCount; octave++){
        whiteSteps.forEach(st => {
          whiteMidis.push(state.groupC + st + octave * 12);
        });
      }
      // æ·»åŠ æœ€åä¸€ä¸ªCï¼ˆä¸Šç•Œï¼‰
      whiteMidis.push(state.groupC + octaveCount * 12);
      
      whiteMidis.forEach(m => {
        const wk = document.createElement('div');
        wk.className = 'white-key';
        wk.dataset.midi = String(m);
        wk.addEventListener('mousedown', ()=>playKey(m));
        wk.addEventListener('touchstart', (e)=>{e.preventDefault(); playKey(m);}, {passive:false});
        const lbl = document.createElement('div');
        lbl.className = 'key-label key-label--white';
        lbl.textContent = midiToName(m);
        wk.appendChild(lbl);
        whiteWrap.appendChild(wk);
      });
      pianoEl.appendChild(whiteWrap);

      const whiteWidth = 100 / totalKeys;
      // ç”Ÿæˆæ‰€æœ‰é»‘é”®
      for(let octave = 0; octave < octaveCount; octave++){
        [
          { st:1, afterWhiteIdx:0 }, // C#
          { st:3, afterWhiteIdx:1 }, // D#
          { st:6, afterWhiteIdx:3 }, // F#
          { st:8, afterWhiteIdx:4 }, // G#
          { st:10,afterWhiteIdx:5 }  // A#
        ].forEach(b=>{
          const m = state.groupC + b.st + octave * 12;
          // è®¡ç®—é»‘é”®ä½ç½®ï¼šæ¯ä¸ªéŸ³åŒºæœ‰7ä¸ªç™½é”®ï¼ˆCåˆ°Bï¼‰ï¼ŒåŠ ä¸ŠéŸ³åŒºåç§»
          const whiteKeyIndex = b.afterWhiteIdx + octave * 7;
          const left = (whiteKeyIndex + 1) * whiteWidth;
          const bk = document.createElement('div');
          bk.className = 'black-key';
          bk.dataset.midi = String(m);
          bk.style.left = left + '%';
          bk.style.width = (whiteWidth*0.6) + '%';
          bk.addEventListener('mousedown', ()=>playKey(m));
          bk.addEventListener('touchstart', (e)=>{e.preventDefault(); playKey(m);}, {passive:false});
          const lbl = document.createElement('div');
          lbl.className = 'key-label key-label--black';
          lbl.textContent = midiBlackLabel(m);
          bk.appendChild(lbl);
          pianoEl.appendChild(bk);
        });
      }

      // æ›´æ–°ç»„åˆ«æ ‡ç­¾
      if(isChordMode){
        groupLabelEl.textContent = nameRange(state.groupC) + 'â€“' + midiToName(state.groupC + 24);
      } else {
        groupLabelEl.textContent = nameRange(state.groupC);
      }
    }
    function highlightKeys(midis, ms){
      const set = new Set(midis.map(Number));
      const nodes = pianoEl.querySelectorAll('[data-midi]');
      nodes.forEach(n => { if(set.has(Number(n.dataset.midi))) n.classList.add('active'); });
      setTimeout(()=>nodes.forEach(n=>n.classList.remove('active')), ms);
    }
    // æ‰‹åŠ¨é«˜äº®é’¢ç´é”®ï¼ˆä¸è‡ªåŠ¨ç†„ç­ï¼‰
    function highlightKeysManual(midis){
      const set = new Set(midis.map(Number));
      const nodes = pianoEl.querySelectorAll('[data-midi]');
      nodes.forEach(n => { if(set.has(Number(n.dataset.midi))) n.classList.add('active'); });
    }
    // æ¸…é™¤æŒ‡å®šé’¢ç´é”®çš„é«˜äº®
    function clearKeysHighlight(midis){
      const set = new Set(midis.map(Number));
      const nodes = pianoEl.querySelectorAll('[data-midi]');
      nodes.forEach(n => { if(set.has(Number(n.dataset.midi))) n.classList.remove('active'); });
    }
    // ç­”æ¡ˆéŸ³ï¼šé‹¼ç´éµèˆ‡ã€Œç­”æ¡ˆéŸ³ã€æç¤ºå­—äº®èµ·
    function highlightAnswer(midi){
      const midis = Array.isArray(midi) ? midi : [midi];
      const set = new Set(midis.map(Number));
      const nodes = pianoEl.querySelectorAll('[data-midi]');
      nodes.forEach(n => { if(set.has(Number(n.dataset.midi))) n.classList.add('active'); });
      updateStatusHint(hintAnswerEl, true);
    }
    // ç­”æ¡ˆéŸ³ï¼šé‹¼ç´éµèˆ‡ã€Œç­”æ¡ˆéŸ³ã€æç¤ºå­—ä¸€èµ·ç†„æ»…
    function clearAnswerHighlight(midi){
      const midis = Array.isArray(midi) ? midi : [midi];
      const set = new Set(midis.map(Number));
      const nodes = pianoEl.querySelectorAll('[data-midi]');
      nodes.forEach(n => { if(set.has(Number(n.dataset.midi))) n.classList.remove('active'); });
      updateStatusHint(null, false);
    }
    // åªçœ‹ç­”æ¡ˆï¼šåªé«˜äº®é‹¼ç´éµï¼Œä¸æ’­æ”¾éŸ³é »ï¼Œä¸å½±éŸ¿å…¶ä»–åŠŸèƒ½
    function showAnswerOnly(){
      if(!state.current) return;
      const q = state.current;
      // ä¸æ¸…é™¤å®šæ™‚å™¨ï¼Œä¿æŒè‡ªå‹•å…¬å¸ƒç­”æ¡ˆåŠŸèƒ½æ­£å¸¸é‹ä½œ
      // ä¸æ”¹è®Šç‹€æ…‹æç¤ºï¼Œä¿æŒç•¶å‰ç‹€æ…‹
      
      if(q.type === 'note'){
        // å–®éŸ³æ¨¡å¼ï¼šåªé«˜äº®é‹¼ç´éµï¼Œä¸æ”¹è®Šç‹€æ…‹æç¤º
        const ansMidi = Number(q.answerKey);
        const midis = [ansMidi];
        const set = new Set(midis.map(Number));
        const nodes = pianoEl.querySelectorAll('[data-midi]');
        nodes.forEach(n => { if(set.has(Number(n.dataset.midi))) n.classList.add('active'); });
        solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+midiToNoteNameOnly(ansMidi)+'</b>';
      } else if(q.type === 'interval_up' || q.type === 'interval_down'){
        // éŸ³ç¨‹è¾¨è­˜æ¨¡å¼ï¼šåªé«˜äº®é‹¼ç´éµï¼Œä¸æ”¹è®Šç‹€æ…‹æç¤º
        // éœ€è¦é«˜äº®å…©å€‹éŸ³ï¼šbaseMidiï¼ˆåŸºæº–éŸ³ï¼‰å’Œ ansMidiï¼ˆç›®æ¨™éŸ³ï¼‰
        const ansMidi = Number(q.answerKey);
        const baseMidi = Number(q.baseMidi);
        const intervalSteps = Number(q.intervalSteps);
        const midis = [baseMidi, ansMidi]; // é«˜äº®å…©å€‹éŸ³
        const set = new Set(midis.map(Number));
        const nodes = pianoEl.querySelectorAll('[data-midi]');
        nodes.forEach(n => { if(set.has(Number(n.dataset.midi))) n.classList.add('active'); });
        const answerText = formatIntervalAnswer(baseMidi, ansMidi, intervalSteps);
        solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+answerText+'</b>';
      } else if(q.type === 'interval_harm'){
        // å’Œè²éŸ³ç¨‹è¾¨è­˜æ¨¡å¼ï¼šåªé«˜äº®é‹¼ç´éµï¼Œä¸æ”¹è®Šç‹€æ…‹æç¤º
        // éœ€è¦é«˜äº®å…©å€‹éŸ³ï¼šbaseMidiï¼ˆè¼ƒä½çš„éŸ³ï¼‰å’Œ otherMidiï¼ˆè¼ƒé«˜çš„éŸ³ï¼‰
        const baseMidi = Number(q.baseMidi);
        const otherMidi = Number(q.otherMidi);
        const intervalSteps = Number(q.intervalSteps);
        const midis = [baseMidi, otherMidi]; // é«˜äº®å…©å€‹éŸ³
        const set = new Set(midis.map(Number));
        const nodes = pianoEl.querySelectorAll('[data-midi]');
        nodes.forEach(n => { if(set.has(Number(n.dataset.midi))) n.classList.add('active'); });
        const answerText = formatIntervalAnswer(baseMidi, otherMidi, intervalSteps);
        solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+answerText+'</b>';
      } else if(q.type === 'triad' || q.type === 'seventh'){
        // ä¸‰å’Œå¼¦/ä¸ƒå’Œå¼¦è¾¨è­˜æ¨¡å¼ï¼šåªé«˜äº®é‹¼ç´éµï¼Œä¸æ”¹è®Šç‹€æ…‹æç¤º
        // éœ€è¦é«˜äº®å’Œå¼¦çš„æ‰€æœ‰éŸ³
        const tones = q.tones || [];
        const set = new Set(tones.map(Number));
        const nodes = pianoEl.querySelectorAll('[data-midi]');
        nodes.forEach(n => { if(set.has(Number(n.dataset.midi))) n.classList.add('active'); });
        const rootMidi = q.rootMidi || (q.tones && q.tones.length > 0 ? q.tones[0] : q.answerKey);
        const displayName = chordDisplayName(rootMidi, q.chordType, q.inversion, q.tones);
        solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+displayName+'</b>';
      } else {
        // å…¶ä»–æ¨¡å¼ç›´æ¥æäº¤ç­”æ¡ˆ
        submitAnswer(q.answerKey);
      }
    }
    function solfegeTextForMidi(midi){
      const pc = Number(midi) % 12;
      const map = ['do','å‡do','re','å‡re','mi','fa','å‡fa','so','å‡so','la','é™si','si'];
      return map[pc];
    }
    // æ ¼å¼åŒ–éŸ³ç¨‹ç­”æ¡ˆæ˜¾ç¤ºï¼šä¾‹å¦‚ "C to B å¤§ä¸ƒåº¦"ï¼ˆä¸å¸¦éŸ³åŒºæ•°å­—ï¼‰
    function formatIntervalAnswer(baseMidi, targetMidi, intervalSteps){
      const baseName = midiToNoteNameOnly(baseMidi);
      const targetName = midiToNoteNameOnly(targetMidi);
      const interval = INTERVALS.find(i => i.st === intervalSteps);
      const intervalLabel = interval ? interval.label : '';
      return `${baseName} to ${targetName} ${intervalLabel}`;
    }
    function playKey(midi){
      // å¼ºåˆ¶æ¿€æ´»è¯­éŸ³ï¼ˆç§»åŠ¨ç«¯éœ€è¦æ¯æ¬¡ç”¨æˆ·äº¤äº’åæ¿€æ´»ï¼‰
      __speechActivated = false;
      __speechTestAttempts = 0;
      activateSpeech(true);
      playTone(midiToFreq(midi), 900, state.wave);
      highlightKeys([midi], 900);
      // å–®éŸ³æ¨¡å¼ã€å’Œè²éŸ³ç¨‹æ¨¡å¼ã€ä¸‰å’Œå¼¦å’Œä¸ƒå’Œå¼¦æ¨¡å¼é¡¯ç¤ºéŸ³åï¼ˆä¸å¸¦éŸ³åŒºï¼‰ï¼Œå…¶ä»–éŸ³ç¨‹æ¨¡å¼é¡¯ç¤ºå”±å
      if (state.current && (state.current.type === 'note' || state.current.type === 'interval_harm' || state.current.type === 'triad' || state.current.type === 'seventh')) {
        solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+midiToNoteNameOnly(midi)+'</b>';
      } else {
        solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+solfegeTextForMidi(midi)+'</b>';
      }
      // å–®éŸ³æ¨¡å¼ï¼šé»éµå³ä½œç­”ï¼ˆå…è¨±å¤šæ¬¡å˜—è©¦ï¼‰
      if (state.current && state.current.type === 'note') {
        submitAnswer(midi);
      }
      // éŸ³ç¨‹è¾¨è­˜ï¼ˆä¸Šè¡Œ/ä¸‹è¡Œï¼‰ï¼šé»éµå³ä½œç­”
      if (state.current && (state.current.type === 'interval_up' || state.current.type === 'interval_down')) {
        submitAnswer(midi);
      }
      // éŸ³ç¨‹è¾¨è­˜ï¼ˆå’Œè²/åŒæ™‚ï¼‰ï¼šé»éµå³ä½œç­”
      if (state.current && state.current.type === 'interval_harm') {
        submitAnswer(midi);
      }
      // ä¸‰å’Œå¼¦è¾¨è­˜ï¼šé»éµå³ä½œç­”ï¼ˆé»æ“Šæ ¹éŸ³ï¼‰
      if (state.current && state.current.type === 'triad') {
        submitAnswer(midi);
      }
      // ä¸ƒå’Œå¼¦è¾¨è­˜ï¼šé»éµå³ä½œç­”ï¼ˆé»æ“Šæ ¹éŸ³ï¼‰
      if (state.current && state.current.type === 'seventh') {
        submitAnswer(midi);
      }
    }
    // ---------- Status Hints ----------
    function updateStatusHint(hintEl, isActive){
      // é‡ç½®æ‰€æœ‰æç¤ºå­—å’Œç®­å¤´
      hintRefEl.classList.remove('active', 'inactive');
      hintQuestionEl.classList.remove('active', 'inactive');
      hintAnswerEl.classList.remove('active', 'inactive');
      arrow1El.classList.remove('active');
      arrow2El.classList.remove('active');
      
      // è®¾ç½®æ‰€æœ‰æç¤ºå­—ä¸ºæœªæ¿€æ´»çŠ¶æ€
      hintRefEl.classList.add('inactive');
      hintQuestionEl.classList.add('inactive');
      hintAnswerEl.classList.add('inactive');
      
      if(hintEl && isActive){
        hintEl.classList.remove('inactive');
        hintEl.classList.add('active');
        
        // æ ¹æ®æ¿€æ´»çš„æç¤ºå­—ï¼Œé«˜äº®ç›¸åº”çš„ç®­å¤´
        if(hintEl === hintRefEl){
          // å‚è€ƒéŸ³æ¿€æ´»æ—¶ï¼Œç®­å¤´ä¸æ¿€æ´»
        } else if(hintEl === hintQuestionEl){
          // é¢˜ç›®éŸ³æ¿€æ´»æ—¶ï¼Œç®­å¤´1æ¿€æ´»ï¼ˆä»å‚è€ƒéŸ³åˆ°é¢˜ç›®éŸ³ï¼‰
          arrow1El.classList.add('active');
        } else if(hintEl === hintAnswerEl){
          // ç­”æ¡ˆéŸ³æ¿€æ´»æ—¶ï¼Œç®­å¤´2æ¿€æ´»ï¼ˆä»é¢˜ç›®éŸ³åˆ°ç­”æ¡ˆéŸ³ï¼‰
          arrow2El.classList.add('active');
        }
      }
    }
    function showStatusHints(show){
      if(show){
        statusHintsEl.style.display = 'block';
      } else {
        statusHintsEl.style.display = 'none';
        updateStatusHint(null, false);
      }
    }

    // ---------- Questions ----------
    function isBlackPC(pc){ return pc===1||pc===3||pc===6||pc===8||pc===10; }
    function randomMidiInGroup(){
      const low=currentLow(), high=currentHigh();
      if (state.noteScope === 'white') {
        const whites=[]; for(let m=low;m<=high;m++){ if(!isBlackPC(m%12)) whites.push(m); }
        return whites[Math.floor(Math.random()*whites.length)];
      }
      return randInt(low, high);
    }
    // å–å¾—ç•¶å‰çµ„åˆ¥çš„ç™½éµ MIDI é™£åˆ—
    function whiteMidisInGroup(){
      const arr=[];
      for(let m=currentLow(); m<=currentHigh(); m++){
        if(!isBlackPC(m%12)) arr.push(m);
      }
      return arr;
    }
    // åªä½¿ç”¨ç™½éµæŒ‘é¸ä¸€çµ„éŸ³ç¨‹ï¼ˆä¸Šè¡Œ/ä¸‹è¡Œ/å’Œè²ï¼‰ï¼›è‹¥ç„¡æ³•æ‰¾åˆ°å‰‡å›å‚³ null
    function pickIntervalWithWhite(kind){
      const whites = whiteMidisInGroup();
      const whiteSet = new Set(whites);
      const intervals = shuffle(INTERVALS); // éš¨æ©Ÿå˜—è©¦ä¸åŒéŸ³ç¨‹
      for(const intv of intervals){
        if(kind==='up'){
          const candidates = whites.filter(m => (m + intv.st) <= currentHigh() && whiteSet.has(m + intv.st));
          if(candidates.length){
            const base = candidates[randInt(0, candidates.length-1)];
            return { intv, base, other: base + intv.st };
          }
        }else if(kind==='down'){
          const candidates = whites.filter(m => (m - intv.st) >= currentLow() && whiteSet.has(m - intv.st));
          if(candidates.length){
            const base = candidates[randInt(0, candidates.length-1)];
            return { intv, base, other: base - intv.st };
          }
        }else if(kind==='harm'){
          // å’Œè²æ¨¡å¼ï¼šbaseæ˜¯è¼ƒä½çš„éŸ³ï¼Œotheræ˜¯è¼ƒé«˜çš„éŸ³ï¼ˆbase + intv.stï¼‰ï¼Œå…©å€‹éŸ³åŒæ™‚æ’­æ”¾
          const candidates = whites.filter(m => (m + intv.st) <= currentHigh() && whiteSet.has(m + intv.st));
          if(candidates.length){
            const base = candidates[randInt(0, candidates.length-1)];
            return { intv, base, other: base + intv.st };
          }
        }
      }
      return null;
    }

    // å–®éŸ³ï¼šå…ˆæ’­ 3 æ¬¡ Cï¼Œå†æ’­é¡Œç›®éŸ³ï¼›æ’­æ”¾æ™‚ä¸äº®éµ
    function genNoteQuestion(){
      const ans = randomMidiInGroup();
      function play(){
        ensureAudio();
        const ref = currentLow();       // è©²çµ„ C
        const refDur = 600, refGap = 0.15;
        const questionDur = 1000; // é¢˜ç›®éŸ³æ’­æ”¾æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
        
        // æ˜¾ç¤ºå‚è€ƒéŸ³æç¤º
        updateStatusHint(hintRefEl, true);
        
        for (let i=0;i<3;i++){
          const when = i*(refDur/1000 + refGap);
          playTone(midiToFreq(ref), refDur, state.wave, 10, when);
        }
        
        // è®¡ç®—é¢˜ç›®éŸ³å¼€å§‹æ’­æ”¾çš„æ—¶é—´ï¼ˆç§’ï¼‰
        const qWhen = 3*(refDur/1000 + refGap);
        const qWhenMs = qWhen * 1000;
        
        // åœ¨é¢˜ç›®éŸ³æ’­æ”¾æ—¶ï¼Œåˆ‡æ¢æç¤ºå­—
        setTimeout(() => {
          updateStatusHint(hintQuestionEl, true);
        }, qWhenMs);
        
        playTone(midiToFreq(ans), questionDur, state.wave, 15, qWhen);
        solfegeEl.innerHTML = 'ç­”æ¡ˆï¼šâ€”';
        
        // è¿”å›é¢˜ç›®éŸ³æ’­æ”¾å®Œæˆçš„æ—¶é—´ï¼ˆç›¸å¯¹äº audioCtx.currentTimeï¼‰
        const questionEndTime = qWhen + questionDur / 1000;
        return questionEndTime;
      }
      return {
        type:'note',
        label:'å–®éŸ³ï¼šå…ˆè½ 3 æ¬¡ C åŸºæº–éŸ³ï¼Œä¹‹å¾Œè«‹åœ¨é‹¼ç´ä¸Šé»é¸ç­”æ¡ˆ',
        answerKey:ans,
        options:[],
        play
      };
    }

    const INTERVALS = [
      { st:1, label:'å°äºŒåº¦' },{ st:2, label:'å¤§äºŒåº¦' },{ st:3, label:'å°ä¸‰åº¦' },{ st:4, label:'å¤§ä¸‰åº¦' },
      { st:5, label:'å®Œå…¨å››åº¦' },{ st:6, label:'ä¸‰å…¨éŸ³' },{ st:7, label:'å®Œå…¨äº”åº¦' },{ st:8, label:'å°å…­åº¦' },
      { st:9, label:'å¤§å…­åº¦' },{ st:10,label:'å°ä¸ƒåº¦' },{ st:11,label:'å¤§ä¸ƒåº¦' },{ st:12,label:'å…«åº¦' },
    ];
    const TRIADS = [
      { q:'maj', label:'å¤§ä¸‰å’Œå¼¦', steps:[0,4,7] },
      { q:'min', label:'å°ä¸‰å’Œå¼¦', steps:[0,3,7] },
      { q:'dim', label:'æ¸›ä¸‰å’Œå¼¦', steps:[0,3,6] },
      { q:'aug', label:'å¢ä¸‰å’Œå¼¦', steps:[0,4,8] },
    ];
    const SEVENTHS = [
      { q:'maj7', label:'å¤§ä¸ƒå’Œå¼¦ (maj7)', steps:[0,4,7,11] },
      { q:'7',    label:'å±¬ä¸ƒå’Œå¼¦ (7)',     steps:[0,4,7,10] },
      { q:'min7', label:'å°ä¸ƒå’Œå¼¦ (min7)',  steps:[0,3,7,10] },
      { q:'m7b5', label:'åŠæ¸›ä¸ƒ (m7â™­5)',    steps:[0,3,6,10] },
      { q:'dim7', label:'æ¸›ä¸ƒ (dim7)',       steps:[0,3,6,9]  },
    ];

    function genInterval(kind){
      const low=currentLow(), high=currentHigh();
      let intv, base, other;

      // ç™½éµé™å®šï¼šç¢ºä¿é¡Œç›®åªè½åœ¨ç™½éµï¼Œå¿…è¦æ™‚æ›´æ›éŸ³ç¨‹ä»¥æ»¿è¶³æ¢ä»¶
      if(state.noteScope === 'white' && (kind==='up' || kind==='down' || kind==='harm')){
        const picked = pickIntervalWithWhite(kind);
        if(picked){
          ({ intv, base, other } = picked);
        } else {
          // è‹¥æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ç™½éµçµ„åˆï¼Œå›é€€ç‚ºåŸæœ¬éš¨æ©Ÿé‚è¼¯
          intv = shuffle(INTERVALS)[0];
        }
      }
      if(!intv){
        intv = shuffle(INTERVALS)[0];
      }

      if(base === undefined || other === undefined){
        // å¦‚æœè®¾ç½®äº†ç™½é”®é™å®šï¼Œç¡®ä¿ç”Ÿæˆçš„éŸ³éƒ½æ˜¯ç™½é”®
        if(state.noteScope === 'white'){
          const whites = whiteMidisInGroup();
          const whiteSet = new Set(whites);
          if(kind==='up'){
            // ä¸Šè¡Œï¼šbaseæ˜¯ä½éŸ³ï¼Œotheræ˜¯é«˜éŸ³ï¼ˆbase + intv.stï¼‰
            const candidates = whites.filter(m => (m + intv.st) <= high && whiteSet.has(m + intv.st));
            if(candidates.length){
              base = candidates[randInt(0, candidates.length-1)];
              other = base + intv.st;
            } else {
              // å¦‚æœæ‰¾ä¸åˆ°ç¬¦åˆæ¡ä»¶çš„ç™½é”®ç»„åˆï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨çš„ç™½é”®ä½œä¸ºbase
              base = whites[0];
              other = base + intv.st;
            }
          } else if(kind==='down'){
            // ä¸‹è¡Œï¼šbaseæ˜¯é«˜éŸ³ï¼Œotheræ˜¯ä½éŸ³ï¼ˆbase - intv.stï¼‰
            const candidates = whites.filter(m => (m - intv.st) >= low && whiteSet.has(m - intv.st));
            if(candidates.length){
              base = candidates[randInt(0, candidates.length-1)];
              other = base - intv.st;
            } else {
              // å¦‚æœæ‰¾ä¸åˆ°ç¬¦åˆæ¡ä»¶çš„ç™½é”®ç»„åˆï¼Œä½¿ç”¨æœ€åä¸€ä¸ªå¯ç”¨çš„ç™½é”®ä½œä¸ºbase
              base = whites[whites.length-1];
              other = base - intv.st;
            }
          } else {
            // å’Œå£°æ¨¡å¼ï¼šbaseæ˜¯è¾ƒä½çš„éŸ³ï¼Œotheræ˜¯è¾ƒé«˜çš„éŸ³ï¼ˆbase + intv.stï¼‰
            const candidates = whites.filter(m => (m + intv.st) <= high && whiteSet.has(m + intv.st));
            if(candidates.length){
              base = candidates[randInt(0, candidates.length-1)];
              other = base + intv.st;
            } else {
              // å¦‚æœæ‰¾ä¸åˆ°ç¬¦åˆæ¡ä»¶çš„ç™½é”®ç»„åˆï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨çš„ç™½é”®ä½œä¸ºbase
              base = whites[0];
              other = base + intv.st;
            }
          }
        } else {
          // æ²¡æœ‰ç™½é”®é™å®šï¼Œä½¿ç”¨åŸæ¥çš„éšæœºé€»è¾‘
          if(kind==='up'){
            // ä¸Šè¡Œï¼šbaseæ˜¯ä½éŸ³ï¼Œotheræ˜¯é«˜éŸ³ï¼ˆbase + intv.stï¼‰
            base = randInt(low, Math.max(low, high-intv.st));
            other = base + intv.st;
            if(other <= base) other = base + intv.st;
          } else if(kind==='down'){
            // ä¸‹è¡Œï¼šbaseæ˜¯é«˜éŸ³ï¼Œotheræ˜¯ä½éŸ³ï¼ˆbase - intv.stï¼‰
            base = randInt(Math.min(high, low+intv.st), high);
            other = base - intv.st;
            if(other >= base) other = base - intv.st;
          } else {
            base = randInt(low, Math.max(low, high-intv.st));
            other = base + intv.st;
          }
        }
      }

      // å’Œè²éŸ³ç¨‹æ¨¡å¼ï¼šä½¿ç”¨å¾ªç’°æ’­æ”¾å’Œé‹¼ç´éµç›¤ä½œç­”
      if(kind==='harm'){
        const label = 'éŸ³ç¨‹è¾¨è­˜ï¼ˆå’Œè²/åŒæ™‚ï¼‰ï¼šå…ˆè½ 3 æ¬¡åŸºæº–éŸ³ï¼Œä¹‹å¾Œè«‹åœ¨é‹¼ç´ä¸Šé»é¸è¼ƒä½çš„éŸ³';
        // ä¿å­˜åŸºæº–éŸ³ã€ç›®æ¨™éŸ³å’ŒéŸ³ç¨‹æ­¥æ•¸
        // ç”¨æˆ¶éœ€è¦é»æ“ŠbaseéŸ³ï¼ˆè¼ƒä½çš„éŸ³ï¼‰ä¾†ä½œç­”
        const answerKey = base; // baseéŸ³çš„MIDIå€¼
        const baseMidi = base;
        const otherMidi = other;
        const intervalSteps = intv.st; // æ­£ç¢ºçš„éŸ³ç¨‹æ­¥æ•¸

        function play(){
          ensureAudio();
          const refDur = 600, refGap = 0.15;
          const refMidi = currentLow(); // åƒè€ƒéŸ³æ°¸é æ˜¯ C
          const questionDur = 1100; // é¢˜ç›®éŸ³æ’­æ”¾æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
          
          // æ˜¾ç¤ºå‚è€ƒéŸ³æç¤º
          updateStatusHint(hintRefEl, true);
          
          // å…ˆæ’­æ”¾åƒè€ƒéŸ³ C 3æ¬¡ï¼ˆå¾ªç’°æ’­æ”¾ï¼‰
          for (let i=0;i<3;i++){
            const when = i*(refDur/1000 + refGap);
            playTone(midiToFreq(refMidi), refDur, state.wave, 10, when);
          }
          
          // è®¡ç®—é¢˜ç›®éŸ³å¼€å§‹æ’­æ”¾çš„æ—¶é—´ï¼ˆç§’ï¼‰
          // åœ¨3æ¬¡åƒè€ƒéŸ³æ’­æ”¾å®Œå¾Œï¼Œç¨ç­‰ç‰‡åˆ»å†æ’­æ”¾é¡Œç›®éŸ³ï¼Œé¿å…éŸ³é »é‡ç–Š
          const gapAfterRef = 0.2; // åƒè€ƒéŸ³å’Œé¡Œç›®éŸ³ä¹‹é–“çš„é–“éš”
          const qWhen = 3*(refDur/1000 + refGap) + gapAfterRef;
          const qWhenMs = qWhen * 1000;
          
          // åœ¨é¢˜ç›®éŸ³æ’­æ”¾æ—¶ï¼Œåˆ‡æ¢æç¤ºå­—
          setTimeout(() => {
            updateStatusHint(hintQuestionEl, true);
          }, qWhenMs);
          
          // æ’­æ”¾é¡Œç›®éŸ³ï¼šåŒæ™‚æ’­æ”¾baseå’Œotherï¼ˆå’Œè²éŸ³ç¨‹ï¼‰
          // æ’­æ”¾é¡Œç›®éŸ³æ™‚ä¸äº®é‹¼ç´éµï¼Œåªæœ‰åœ¨æ’­æ”¾ç­”æ¡ˆéŸ³æ™‚æ‰äº®
          const bf=midiToFreq(base), of=midiToFreq(other);
          playTone(bf, questionDur, state.wave, 15, qWhen);
          playTone(of, questionDur, state.wave, 15, qWhen);
          solfegeEl.innerHTML = 'ç­”æ¡ˆï¼šâ€”';
          
          // è¿”å›é¢˜ç›®éŸ³æ’­æ”¾å®Œæˆçš„æ—¶é—´ï¼ˆç›¸å¯¹äº audioCtx.currentTimeï¼‰
          const questionEndTime = qWhen + questionDur / 1000;
          return questionEndTime;
        }
        return { 
          type:'interval_harm', 
          label, 
          answerKey:answerKey, // baseéŸ³MIDIå€¼
          baseMidi:baseMidi, // åŸºæº–éŸ³MIDIå€¼
          otherMidi:otherMidi, // ç›®æ¨™éŸ³MIDIå€¼
          intervalSteps:intervalSteps, // æ­£ç¢ºéŸ³ç¨‹æ­¥æ•¸
          options:[], 
          play 
        };
      }

      // ä¸Šè¡Œ/ä¸‹è¡Œæ¨¡å¼ï¼šä½¿ç”¨å¾ªç’°æ’­æ”¾å’Œé‹¼ç´éµç›¤ä½œç­”
      const label = kind==='up'?'éŸ³ç¨‹è¾¨è­˜ï¼ˆä¸Šè¡Œï¼‰ï¼šå…ˆè½ 3 æ¬¡åŸºæº–éŸ³ï¼Œä¹‹å¾Œè«‹åœ¨é‹¼ç´ä¸Šé»é¸ç›®æ¨™éŸ³':kind==='down'?'éŸ³ç¨‹è¾¨è­˜ï¼ˆä¸‹è¡Œï¼‰ï¼šå…ˆè½ 3 æ¬¡åŸºæº–éŸ³ï¼Œä¹‹å¾Œè«‹åœ¨é‹¼ç´ä¸Šé»é¸ç›®æ¨™éŸ³':'è«‹è¾¨è­˜éŸ³ç¨‹ï¼ˆå’Œè²/åŒæ™‚ï¼‰';
      
      // å°æ–¼ä¸Šè¡Œï¼šbaseæ˜¯ä½éŸ³ï¼Œotheræ˜¯é«˜éŸ³ï¼ˆbase + intv.stï¼‰
      // å°æ–¼ä¸‹è¡Œï¼šbaseæ˜¯é«˜éŸ³ï¼Œotheræ˜¯ä½éŸ³ï¼ˆbase - intv.stï¼‰
      // ä½†ç‚ºäº†è®“æ’­æ”¾é †åºæ›´æ¸…æ™°ï¼Œæˆ‘å€‘éœ€è¦ç¢ºä¿ï¼š
      // ä¸Šè¡Œï¼šå…ˆæ’­æ”¾ä½éŸ³ï¼ˆbaseï¼‰ï¼Œå†æ’­æ”¾é«˜éŸ³ï¼ˆotherï¼‰
      // ä¸‹è¡Œï¼šå…ˆæ’­æ”¾é«˜éŸ³ï¼ˆbaseï¼‰ï¼Œå†æ’­æ”¾ä½éŸ³ï¼ˆotherï¼‰
      
      // ä¿å­˜åŸºæº–éŸ³ã€ç›®æ¨™éŸ³å’ŒéŸ³ç¨‹æ­¥æ•¸
      const answerKey = other; // ç›®æ¨™éŸ³çš„MIDIå€¼
      const baseMidi = base;
      const intervalSteps = intv.st; // æ­£ç¢ºçš„éŸ³ç¨‹æ­¥æ•¸

      function play(){
        ensureAudio();
        const refDur = 600, refGap = 0.15;
        const refMidi = currentLow(); // åƒè€ƒéŸ³æ°¸é æ˜¯ C
        const firstNoteDur = 600; // ç¬¬ä¸€ä¸ªéŸ³æ’­æ”¾æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
        const secondNoteDur = 1000; // ç¬¬äºŒä¸ªéŸ³æ’­æ”¾æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
        const gapBetweenNotes = 0.7; // ä¸¤ä¸ªéŸ³ä¹‹é—´çš„é—´éš”ï¼ˆç§’ï¼‰
        
        // æ˜¾ç¤ºå‚è€ƒéŸ³æç¤º
        updateStatusHint(hintRefEl, true);
        
        // å…ˆæ’­æ”¾åƒè€ƒéŸ³ C 3æ¬¡ï¼ˆå¾ªç’°æ’­æ”¾ï¼‰
        for (let i=0;i<3;i++){
          const when = i*(refDur/1000 + refGap);
          playTone(midiToFreq(refMidi), refDur, state.wave, 10, when);
        }
        
        // è®¡ç®—é¢˜ç›®éŸ³å¼€å§‹æ’­æ”¾çš„æ—¶é—´ï¼ˆç§’ï¼‰
        // åœ¨3æ¬¡åƒè€ƒéŸ³æ’­æ”¾å®Œå¾Œï¼Œç¨ç­‰ç‰‡åˆ»å†æ’­æ”¾é¡Œç›®éŸ³ï¼Œé¿å…éŸ³é »é‡ç–Š
        const gapAfterRef = 0.2; // åƒè€ƒéŸ³å’Œé¡Œç›®éŸ³ä¹‹é–“çš„é–“éš”
        const qWhen = 3*(refDur/1000 + refGap) + gapAfterRef;
        const qWhenMs = qWhen * 1000;
        
        // åœ¨é¢˜ç›®éŸ³æ’­æ”¾æ—¶ï¼Œåˆ‡æ¢æç¤ºå­—
        setTimeout(() => {
          updateStatusHint(hintQuestionEl, true);
        }, qWhenMs);
        
        // æ’­æ”¾é¡Œç›®éŸ³ï¼šå…ˆæ’­æ”¾é¡Œç›®éŸ³çš„ç¬¬ä¸€å€‹éŸ³ï¼ˆbaseï¼‰ï¼Œå†æ’­æ”¾é¡Œç›®éŸ³çš„ç¬¬äºŒå€‹éŸ³ï¼ˆotherï¼‰
        // ä¸Šè¡Œï¼šbaseï¼ˆä½ï¼‰â†’ otherï¼ˆé«˜ï¼‰ï¼›ä¸‹è¡Œï¼šbaseï¼ˆé«˜ï¼‰â†’ otherï¼ˆä½ï¼‰
        // æ’­æ”¾é¡Œç›®éŸ³æ™‚ä¸äº®é‹¼ç´éµï¼Œåªæœ‰åœ¨æ’­æ”¾ç­”æ¡ˆéŸ³æ™‚æ‰äº®
        playTone(midiToFreq(base), firstNoteDur, state.wave, 15, qWhen);
        playTone(midiToFreq(other), secondNoteDur, state.wave, 15, qWhen + gapBetweenNotes);
        solfegeEl.innerHTML = 'ç­”æ¡ˆï¼šâ€”';
        
        // è¿”å›é¢˜ç›®éŸ³æ’­æ”¾å®Œæˆçš„æ—¶é—´ï¼ˆç›¸å¯¹äº audioCtx.currentTimeï¼‰
        // ç¬¬äºŒä¸ªéŸ³å¼€å§‹æ—¶é—´ + ç¬¬äºŒä¸ªéŸ³æ’­æ”¾æ—¶é•¿
        const questionEndTime = qWhen + gapBetweenNotes + secondNoteDur / 1000;
        return questionEndTime;
      }
      return { 
        type:'interval_'+kind, 
        label, 
        answerKey:answerKey, // ç›®æ¨™éŸ³MIDIå€¼
        baseMidi:baseMidi, // åŸºæº–éŸ³MIDIå€¼
        intervalSteps:intervalSteps, // æ­£ç¢ºéŸ³ç¨‹æ­¥æ•¸
        options:[], 
        play 
      };
    }
    function chooseRoot(steps){
      const low=currentLow(), high=currentHigh();
      // å¦‚æœè®¾ç½®äº†ç™½é”®é™å®šï¼Œç¡®ä¿æ ¹éŸ³å’Œæ‰€æœ‰å’Œå¼¦éŸ³éƒ½æ˜¯ç™½é”®
      if(state.noteScope === 'white'){
        const whites = whiteMidisInGroup();
        const whiteSet = new Set(whites);
        // è¿‡æ»¤å‡ºæ‰€æœ‰æ ¹éŸ³å€™é€‰ï¼Œä½¿å¾—æ ¹éŸ³å’Œæ‰€æœ‰å’Œå¼¦éŸ³éƒ½æ˜¯ç™½é”®
        const candidates = whites.filter(root => {
          return steps.every(step => {
            const tone = root + step;
            return tone <= high && whiteSet.has(tone);
          });
        });
        if(candidates.length > 0){
          return candidates[randInt(0, candidates.length-1)];
        }
        // å¦‚æœæ‰¾ä¸åˆ°ç¬¦åˆæ¡ä»¶çš„ç™½é”®ç»„åˆï¼Œè¿”å› nullï¼ˆè®©è°ƒç”¨è€…å¤„ç†ï¼‰
        return null;
      }
      return randInt(low, Math.max(low, high - Math.max(...steps)));
    }
    function genTriad(){ 
      // å¦‚æœè®¾ç½®äº†ç™½é”®é™å®šï¼Œéœ€è¦ç¡®ä¿æ‰¾åˆ°æ‰€æœ‰éŸ³éƒ½æ˜¯ç™½é”®çš„å’Œå¼¦
      let t, r, tones, inversion = 0; // inversion: 0=åŸä½, 1=ç¬¬ä¸€è½¬ä½, 2=ç¬¬äºŒè½¬ä½
      
      // éšæœºé€‰æ‹©è½¬ä½
      inversion = randInt(0, 2);
      
      if(state.noteScope === 'white'){
        const whiteSet = new Set(whiteMidisInGroup());
        const shuffledTriads = shuffle(TRIADS);
        let found = false;
        // å°è¯•æ‰€æœ‰ä¸‰å’Œå¼¦ç±»å‹å’Œè½¬ä½ï¼Œç›´åˆ°æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„
        for(const triad of shuffledTriads){
          for(let inv = 0; inv <= 2; inv++){
            // è®¡ç®—è½¬ä½åçš„æ­¥æ•°
            let invertedSteps = [...triad.steps];
            if(inv === 1){
              // ç¬¬ä¸€è½¬ä½ï¼šä¸‰éŸ³åœ¨æœ€ä½ (4,7,12)
              invertedSteps = [triad.steps[1], triad.steps[2], triad.steps[0] + 12];
            } else if(inv === 2){
              // ç¬¬äºŒè½¬ä½ï¼šäº”éŸ³åœ¨æœ€ä½ (7,12,16)
              invertedSteps = [triad.steps[2], triad.steps[0] + 12, triad.steps[1] + 12];
            }
            
            const candidates = whiteMidisInGroup().filter(root => {
              return invertedSteps.every(step => {
                const tone = root + step;
                return tone <= currentHigh() && whiteSet.has(tone);
              });
            });
            if(candidates.length > 0){
              t = triad;
              r = candidates[randInt(0, candidates.length-1)];
              inversion = inv;
              tones = invertedSteps.map(s=>r+s);
              found = true;
              break;
            }
          }
          if(found) break;
        }
        // å¦‚æœæ‰¾ä¸åˆ°ç¬¦åˆæ¡ä»¶çš„ï¼Œå°è¯•æ‰€æœ‰å¯èƒ½çš„æ ¹éŸ³å’Œå’Œå¼¦ç»„åˆ
        if(!found){
          // éå†æ‰€æœ‰ä¸‰å’Œå¼¦ç±»å‹å’Œæ‰€æœ‰å¯èƒ½çš„ç™½é”®æ ¹éŸ³
          for(const triad of shuffledTriads){
            for(const root of whiteMidisInGroup()){
              for(let inv = 0; inv <= 2; inv++){
                let invertedSteps = [...triad.steps];
                if(inv === 1){
                  invertedSteps = [triad.steps[1], triad.steps[2], triad.steps[0] + 12];
                } else if(inv === 2){
                  invertedSteps = [triad.steps[2], triad.steps[0] + 12, triad.steps[1] + 12];
                }
                const testTones = invertedSteps.map(s=>root+s);
                // æ£€æŸ¥æ‰€æœ‰éŸ³æ˜¯å¦éƒ½æ˜¯ç™½é”®ä¸”åœ¨èŒƒå›´å†…
                if(testTones.every(tone => {
                  const pc = tone % 12;
                  return tone <= currentHigh() && !isBlackPC(pc) && whiteSet.has(tone);
                })){
                  t = triad;
                  r = root;
                  inversion = inv;
                  tones = testTones;
                  found = true;
                  break;
                }
              }
              if(found) break;
            }
            if(found) break;
          }
          // å¦‚æœè¿˜æ˜¯æ‰¾ä¸åˆ°ï¼Œä½¿ç”¨åŸä½å’Œå¼¦
          if(!found){
            t = shuffledTriads[0];
            const whites = whiteMidisInGroup();
            r = whites[0] || currentLow();
            inversion = 0;
            const allTones = t.steps.map(s=>r+s);
            tones = allTones.filter(tone => {
              const pc = tone % 12;
              return tone <= currentHigh() && !isBlackPC(pc) && whiteSet.has(tone);
            });
            // å¦‚æœè¿‡æ»¤åæ²¡æœ‰è¶³å¤Ÿçš„éŸ³ï¼Œè‡³å°‘ä¿è¯æ ¹éŸ³æ˜¯ç™½é”®
            if(tones.length < 2){
              tones = [r];
            }
          }
        }
      } else {
        t=shuffle(TRIADS)[0]; 
        r=chooseRoot(t.steps); 
        inversion = randInt(0, 2);
        // è®¡ç®—è½¬ä½åçš„æ­¥æ•°
        let invertedSteps = [...t.steps];
        if(inversion === 1){
          invertedSteps = [t.steps[1], t.steps[2], t.steps[0] + 12];
        } else if(inversion === 2){
          invertedSteps = [t.steps[2], t.steps[0] + 12, t.steps[1] + 12];
        }
        tones = invertedSteps.map(s=>r+s);
        // ç¡®ä¿æ‰€æœ‰éŸ³éƒ½åœ¨èŒƒå›´å†…
        tones = tones.filter(tone => tone <= currentHigh());
      }
      // æœ€ç»ˆéªŒè¯ï¼šå¦‚æœè®¾ç½®äº†ç™½é”®é™å®šï¼Œç¡®ä¿æ‰€æœ‰éŸ³éƒ½æ˜¯ç™½é”®
      if(state.noteScope === 'white'){
        const whiteSet = new Set(whiteMidisInGroup());
        tones = tones.filter(tone => {
          const pc = tone % 12;
          return tone <= currentHigh() && !isBlackPC(pc) && whiteSet.has(tone);
        });
        // å¦‚æœè¿‡æ»¤åæ²¡æœ‰è¶³å¤Ÿçš„éŸ³ï¼Œè‡³å°‘ä¿ç•™æ ¹éŸ³
        if(tones.length < 2){
          tones = [r];
        }
      }
      
      // è½¬ä½åçš„ç­”æ¡ˆé”®æ˜¯æœ€ä½éŸ³ï¼ˆè½¬ä½åçš„æ ¹éŸ³ä½ç½®ï¼‰
      const answerKey = Math.min(...tones);
      
      const freqs=tones.map(midiToFreq);
      const options = shuffle(TRIADS).map(x=>({key:x.q, text:x.label}));
      
      function play(){
        ensureAudio();
        const refDur = 600, refGap = 0.15;
        const refMidi = currentLow(); // åƒè€ƒéŸ³æ°¸é æ˜¯ C
        const questionDur = 1100; // é¢˜ç›®éŸ³æ’­æ”¾æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
        
        // æ˜¾ç¤ºå‚è€ƒéŸ³æç¤º
        updateStatusHint(hintRefEl, true);
        
        // å…ˆæ’­æ”¾åƒè€ƒéŸ³ C 3æ¬¡ï¼ˆå¾ªç’°æ’­æ”¾ï¼‰
        for (let i=0;i<3;i++){
          const when = i*(refDur/1000 + refGap);
          playTone(midiToFreq(refMidi), refDur, state.wave, 10, when);
        }
        
        // è®¡ç®—é¢˜ç›®éŸ³å¼€å§‹æ’­æ”¾çš„æ—¶é—´ï¼ˆç§’ï¼‰
        // åœ¨3æ¬¡åƒè€ƒéŸ³æ’­æ”¾å®Œå¾Œï¼Œç¨ç­‰ç‰‡åˆ»å†æ’­æ”¾é¡Œç›®éŸ³ï¼Œé¿å…éŸ³é »é‡ç–Š
        const gapAfterRef = 0.2; // åƒè€ƒéŸ³å’Œé¡Œç›®éŸ³ä¹‹é–“çš„é–“éš”
        const qWhen = 3*(refDur/1000 + refGap) + gapAfterRef;
        const qWhenMs = qWhen * 1000;
        
        // åœ¨é¢˜ç›®éŸ³æ’­æ”¾æ—¶ï¼Œåˆ‡æ¢æç¤ºå­—
        setTimeout(() => {
          updateStatusHint(hintQuestionEl, true);
        }, qWhenMs);
        
        // æ’­æ”¾é¡Œç›®éŸ³ï¼šå…ˆæ’­æ”¾åˆ†è§£å’Œå¼¦ï¼Œå†æ’­æ”¾å’Œè²
        // æ’­æ”¾é¡Œç›®éŸ³æ™‚ä¸äº®é‹¼ç´éµï¼Œåªæœ‰åœ¨æ’­æ”¾ç­”æ¡ˆéŸ³æ™‚æ‰äº®
        const arpeggioNoteDur = 300; // åˆ†è§£å’Œå¼¦æ¯ä¸ªéŸ³çš„æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
        const arpeggioGap = 0.1; // åˆ†è§£å’Œå¼¦éŸ³ä¹‹é—´çš„é—´éš”ï¼ˆç§’ï¼‰
        const harmonyDur = 800; // å’Œå£°æ’­æ”¾æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
        
        // å…ˆæ’­æ”¾åˆ†è§£å’Œå¼¦ï¼ˆæŒ‰é¡ºåºæ’­æ”¾æ¯ä¸ªéŸ³ï¼‰
        tones.forEach((tone, index) => {
          const when = qWhen + index * (arpeggioNoteDur/1000 + arpeggioGap);
          playTone(midiToFreq(tone), arpeggioNoteDur, state.wave, 15, when);
        });
        
        // å†æ’­æ”¾å’Œå£°ï¼ˆåŒæ—¶æ’­æ”¾æ‰€æœ‰éŸ³ï¼‰
        const harmonyWhen = qWhen + tones.length * (arpeggioNoteDur/1000 + arpeggioGap) + 0.15;
        freqs.forEach(f => playTone(f, harmonyDur, state.wave, 15, harmonyWhen));
        
        solfegeEl.innerHTML = 'ç­”æ¡ˆï¼šâ€”';
        
        // è¿”å›é¢˜ç›®éŸ³æ’­æ”¾å®Œæˆçš„æ—¶é—´ï¼ˆç›¸å¯¹äº audioCtx.currentTimeï¼‰
        const questionEndTime = harmonyWhen + harmonyDur / 1000;
        return questionEndTime;
      }
      
      return { 
        type:'triad', 
        label:'å’Œå¼¦è¾¨è­˜ï¼ˆä¸‰å’Œå¼¦ï¼‰ï¼šå…ˆè½ 3 æ¬¡åŸºæº–éŸ³ï¼Œä¹‹å¾Œè«‹åœ¨é‹¼ç´ä¸Šé»é¸æœ€ä½éŸ³', 
        answerKey:answerKey, // è½¬ä½åçš„æœ€ä½éŸ³MIDIå€¼ï¼Œç”¨äºé’¢ç´ä½œç­”
        rootMidi:r, // æ ¹éŸ³MIDIå€¼ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
        chordType:t.q, // å’Œå¼¦ç±»å‹ï¼ˆ'maj', 'min', 'dim', 'aug'ï¼‰
        inversion:inversion, // è½¬ä½ï¼š0=åŸä½, 1=ç¬¬ä¸€è½¬ä½, 2=ç¬¬äºŒè½¬ä½
        options, 
        tones, // ä¿å­˜å’Œå¼¦çš„æ‰€æœ‰éŸ³ï¼Œç”¨äºç­”å¯¹æ—¶é«˜äº®é’¢ç´é”®
        play 
      };
    }
    function genSeventh(){ 
      // å¦‚æœè®¾ç½®äº†ç™½é”®é™å®šï¼Œéœ€è¦ç¡®ä¿æ‰¾åˆ°æ‰€æœ‰éŸ³éƒ½æ˜¯ç™½é”®çš„å’Œå¼¦
      let s, r, tones, inversion = 0; // inversion: 0=åŸä½, 1=ç¬¬ä¸€è½¬ä½, 2=ç¬¬äºŒè½¬ä½, 3=ç¬¬ä¸‰è½¬ä½
      
      // éšæœºé€‰æ‹©è½¬ä½
      inversion = randInt(0, 3);
      
      if(state.noteScope === 'white'){
        const whiteSet = new Set(whiteMidisInGroup());
        const shuffledSevenths = shuffle(SEVENTHS);
        let found = false;
        // å°è¯•æ‰€æœ‰ä¸ƒå’Œå¼¦ç±»å‹å’Œè½¬ä½ï¼Œç›´åˆ°æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„
        for(const seventh of shuffledSevenths){
          for(let inv = 0; inv <= 3; inv++){
            // è®¡ç®—è½¬ä½åçš„æ­¥æ•°
            let invertedSteps = [...seventh.steps];
            if(inv === 1){
              // ç¬¬ä¸€è½¬ä½ï¼šä¸‰éŸ³åœ¨æœ€ä½ (4,7,11,12)
              invertedSteps = [seventh.steps[1], seventh.steps[2], seventh.steps[3], seventh.steps[0] + 12];
            } else if(inv === 2){
              // ç¬¬äºŒè½¬ä½ï¼šäº”éŸ³åœ¨æœ€ä½ (7,11,12,16)
              invertedSteps = [seventh.steps[2], seventh.steps[3], seventh.steps[0] + 12, seventh.steps[1] + 12];
            } else if(inv === 3){
              // ç¬¬ä¸‰è½¬ä½ï¼šä¸ƒéŸ³åœ¨æœ€ä½ (11,12,16,19)
              invertedSteps = [seventh.steps[3], seventh.steps[0] + 12, seventh.steps[1] + 12, seventh.steps[2] + 12];
            }
            
            const candidates = whiteMidisInGroup().filter(root => {
              return invertedSteps.every(step => {
                const tone = root + step;
                return tone <= currentHigh() && whiteSet.has(tone);
              });
            });
            if(candidates.length > 0){
              s = seventh;
              r = candidates[randInt(0, candidates.length-1)];
              inversion = inv;
              tones = invertedSteps.map(x=>r+x);
              found = true;
              break;
            }
          }
          if(found) break;
        }
        // å¦‚æœæ‰¾ä¸åˆ°ç¬¦åˆæ¡ä»¶çš„ï¼Œå°è¯•æ‰€æœ‰å¯èƒ½çš„æ ¹éŸ³å’Œå’Œå¼¦ç»„åˆ
        if(!found){
          // éå†æ‰€æœ‰ä¸ƒå’Œå¼¦ç±»å‹å’Œæ‰€æœ‰å¯èƒ½çš„ç™½é”®æ ¹éŸ³
          for(const seventh of shuffledSevenths){
            for(const root of whiteMidisInGroup()){
              for(let inv = 0; inv <= 3; inv++){
                let invertedSteps = [...seventh.steps];
                if(inv === 1){
                  invertedSteps = [seventh.steps[1], seventh.steps[2], seventh.steps[3], seventh.steps[0] + 12];
                } else if(inv === 2){
                  invertedSteps = [seventh.steps[2], seventh.steps[3], seventh.steps[0] + 12, seventh.steps[1] + 12];
                } else if(inv === 3){
                  invertedSteps = [seventh.steps[3], seventh.steps[0] + 12, seventh.steps[1] + 12, seventh.steps[2] + 12];
                }
                const testTones = invertedSteps.map(x=>root+x);
                // æ£€æŸ¥æ‰€æœ‰éŸ³æ˜¯å¦éƒ½æ˜¯ç™½é”®ä¸”åœ¨èŒƒå›´å†…
                if(testTones.every(tone => {
                  const pc = tone % 12;
                  return tone <= currentHigh() && !isBlackPC(pc) && whiteSet.has(tone);
                })){
                  s = seventh;
                  r = root;
                  inversion = inv;
                  tones = testTones;
                  found = true;
                  break;
                }
              }
              if(found) break;
            }
            if(found) break;
          }
          // å¦‚æœè¿˜æ˜¯æ‰¾ä¸åˆ°ï¼Œä½¿ç”¨åŸä½å’Œå¼¦
          if(!found){
            s = shuffledSevenths[0];
            const whites = whiteMidisInGroup();
            r = whites[0] || currentLow();
            inversion = 0;
            const allTones = s.steps.map(x=>r+x);
            tones = allTones.filter(tone => {
              const pc = tone % 12;
              return tone <= currentHigh() && !isBlackPC(pc) && whiteSet.has(tone);
            });
            // å¦‚æœè¿‡æ»¤åæ²¡æœ‰è¶³å¤Ÿçš„éŸ³ï¼Œè‡³å°‘ä¿è¯æ ¹éŸ³æ˜¯ç™½é”®
            if(tones.length < 2){
              tones = [r];
            }
          }
        }
      } else {
        s=shuffle(SEVENTHS)[0]; 
        r=chooseRoot(s.steps); 
        inversion = randInt(0, 3);
        // è®¡ç®—è½¬ä½åçš„æ­¥æ•°
        let invertedSteps = [...s.steps];
        if(inversion === 1){
          invertedSteps = [s.steps[1], s.steps[2], s.steps[3], s.steps[0] + 12];
        } else if(inversion === 2){
          invertedSteps = [s.steps[2], s.steps[3], s.steps[0] + 12, s.steps[1] + 12];
        } else if(inversion === 3){
          invertedSteps = [s.steps[3], s.steps[0] + 12, s.steps[1] + 12, s.steps[2] + 12];
        }
        tones = invertedSteps.map(x=>r+x);
        // ç¡®ä¿æ‰€æœ‰éŸ³éƒ½åœ¨èŒƒå›´å†…
        tones = tones.filter(tone => tone <= currentHigh());
      }
      // æœ€ç»ˆéªŒè¯ï¼šå¦‚æœè®¾ç½®äº†ç™½é”®é™å®šï¼Œç¡®ä¿æ‰€æœ‰éŸ³éƒ½æ˜¯ç™½é”®
      if(state.noteScope === 'white'){
        const whiteSet = new Set(whiteMidisInGroup());
        tones = tones.filter(tone => {
          const pc = tone % 12;
          return tone <= currentHigh() && !isBlackPC(pc) && whiteSet.has(tone);
        });
        // å¦‚æœè¿‡æ»¤åæ²¡æœ‰è¶³å¤Ÿçš„éŸ³ï¼Œè‡³å°‘ä¿ç•™æ ¹éŸ³
        if(tones.length < 2){
          tones = [r];
        }
      }
      
      // è½¬ä½åçš„ç­”æ¡ˆé”®æ˜¯æœ€ä½éŸ³ï¼ˆè½¬ä½åçš„æ ¹éŸ³ä½ç½®ï¼‰
      const answerKey = Math.min(...tones);
      
      const freqs=tones.map(midiToFreq);
      const options = shuffle(SEVENTHS).map(x=>({key:x.q, text:x.label}));
      
      function play(){
        ensureAudio();
        const refDur = 600, refGap = 0.15;
        const refMidi = currentLow(); // åƒè€ƒéŸ³æ°¸é æ˜¯ C
        const questionDur = 1200; // é¢˜ç›®éŸ³æ’­æ”¾æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
        
        // æ˜¾ç¤ºå‚è€ƒéŸ³æç¤º
        updateStatusHint(hintRefEl, true);
        
        // å…ˆæ’­æ”¾åƒè€ƒéŸ³ C 3æ¬¡ï¼ˆå¾ªç’°æ’­æ”¾ï¼‰
        for (let i=0;i<3;i++){
          const when = i*(refDur/1000 + refGap);
          playTone(midiToFreq(refMidi), refDur, state.wave, 10, when);
        }
        
        // è®¡ç®—é¢˜ç›®éŸ³å¼€å§‹æ’­æ”¾çš„æ—¶é—´ï¼ˆç§’ï¼‰
        // åœ¨3æ¬¡åƒè€ƒéŸ³æ’­æ”¾å®Œå¾Œï¼Œç¨ç­‰ç‰‡åˆ»å†æ’­æ”¾é¡Œç›®éŸ³ï¼Œé¿å…éŸ³é »é‡ç–Š
        const gapAfterRef = 0.2; // åƒè€ƒéŸ³å’Œé¡Œç›®éŸ³ä¹‹é–“çš„é–“éš”
        const qWhen = 3*(refDur/1000 + refGap) + gapAfterRef;
        const qWhenMs = qWhen * 1000;
        
        // åœ¨é¢˜ç›®éŸ³æ’­æ”¾æ—¶ï¼Œåˆ‡æ¢æç¤ºå­—
        setTimeout(() => {
          updateStatusHint(hintQuestionEl, true);
        }, qWhenMs);
        
        // æ’­æ”¾é¡Œç›®éŸ³ï¼šå…ˆæ’­æ”¾åˆ†è§£å’Œå¼¦ï¼Œå†æ’­æ”¾å’Œè²
        // æ’­æ”¾é¡Œç›®éŸ³æ™‚ä¸äº®é‹¼ç´éµï¼Œåªæœ‰åœ¨æ’­æ”¾ç­”æ¡ˆéŸ³æ™‚æ‰äº®
        const arpeggioNoteDur = 300; // åˆ†è§£å’Œå¼¦æ¯ä¸ªéŸ³çš„æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
        const arpeggioGap = 0.1; // åˆ†è§£å’Œå¼¦éŸ³ä¹‹é—´çš„é—´éš”ï¼ˆç§’ï¼‰
        const harmonyDur = 900; // å’Œå£°æ’­æ”¾æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
        
        // å…ˆæ’­æ”¾åˆ†è§£å’Œå¼¦ï¼ˆæŒ‰é¡ºåºæ’­æ”¾æ¯ä¸ªéŸ³ï¼‰
        tones.forEach((tone, index) => {
          const when = qWhen + index * (arpeggioNoteDur/1000 + arpeggioGap);
          playTone(midiToFreq(tone), arpeggioNoteDur, state.wave, 15, when);
        });
        
        // å†æ’­æ”¾å’Œå£°ï¼ˆåŒæ—¶æ’­æ”¾æ‰€æœ‰éŸ³ï¼‰
        const harmonyWhen = qWhen + tones.length * (arpeggioNoteDur/1000 + arpeggioGap) + 0.15;
        freqs.forEach(f => playTone(f, harmonyDur, state.wave, 15, harmonyWhen));
        
        solfegeEl.innerHTML = 'ç­”æ¡ˆï¼šâ€”';
        
        // è¿”å›é¢˜ç›®éŸ³æ’­æ”¾å®Œæˆçš„æ—¶é—´ï¼ˆç›¸å¯¹äº audioCtx.currentTimeï¼‰
        const questionEndTime = harmonyWhen + harmonyDur / 1000;
        return questionEndTime;
      }
      
      return { 
        type:'seventh', 
        label:'å’Œå¼¦è¾¨è­˜ï¼ˆä¸ƒå’Œå¼¦ï¼‰ï¼šå…ˆè½ 3 æ¬¡åŸºæº–éŸ³ï¼Œä¹‹å¾Œè«‹åœ¨é‹¼ç´ä¸Šé»é¸æœ€ä½éŸ³', 
        answerKey:answerKey, // è½¬ä½åçš„æœ€ä½éŸ³MIDIå€¼ï¼Œç”¨äºé’¢ç´ä½œç­”
        rootMidi:r, // æ ¹éŸ³MIDIå€¼ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
        chordType:s.q, // å’Œå¼¦ç±»å‹ï¼ˆ'maj7', '7', 'min7', 'm7b5', 'dim7'ï¼‰
        inversion:inversion, // è½¬ä½ï¼š0=åŸä½, 1=ç¬¬ä¸€è½¬ä½, 2=ç¬¬äºŒè½¬ä½, 3=ç¬¬ä¸‰è½¬ä½
        options, 
        tones, // ä¿å­˜å’Œå¼¦çš„æ‰€æœ‰éŸ³ï¼Œç”¨äºç­”å¯¹æ—¶é«˜äº®é’¢ç´é”®
        play 
      };
    }

    // ---------- Flow ----------
    function renderAnswers(q){
      answersEl.innerHTML='';
      if (q.type === 'note') {
        const tip = document.createElement('div');
        tip.className = 'hint';
        tip.textContent = 'è«‹ç›´æ¥åœ¨ä¸‹æ–¹é‹¼ç´ä¸Šé»é¸ä½ è½åˆ°çš„éŸ³é«˜';
        answersEl.appendChild(tip);
        return;
      }
      // éŸ³ç¨‹è¾¨è­˜ï¼ˆä¸Šè¡Œ/ä¸‹è¡Œï¼‰ä¹Ÿç”¨é‹¼ç´éµç›¤ä½œç­”
      if (q.type === 'interval_up' || q.type === 'interval_down') {
        const tip = document.createElement('div');
        tip.className = 'hint';
        tip.textContent = 'è«‹ç›´æ¥åœ¨ä¸‹æ–¹é‹¼ç´ä¸Šé»é¸ä½ è½åˆ°çš„ç›®æ¨™éŸ³';
        answersEl.appendChild(tip);
        return;
      }
      // éŸ³ç¨‹è¾¨è­˜ï¼ˆå’Œè²/åŒæ™‚ï¼‰ä¹Ÿç”¨é‹¼ç´éµç›¤ä½œç­”
      if (q.type === 'interval_harm') {
        const tip = document.createElement('div');
        tip.className = 'hint';
        tip.textContent = 'è«‹ç›´æ¥åœ¨ä¸‹æ–¹é‹¼ç´ä¸Šé»é¸ä½ è½åˆ°çš„è¼ƒä½çš„éŸ³';
        answersEl.appendChild(tip);
        return;
      }
      // ä¸‰å’Œå¼¦è¾¨è­˜ä¹Ÿç”¨é‹¼ç´éµç›¤ä½œç­”
      if (q.type === 'triad') {
        const tip = document.createElement('div');
        tip.className = 'hint';
        tip.textContent = 'è«‹ç›´æ¥åœ¨ä¸‹æ–¹é‹¼ç´ä¸Šé»é¸ä½ è½åˆ°çš„æ ¹éŸ³';
        answersEl.appendChild(tip);
        return;
      }
      // ä¸ƒå’Œå¼¦è¾¨è­˜ä¹Ÿç”¨é‹¼ç´éµç›¤ä½œç­”
      if (q.type === 'seventh') {
        const tip = document.createElement('div');
        tip.className = 'hint';
        tip.textContent = 'è«‹ç›´æ¥åœ¨ä¸‹æ–¹é‹¼ç´ä¸Šé»é¸ä½ è½åˆ°çš„æ ¹éŸ³';
        answersEl.appendChild(tip);
        return;
      }
      // å…¶ä»–æ¨¡å¼ä»ç”¨é¸é …æŒ‰éˆ•ï¼ˆç›®å‰æ²¡æœ‰å…¶ä»–æ¨¡å¼ï¼‰
      q.options.forEach(opt=>{
        const b=document.createElement('button');
        b.className='answer-btn';
        b.textContent=opt.text;
        b.addEventListener('click',()=>submitAnswer(opt.key));
        answersEl.appendChild(b);
      });
    }
    // ---------- Auto reveal (å–®éŸ³) ----------
    let __revealTimerId = null;
    let __speechActivated = false; // æ ‡è®°è¯­éŸ³æ˜¯å¦å·²æ¿€æ´»ï¼ˆç§»åŠ¨ç«¯éœ€è¦ç”¨æˆ·äº¤äº’ï¼‰
    let __speechTestAttempts = 0; // è¯­éŸ³æµ‹è¯•å°è¯•æ¬¡æ•°
    const MAX_SPEECH_TEST_ATTEMPTS = 3; // æœ€å¤šå°è¯•3æ¬¡æ¿€æ´»
    
    // æ£€æŸ¥æ˜¯å¦æ”¯æŒè¯­éŸ³åˆæˆ
    function isSpeechSynthesisSupported(){
      return typeof speechSynthesis !== 'undefined' && speechSynthesis !== null;
    }
    
    // æ£€æŸ¥è¯­éŸ³æ˜¯å¦çœŸçš„å¯ç”¨ï¼ˆç§»åŠ¨ç«¯å¯èƒ½æ”¯æŒä½†å®é™…ä¸å¯ç”¨ï¼‰
    function isSpeechActuallyAvailable(){
      if(!isSpeechSynthesisSupported()) return false;
      try {
        // æ£€æŸ¥è¯­éŸ³åˆæˆå™¨çŠ¶æ€
        if(speechSynthesis.speaking || speechSynthesis.pending) {
          return true; // å¦‚æœæ­£åœ¨è¯´è¯æˆ–å¾…å¤„ç†ï¼Œè¯´æ˜å¯ç”¨
        }
        // æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨è¯­éŸ³
        const voices = speechSynthesis.getVoices();
        return voices.length > 0;
      } catch(e) {
        return false;
      }
    }
    
    // æ¿€æ´»è¯­éŸ³åŠŸèƒ½ï¼ˆç§»åŠ¨ç«¯éœ€è¦ç”¨æˆ·äº¤äº’åæ‰èƒ½ä½¿ç”¨ï¼‰
    function activateSpeech(force = false){
      if(!isSpeechSynthesisSupported()) return;
      
      // å¦‚æœå·²ç»æ¿€æ´»ä¸”ä¸å¼ºåˆ¶ï¼Œç›´æ¥è¿”å›
      if(__speechActivated && !force) {
        // ä½†è¿˜æ˜¯è¦æ£€æŸ¥æ˜¯å¦çœŸçš„å¯ç”¨
        if(!isSpeechActuallyAvailable() && __speechTestAttempts < MAX_SPEECH_TEST_ATTEMPTS){
          __speechActivated = false; // é‡ç½®çŠ¶æ€ï¼Œé‡æ–°å°è¯•
        } else {
          return;
        }
      }
      
      // é™åˆ¶å°è¯•æ¬¡æ•°
      if(__speechTestAttempts >= MAX_SPEECH_TEST_ATTEMPTS && !force) {
        return;
      }
      
      __speechTestAttempts++;
      
      try {
        // ç§»åŠ¨ç«¯ï¼šå…ˆå–æ¶ˆæ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„è¯­éŸ³
        speechSynthesis.cancel();
        
        // ç­‰å¾…cancelå®Œæˆ
        setTimeout(() => {
          try {
            // ç§»åŠ¨ç«¯ï¼šé€šè¿‡æ’­æ”¾ä¸€ä¸ªéå¸¸çŸ­çš„æµ‹è¯•è¯­éŸ³æ¥æ¿€æ´»è¯­éŸ³åŠŸèƒ½
            // ä½¿ç”¨ä¸€ä¸ªç®€å•çš„å•è¯ï¼Œç¡®ä¿èƒ½è¢«è¯†åˆ«
            const testText = 'a';
            const testUtterance = new SpeechSynthesisUtterance(testText);
            testUtterance.volume = 0.01; // éå¸¸å°çš„éŸ³é‡ï¼Œå‡ ä¹å¬ä¸åˆ°
            testUtterance.rate = 10; // éå¸¸å¿«çš„é€Ÿåº¦ï¼Œå‡ ä¹ç¬é—´å®Œæˆ
            testUtterance.lang = 'en-US';
            
            let activated = false;
            let completed = false;
            
            testUtterance.onstart = () => {
              activated = true;
              __speechActivated = true;
              completed = true;
              // ç«‹å³å–æ¶ˆæµ‹è¯•è¯­éŸ³
              setTimeout(() => {
                try { speechSynthesis.cancel(); } catch(_) {}
              }, 10);
            };
            
            testUtterance.onend = () => {
              if(!activated) {
                __speechActivated = true;
              }
              completed = true;
            };
            
            testUtterance.onerror = (e) => {
              completed = true;
              // æŸäº›é”™è¯¯å¯èƒ½è¡¨ç¤ºè¯­éŸ³åŠŸèƒ½ä¸å¯ç”¨
              if(e.error === 'not-allowed') {
                // æƒé™è¢«æ‹’ç»ï¼Œå¯èƒ½éœ€è¦ç”¨æˆ·æ‰‹åŠ¨å…è®¸
                console.warn('Speech synthesis not allowed, may need user permission');
                // ä¸æ ‡è®°ä¸ºå·²æ¿€æ´»ï¼Œå…è®¸åç»­å°è¯•
                return;
              }
              if(e.error === 'network') {
                // ç½‘ç»œé”™è¯¯ï¼Œå¯èƒ½æ˜¯æš‚æ—¶æ€§çš„
                console.warn('Speech synthesis network error');
                return;
              }
              // å…¶ä»–é”™è¯¯ä¹Ÿæ ‡è®°ä¸ºå·²å°è¯•
              __speechActivated = true;
            };
            
            // æ’­æ”¾æµ‹è¯•è¯­éŸ³
            speechSynthesis.speak(testUtterance);
            
            // è®¾ç½®è¶…æ—¶ï¼Œå¦‚æœ1ç§’å†…æ²¡æœ‰å“åº”ï¼Œä¹Ÿæ ‡è®°ä¸ºå·²å°è¯•
            setTimeout(() => {
              if(!completed) {
                __speechActivated = true;
                try { speechSynthesis.cancel(); } catch(_) {}
              }
            }, 1000);
          } catch(e) {
            console.warn('Speech activation speak error:', e);
            __speechActivated = true; // æ ‡è®°ä¸ºå·²å°è¯•ï¼Œé¿å…é‡å¤å°è¯•
          }
        }, 100); // å¢åŠ å»¶è¿Ÿï¼Œç¡®ä¿cancelå®Œæˆ
      } catch(e) {
        console.warn('Speech activation error:', e);
        __speechActivated = true; // æ ‡è®°ä¸ºå·²å°è¯•ï¼Œé¿å…é‡å¤å°è¯•
      }
    }
    // ç¡®ä¿è¯­éŸ³åˆ—è¡¨å·²åŠ è½½ï¼ˆç§»åŠ¨ç«¯å…¼å®¹ï¼‰
    function ensureVoicesLoaded(callback){
      if(!isSpeechSynthesisSupported()){
        // å¦‚æœä¸æ”¯æŒè¯­éŸ³åˆæˆï¼Œç›´æ¥æ‰§è¡Œå›è°ƒï¼ˆä¸æ’­æ”¾è¯­éŸ³ï¼‰
        if(typeof callback === 'function') callback();
        return;
      }
      
      const voices = speechSynthesis.getVoices();
      if(voices.length > 0){
        callback();
      } else {
        // ç§»åŠ¨ç«¯å¯èƒ½éœ€è¦å¤šæ¬¡å°è¯•
        let attempts = 0;
        const maxAttempts = 10;
        
        const tryLoad = () => {
          attempts++;
          const voices = speechSynthesis.getVoices();
          if(voices.length > 0){
            callback();
          } else if(attempts < maxAttempts){
            // ç§»åŠ¨ç«¯å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´åŠ è½½ï¼Œå»¶è¿Ÿé‡è¯•
            setTimeout(tryLoad, 100);
          } else {
            // è¶…æ—¶åä»ç„¶æ‰§è¡Œå›è°ƒï¼ˆå³ä½¿æ²¡æœ‰è¯­éŸ³ï¼‰
            callback();
          }
        };
        
        // ç›‘å¬è¯­éŸ³åˆ—è¡¨å˜åŒ–äº‹ä»¶
        speechSynthesis.onvoiceschanged = () => {
          speechSynthesis.onvoiceschanged = null;
          tryLoad();
        };
        
        // ç«‹å³å°è¯•ä¸€æ¬¡
        setTimeout(tryLoad, 100);
      }
    }
    
    function speakText(text, onEnd){
      if(!isSpeechSynthesisSupported()){
        // å¦‚æœä¸æ”¯æŒè¯­éŸ³åˆæˆï¼Œç›´æ¥æ‰§è¡Œå›è°ƒ
        if(typeof onEnd === 'function'){
          setTimeout(() => { try { onEnd(); } catch(_) {} }, 100);
        }
        return;
      }
      
      // æ¯æ¬¡æ’­æ”¾å‰éƒ½å¼ºåˆ¶æ¿€æ´»ï¼ˆç§»åŠ¨ç«¯éœ€è¦æ¯æ¬¡ç”¨æˆ·äº¤äº’åæ¿€æ´»ï¼‰
      // é‡ç½®æ¿€æ´»çŠ¶æ€ï¼Œå¼ºåˆ¶é‡æ–°æ¿€æ´»
      if(!__speechActivated || !isSpeechActuallyAvailable()){
        __speechActivated = false;
        __speechTestAttempts = 0; // é‡ç½®å°è¯•æ¬¡æ•°
        activateSpeech(true); // å¼ºåˆ¶æ¿€æ´»
        // å»¶è¿Ÿä¸€ç‚¹å†æ’­æ”¾ï¼Œç¡®ä¿æ¿€æ´»å®Œæˆ
        setTimeout(() => {
          speakText(text, onEnd);
        }, 500); // å¢åŠ å»¶è¿Ÿåˆ°500msï¼Œç¡®ä¿æ¿€æ´»å®Œæˆ
        return;
      }
      
      // å³ä½¿å·²æ¿€æ´»ï¼Œä¹Ÿå†æ¬¡å°è¯•æ¿€æ´»ä»¥ç¡®ä¿å¯ç”¨ï¼ˆç§»åŠ¨ç«¯å¯èƒ½çŠ¶æ€ä¸ç¨³å®šï¼‰
      activateSpeech();
      
      try {
        ensureVoicesLoaded(() => {
          try {
            // å†æ¬¡æ£€æŸ¥è¯­éŸ³æ˜¯å¦å¯ç”¨
            if(!isSpeechActuallyAvailable()){
              // å¦‚æœä»ç„¶ä¸å¯ç”¨ï¼Œå°è¯•å¼ºåˆ¶é‡æ–°æ¿€æ´»
              if(__speechTestAttempts < MAX_SPEECH_TEST_ATTEMPTS){
                activateSpeech(true);
                setTimeout(() => {
                  speakText(text, onEnd);
                }, 300);
                return;
              }
              // å¦‚æœå¤šæ¬¡å°è¯•åä»ç„¶ä¸å¯ç”¨ï¼Œç›´æ¥æ‰§è¡Œå›è°ƒ
              if(typeof onEnd === 'function'){
                setTimeout(() => { try { onEnd(); } catch(_) {} }, 100);
              }
              return;
            }
            
            // ç§»åŠ¨ç«¯ï¼šå…ˆå–æ¶ˆä¹‹å‰çš„è¯­éŸ³ï¼Œç¡®ä¿æ–°è¯­éŸ³å¯ä»¥æ’­æ”¾
            speechSynthesis.cancel();
            
            // ç§»åŠ¨ç«¯ï¼šéœ€è¦çŸ­æš‚å»¶è¿Ÿä»¥ç¡®ä¿cancelå®Œæˆ
            setTimeout(() => {
              try {
                const u = new SpeechSynthesisUtterance(String(text));
                u.lang = 'en-US';
                
                // ä¼˜åŒ–è¯­éŸ³å‚æ•°ï¼Œä½¿å…¶æ›´é¥±æ»¡ã€æ›´äººæ€§åŒ–
                u.rate = 0.85;  // è¯­é€Ÿç¨æ…¢ï¼Œæ›´æ¸…æ™°ï¼ˆé»˜è®¤1.0ï¼ŒèŒƒå›´0.1-10ï¼‰
                u.pitch = 1.1;  // éŸ³è°ƒç¨é«˜ï¼Œæ›´ç”ŸåŠ¨ï¼ˆé»˜è®¤1.0ï¼ŒèŒƒå›´0-2ï¼‰
                u.volume = 1.0; // éŸ³é‡æœ€å¤§ï¼ˆé»˜è®¤1.0ï¼ŒèŒƒå›´0-1ï¼‰
                
                // å°è¯•é€‰æ‹©æ›´è‡ªç„¶çš„è¯­éŸ³
                const voices = speechSynthesis.getVoices();
                if(voices.length > 0){
                  // ä¼˜å…ˆé€‰æ‹©æ›´è‡ªç„¶çš„è¯­éŸ³ï¼ˆé€šå¸¸åç§°åŒ…å« "Natural" æˆ– "Neural"ï¼‰
                  const preferredVoices = voices.filter(v => 
                    v.lang.startsWith('en') && (
                      v.name.toLowerCase().includes('natural') ||
                      v.name.toLowerCase().includes('neural') ||
                      v.name.toLowerCase().includes('premium') ||
                      v.name.toLowerCase().includes('enhanced')
                    )
                  );
                  if(preferredVoices.length > 0){
                    u.voice = preferredVoices[0];
                  } else {
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¼˜å…ˆè¯­éŸ³ï¼Œé€‰æ‹©è´¨é‡è¾ƒå¥½çš„è‹±æ–‡è¯­éŸ³
                    const englishVoices = voices.filter(v => v.lang.startsWith('en'));
                    if(englishVoices.length > 0){
                      // ä¼˜å…ˆé€‰æ‹©éç³»ç»Ÿé»˜è®¤çš„è¯­éŸ³ï¼ˆé€šå¸¸è´¨é‡æ›´å¥½ï¼‰
                      const nonDefaultVoice = englishVoices.find(v => !v.name.toLowerCase().includes('sapi')) || englishVoices[0];
                      u.voice = nonDefaultVoice;
                    }
                  }
                }
                
                // é”™è¯¯å¤„ç†
                u.onerror = (e) => {
                  console.warn('Speech synthesis error:', e);
                  // æŸäº›é”™è¯¯å¯èƒ½éœ€è¦é‡æ–°æ¿€æ´»
                  if(e.error === 'not-allowed' || e.error === 'network'){
                    __speechActivated = false;
                    __speechTestAttempts = 0; // é‡ç½®å°è¯•æ¬¡æ•°ï¼Œå…è®¸é‡æ–°å°è¯•
                  }
                  if(typeof onEnd === 'function'){
                    setTimeout(() => { try { onEnd(); } catch(_) {} }, 100);
                  }
                };
                
                if (typeof onEnd === 'function') {
                  u.onend = () => { 
                    try { onEnd(); } catch(_) {} 
                  };
                }
                
                // è®¾ç½®è¶…æ—¶ï¼Œå¦‚æœ5ç§’å†…æ²¡æœ‰å¼€å§‹æ’­æ”¾ï¼Œè®¤ä¸ºå¤±è´¥
                let started = false;
                const timeout = setTimeout(() => {
                  if(!started){
                    console.warn('Speech synthesis timeout');
                    speechSynthesis.cancel();
                    if(typeof onEnd === 'function'){
                      try { onEnd(); } catch(_) {}
                    }
                  }
                }, 5000);
                
                u.onstart = () => {
                  started = true;
                  clearTimeout(timeout);
                };
                
                speechSynthesis.speak(u);
              } catch(e) {
                console.warn('Speech synthesis speak error:', e);
                if(typeof onEnd === 'function'){
                  setTimeout(() => { try { onEnd(); } catch(_) {} }, 100);
                }
              }
            }, 100); // å¢åŠ å»¶è¿Ÿåˆ°100msï¼Œç¡®ä¿cancelå®Œæˆ
          } catch(e) {
            console.warn('Speech synthesis setup error:', e);
            if(typeof onEnd === 'function'){
              setTimeout(() => { try { onEnd(); } catch(_) {} }, 100);
            }
          }
        });
      } catch(e) {
        console.warn('Speech synthesis error:', e);
        if(typeof onEnd === 'function'){
          setTimeout(() => { try { onEnd(); } catch(_) {} }, 100);
        }
      }
    }
    function englishNoteNameForMidi(midi){
      const pc = Number(midi) % 12;
      const octave = Math.floor(Number(midi) / 12) - 1; // è·å–ç»„å·ï¼ˆå…«åº¦ï¼‰
      const FLAT_MAP = {1:'Db',3:'Eb',6:'Gb',8:'Ab',10:'Bb'};
      const sharpName = PCN[pc];
      let text = sharpName.replace('#', '-Sharp');
      // æ·»åŠ ç»„å·æ•°å­—ï¼Œç”¨è‹±æ–‡å•è¯è¡¨ç¤ºä»¥ä¾¿è¯­éŸ³åˆæˆ
      const numberWords = ['zero', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine'];
      const octaveWord = octave >= 0 && octave < 10 ? numberWords[octave] : String(octave);
      text += ' ' + octaveWord;
      
      if(FLAT_MAP[pc]){
        const flatName = FLAT_MAP[pc];
        text += ', ' + flatName.replace('b', '-flat') + ' ' + octaveWord;
      }
      return text;
    }
    // ç”ŸæˆéŸ³ç¨‹èªéŸ³æ–‡æœ¬ï¼Œä¾‹å¦‚ "C to B, major seventh"ï¼ˆä¸å¸¦éŸ³åŒºæ•°å­—ï¼‰
    function intervalSpeechText(baseMidi, targetMidi, intervalSteps){
      // ç²å–åŸºæº–éŸ³å’Œç›®æ¨™éŸ³çš„è‹±æ–‡åç¨±ï¼ˆç”¨æ–¼èªéŸ³ï¼Œä¸å¸¦éŸ³åŒºæ•°å­—ï¼‰
      const basePc = Number(baseMidi) % 12;
      const targetPc = Number(targetMidi) % 12;
      const baseSharp = PCN[basePc];
      const targetSharp = PCN[targetPc];
      const baseName = baseSharp.replace('#', '-Sharp');
      const targetName = targetSharp.replace('#', '-Sharp');
      
      // ç²å–éŸ³ç¨‹åº¦æ•¸çš„è‹±æ–‡åç¨±
      const interval = INTERVALS.find(i => i.st === intervalSteps);
      let intervalName = '';
      if(interval){
        // å°‡ä¸­æ–‡éŸ³ç¨‹åç¨±è½‰æ›ç‚ºè‹±æ–‡
        const intervalMap = {
          'å°äºŒåº¦': 'minor second',
          'å¤§äºŒåº¦': 'major second',
          'å°ä¸‰åº¦': 'minor third',
          'å¤§ä¸‰åº¦': 'major third',
          'å®Œå…¨å››åº¦': 'perfect fourth',
          'ä¸‰å…¨éŸ³': 'tritone',
          'å®Œå…¨äº”åº¦': 'perfect fifth',
          'å°å…­åº¦': 'minor sixth',
          'å¤§å…­åº¦': 'major sixth',
          'å°ä¸ƒåº¦': 'minor seventh',
          'å¤§ä¸ƒåº¦': 'major seventh',
          'å…«åº¦': 'octave'
        };
        intervalName = intervalMap[interval.label] || interval.label;
      }
      
      return `${baseName} to ${targetName}, ${intervalName}`;
    }
    function clearRevealTimer(){
      if(__revealTimerId){ clearTimeout(__revealTimerId); __revealTimerId=null; }
    }
    // ç”Ÿæˆå’Œå¼¦èªéŸ³æ–‡æœ¬ï¼Œä¾‹å¦‚ "C major triad" æˆ– "C major seventh"
    function chordSpeechText(rootMidi, chordType, isSeventh){
      // åªè·å–æ ¹éŸ³åç§°ï¼ˆä¸å¸¦éŸ³åŒºæ•°å­—ï¼‰ï¼Œä¾‹å¦‚ "C" è€Œä¸æ˜¯ "C four"
      const pc = Number(rootMidi) % 12;
      const sharpName = PCN[pc];
      const rootName = sharpName.replace('#', '-Sharp');
      
      // å°†ä¸­æ–‡å’Œå¼¦åç§°è½¬æ¢ä¸ºè‹±æ–‡
      const chordTypeMap = {
        'å¤§ä¸‰å’Œå¼¦': 'major triad',
        'å°ä¸‰å’Œå¼¦': 'minor triad',
        'æ¸›ä¸‰å’Œå¼¦': 'diminished triad',
        'å¢ä¸‰å’Œå¼¦': 'augmented triad',
        'å¤§ä¸ƒå’Œå¼¦ (maj7)': 'major seventh',
        'å±¬ä¸ƒå’Œå¼¦ (7)': 'dominant seventh',
        'å°ä¸ƒå’Œå¼¦ (min7)': 'minor seventh',
        'åŠæ¸›ä¸ƒ (m7â™­5)': 'half diminished seventh',
        'æ¸›ä¸ƒ (dim7)': 'diminished seventh'
      };
      
      // ä»optionsä¸­æ‰¾åˆ°å¯¹åº”çš„ä¸­æ–‡åç§°
      const chordLabel = state.current.options.find(opt => opt.key === chordType)?.text || '';
      const chordName = chordTypeMap[chordLabel] || chordLabel;
      
      return `${rootName} ${chordName}`;
    }
    // è·å–å’Œå¼¦æ˜¾ç¤ºåç§°ï¼ˆä¸å¸¦éŸ³åŒºï¼‰ï¼Œä¾‹å¦‚ "Cmaj7", "Cmin", "Cdim" ç­‰
    // æ”¯æŒè½¬ä½æ˜¾ç¤ºï¼Œä¾‹å¦‚ "Cmaj/E"ï¼ˆç¬¬ä¸€è½¬ä½ï¼‰ï¼Œ"Cmaj/G"ï¼ˆç¬¬äºŒè½¬ä½ï¼‰
    function chordDisplayName(rootMidi, chordType, inversion, tones){
      const rootName = midiToNoteNameOnly(rootMidi);
      // å°†å’Œå¼¦ç±»å‹è½¬æ¢ä¸ºç®€å†™
      const chordTypeMap = {
        'maj': 'maj',
        'min': 'min',
        'dim': 'dim',
        'aug': 'aug',
        'maj7': 'maj7',
        '7': '7',
        'min7': 'min7',
        'm7b5': 'm7b5',
        'dim7': 'dim7'
      };
      const chordShort = chordTypeMap[chordType] || chordType;
      let displayName = rootName + chordShort;
      
      // å¦‚æœæœ‰è½¬ä½ä¸”æœ€ä½éŸ³ä¸æ˜¯æ ¹éŸ³ï¼Œæ·»åŠ è½¬ä½æ ‡è®°
      if(inversion !== undefined && inversion !== null && inversion > 0 && tones && tones.length > 0){
        // æ‰¾åˆ°æœ€ä½éŸ³ï¼ˆè½¬ä½åçš„ bass noteï¼‰
        const bassMidi = Math.min(...tones.map(Number));
        const bassName = midiToNoteNameOnly(bassMidi);
        // å¦‚æœæœ€ä½éŸ³ä¸æ˜¯æ ¹éŸ³ï¼Œæ·»åŠ è½¬ä½æ ‡è®°
        if(bassMidi % 12 !== rootMidi % 12){
          displayName = displayName + '/' + bassName;
        }
      }
      
      return displayName;
    }
    
    function scheduleReveal(questionEndTime){
      clearRevealTimer();
      if(!state.current || (state.current.type !== 'note' && state.current.type !== 'interval_up' && state.current.type !== 'interval_down' && state.current.type !== 'interval_harm' && state.current.type !== 'triad' && state.current.type !== 'seventh')) return;
      const sec = Number(state.revealSeconds||0);
      if(!sec || Number.isNaN(sec)) return;
      
      // å¦‚æœæä¾›äº†é¢˜ç›®éŸ³æ’­æ”¾å®Œæˆçš„æ—¶é—´ï¼Œä»é‚£ä¸ªæ—¶é—´ç‚¹å¼€å§‹è®¡æ—¶
      // å¦åˆ™ä»å½“å‰æ—¶é—´å¼€å§‹è®¡æ—¶ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
      let delayMs = sec * 1000;
      if(questionEndTime !== undefined && questionEndTime !== null){
        ensureAudio();
        const currentTime = audioCtx.currentTime;
        const elapsed = currentTime - questionEndTime;
        // å¦‚æœé¢˜ç›®éŸ³å·²ç»æ’­æ”¾å®Œæˆï¼Œç«‹å³å¼€å§‹è®¡æ—¶
        // å¦‚æœé¢˜ç›®éŸ³è¿˜åœ¨æ’­æ”¾ï¼Œç­‰å¾…æ’­æ”¾å®Œæˆåå†è®¡æ—¶
        if(elapsed >= 0){
          // é¢˜ç›®éŸ³å·²ç»æ’­æ”¾å®Œæˆï¼Œä»å½“å‰æ—¶é—´å¼€å§‹è®¡æ—¶
          delayMs = sec * 1000;
        } else {
          // é¢˜ç›®éŸ³è¿˜åœ¨æ’­æ”¾ï¼Œç­‰å¾…æ’­æ”¾å®Œæˆåå†è®¡æ—¶
          delayMs = (-elapsed * 1000) + (sec * 1000);
        }
      }
      
      __revealTimerId = setTimeout(()=>{
        if(!state.current || state.current.__answered) return;
        const ansMidi = Number(state.current.answerKey);
        
        // æ’­æ”¾ç­”æ¡ˆéŸ³ç¬¦
        if(state.current.type === 'note'){
          // å–®éŸ³æ¨¡å¼ï¼šåªæ’­æ”¾ç›®æ¨™éŸ³
          // æ¿€æ´»ç­”æ¡ˆéŸ³çŠ¶æ€æç¤º
          highlightAnswer(ansMidi);
          
          const answerFreq = midiToFreq(ansMidi);
          playTone(answerFreq, 1000, state.wave, 15, 0);
          // æ’­æ”¾ç­”æ¡ˆéŸ³æ™‚æ‰é¡¯ç¤ºã€Œç­”æ¡ˆï¼šã€ä½¿ç”¨éŸ³åï¼ˆä¸å¸¦éŸ³åŒºï¼‰
          solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+midiToNoteNameOnly(ansMidi)+'</b>';
          
          // ç­‰éŸ³ç¬¦æ’­æ”¾å®Œæˆå¾Œå†å¿µèªéŸ³ï¼ˆä¸å¸¦éŸ³åŒºæ•°å­—ï¼‰
          setTimeout(() => {
            const pc = Number(ansMidi) % 12;
            const sharpName = PCN[pc];
            const engName = sharpName.replace('#', '-Sharp');
            speakText(engName, () => {
              // èªéŸ³æ’­ç•¢å¾Œï¼Œå…ˆè®“ç­”æ¡ˆç‡ˆè™Ÿä¸€èµ·ç†„æ»…ï¼Œå†ç¨ç­‰å‡ºä¸‹ä¸€é¡Œ
              clearAnswerHighlight(ansMidi);
              setTimeout(()=>{ newQuestion(); }, 600);
            });
          }, 1000); // ç­‰å¾…éŸ³ç¬¦æ’­æ”¾å®Œæˆï¼ˆ1000msï¼‰
        } else if(state.current.type === 'interval_up' || state.current.type === 'interval_down'){
          // éŸ³ç¨‹è¾¨è­˜ï¼šæ’­æ”¾é¡Œç›®éŸ³ï¼ˆé¡Œç›®éŸ³çš„ç¬¬ä¸€å€‹éŸ³+ç¬¬äºŒå€‹éŸ³ï¼‰
          const baseMidi = Number(state.current.baseMidi); // é¡Œç›®éŸ³çš„ç¬¬ä¸€å€‹éŸ³
          const intervalSteps = Number(state.current.intervalSteps);
          
          // æ¿€æ´»ç­”æ¡ˆéŸ³çŠ¶æ€æç¤º
          updateStatusHint(hintAnswerEl, true);
          
          if(state.current.type === 'interval_up'){
            // ä¸Šè¡Œï¼šbaseï¼ˆä½ï¼‰â†’ ansMidiï¼ˆé«˜ï¼‰
            // ä¸éŸ³é¢‘åŒæ­¥é«˜äº®ï¼šå…ˆé«˜äº®ç¬¬ä¸€ä¸ªéŸ³ï¼Œå†é«˜äº®ç¬¬äºŒä¸ªéŸ³ï¼Œä¿æŒé«˜äº®ç›´åˆ°è¯­éŸ³æ’­æ”¾å®Œæˆ
            playTone(midiToFreq(baseMidi), 600, state.wave, 15, 0);
            highlightKeysManual([baseMidi]);
            
            playTone(midiToFreq(ansMidi), 1000, state.wave, 15, 0.7);
            setTimeout(()=>highlightKeysManual([ansMidi]), 700);
            
            // æ’­æ”¾ç­”æ¡ˆéŸ³æ™‚æ‰é¡¯ç¤ºã€Œç­”æ¡ˆï¼šã€æ ¼å¼ç‚ºé¡Œç›®éŸ³çš„éŸ³ç¨‹ï¼Œä¾‹å¦‚ "A4 to B4 å¤§äºŒåº¦"
            const answerText = formatIntervalAnswer(baseMidi, ansMidi, intervalSteps);
            solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+answerText+'</b>';
          } else {
            // ä¸‹è¡Œï¼šbaseï¼ˆé«˜ï¼‰â†’ ansMidiï¼ˆä½ï¼‰
            // ä¸éŸ³é¢‘åŒæ­¥é«˜äº®ï¼šå…ˆé«˜äº®ç¬¬ä¸€ä¸ªéŸ³ï¼Œå†é«˜äº®ç¬¬äºŒä¸ªéŸ³ï¼Œä¿æŒé«˜äº®ç›´åˆ°è¯­éŸ³æ’­æ”¾å®Œæˆ
            playTone(midiToFreq(baseMidi), 600, state.wave, 15, 0);
            highlightKeysManual([baseMidi]);
            
            playTone(midiToFreq(ansMidi), 1000, state.wave, 15, 0.7);
            setTimeout(()=>highlightKeysManual([ansMidi]), 700);
            
            // æ’­æ”¾ç­”æ¡ˆéŸ³æ™‚æ‰é¡¯ç¤ºã€Œç­”æ¡ˆï¼šã€æ ¼å¼ç‚ºé¡Œç›®éŸ³çš„éŸ³ç¨‹ï¼Œä¾‹å¦‚ "D4 to G4 å®Œå…¨å››åº¦"
            const answerText = formatIntervalAnswer(baseMidi, ansMidi, intervalSteps);
            solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+answerText+'</b>';
          }
          
          // ç­‰éŸ³ç¨‹æ’­æ”¾å®Œæˆå¾Œå†å¿µèªéŸ³ï¼ˆ600msåŸºæº–éŸ³ + 1000msç›®æ¨™éŸ³ + 100msé–“éš”ï¼‰
          setTimeout(() => {
            const speechText = intervalSpeechText(baseMidi, ansMidi, intervalSteps);
            speakText(speechText, () => {
              // èªéŸ³æ’­ç•¢å¾Œï¼Œå…ˆè®“ç­”æ¡ˆç‡ˆè™Ÿå’Œç‹€æ…‹æç¤ºä¸€èµ·ç†„æ»…ï¼Œå†ç¨ç­‰å‡ºä¸‹ä¸€é¡Œ
              clearKeysHighlight([baseMidi, ansMidi]);
              updateStatusHint(null, false);
              setTimeout(()=>{ newQuestion(); }, 600);
            });
          }, 1700); // ç­‰å¾…éŸ³ç¨‹æ’­æ”¾å®Œæˆï¼ˆ1700msï¼‰
        } else if(state.current.type === 'interval_harm'){
          // å’Œè²éŸ³ç¨‹è¾¨è­˜ï¼šæ’­æ”¾é¡Œç›®éŸ³ï¼ˆåŒæ™‚æ’­æ”¾baseå’Œotherï¼‰
          const baseMidi = Number(state.current.baseMidi); // è¼ƒä½çš„éŸ³
          const otherMidi = Number(state.current.otherMidi); // è¼ƒé«˜çš„éŸ³
          const intervalSteps = Number(state.current.intervalSteps);
          
          // æ¿€æ´»ç­”æ¡ˆéŸ³çŠ¶æ€æç¤º
          updateStatusHint(hintAnswerEl, true);
          
          // æ’­æ”¾é¡Œç›®éŸ³ï¼šåŒæ™‚æ’­æ”¾baseå’Œotherï¼ˆå’Œè²éŸ³ç¨‹ï¼‰
          // ä¸éŸ³é¢‘åŒæ­¥é«˜äº®ï¼šåŒæ—¶é«˜äº®ä¸¤ä¸ªéŸ³ï¼Œä¿æŒé«˜äº®ç›´åˆ°è¯­éŸ³æ’­æ”¾å®Œæˆ
          const bf = midiToFreq(baseMidi), of = midiToFreq(otherMidi);
          playTone(bf, 1100, state.wave, 15, 0);
          playTone(of, 1100, state.wave, 15, 0);
          highlightKeysManual([baseMidi, otherMidi]);
          
          // æ’­æ”¾ç­”æ¡ˆéŸ³æ™‚æ‰é¡¯ç¤ºã€Œç­”æ¡ˆï¼šã€æ ¼å¼ç‚ºé¡Œç›®éŸ³çš„éŸ³ç¨‹ï¼Œä¾‹å¦‚ "C4 to E4 å¤§ä¸‰åº¦"
          const answerText = formatIntervalAnswer(baseMidi, otherMidi, intervalSteps);
          solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+answerText+'</b>';
          
          // ç­‰éŸ³ç¨‹æ’­æ”¾å®Œæˆå¾Œå†å¿µèªéŸ³
          setTimeout(() => {
            const speechText = intervalSpeechText(baseMidi, otherMidi, intervalSteps);
            speakText(speechText, () => {
              // èªéŸ³æ’­ç•¢å¾Œï¼Œå…ˆè®“ç­”æ¡ˆç‡ˆè™Ÿå’Œç‹€æ…‹æç¤ºä¸€èµ·ç†„æ»…ï¼Œå†ç¨ç­‰å‡ºä¸‹ä¸€é¡Œ
              clearKeysHighlight([baseMidi, otherMidi]);
              updateStatusHint(null, false);
              setTimeout(()=>{ newQuestion(); }, 600);
            });
          }, 1100); // ç­‰å¾…éŸ³ç¨‹æ’­æ”¾å®Œæˆï¼ˆ1100msï¼‰
        } else if(state.current.type === 'triad'){
          // ä¸‰å’Œå¼¦è¾¨è­˜ï¼šå…ˆæ’­æ”¾åˆ†è§£å’Œå¼¦ï¼Œå†æ’­æ”¾å’Œè²ï¼Œæœ€å¾Œæ’­æ”¾èªéŸ³
          const tones = state.current.tones || [];
          const rootMidi = Number(state.current.rootMidi || state.current.answerKey); // æ ¹éŸ³ï¼ˆç”¨äºæ˜¾ç¤ºå’Œå¼¦åç§°ï¼‰
          const chordType = state.current.chordType;
          
          // æ¿€æ´»ç­”æ¡ˆéŸ³çŠ¶æ€æç¤º
          updateStatusHint(hintAnswerEl, true);
          
          // å…ˆæ’­æ”¾åˆ†è§£å’Œå¼¦ï¼ˆæŒ‰é¡ºåºæ’­æ”¾æ¯ä¸ªéŸ³ï¼‰
          const arpeggioNoteDur = 300; // åˆ†è§£å’Œå¼¦æ¯ä¸ªéŸ³çš„æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
          const arpeggioGap = 0.1; // åˆ†è§£å’Œå¼¦éŸ³ä¹‹é—´çš„é—´éš”ï¼ˆç§’ï¼‰
          const harmonyDur = 800; // å’Œå£°æ’­æ”¾æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
          
          tones.forEach((tone, index) => {
            const when = index * (arpeggioNoteDur/1000 + arpeggioGap);
            playTone(midiToFreq(tone), arpeggioNoteDur, state.wave, 15, when);
            // é«˜äº®å½“å‰éŸ³
            setTimeout(() => {
              highlightKeysManual([tone]);
            }, when * 1000);
          });
          
          // å†æ’­æ”¾å’Œå£°ï¼ˆåŒæ—¶æ’­æ”¾æ‰€æœ‰éŸ³ï¼‰
          const harmonyWhen = tones.length * (arpeggioNoteDur/1000 + arpeggioGap) + 0.15;
          tones.forEach(tone => {
            playTone(midiToFreq(tone), harmonyDur, state.wave, 15, harmonyWhen);
          });
          setTimeout(() => {
            highlightKeysManual(tones);
          }, harmonyWhen * 1000);
          
          // æ’­æ”¾ç­”æ¡ˆéŸ³æ™‚æ‰é¡¯ç¤ºã€Œç­”æ¡ˆï¼šã€ä½¿ç”¨å’Œå¼¦åç¨±ï¼ˆä¸å¸¦éŸ³åŒºï¼‰
          const displayName = chordDisplayName(rootMidi, chordType, state.current.inversion, tones);
          solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+displayName+'</b>';
          
          // ç­‰å’Œå¼¦æ’­æ”¾å®Œæˆå¾Œå†å¿µèªéŸ³
          const totalDuration = harmonyWhen + harmonyDur / 1000;
          setTimeout(() => {
            const speechText = chordSpeechText(rootMidi, chordType, false);
            speakText(speechText, () => {
              // èªéŸ³æ’­ç•¢å¾Œï¼Œå…ˆè®“ç­”æ¡ˆç‡ˆè™Ÿå’Œç‹€æ…‹æç¤ºä¸€èµ·ç†„æ»…ï¼Œå†ç¨ç­‰å‡ºä¸‹ä¸€é¡Œ
              clearKeysHighlight(tones);
              updateStatusHint(null, false);
              setTimeout(()=>{ newQuestion(); }, 600);
            });
          }, totalDuration * 1000); // ç­‰å¾…å’Œå¼¦æ’­æ”¾å®Œæˆ
        } else if(state.current.type === 'seventh'){
          // ä¸ƒå’Œå¼¦è¾¨è­˜ï¼šå…ˆæ’­æ”¾åˆ†è§£å’Œå¼¦ï¼Œå†æ’­æ”¾å’Œè²ï¼Œæœ€å¾Œæ’­æ”¾èªéŸ³
          const tones = state.current.tones || [];
          const rootMidi = Number(state.current.rootMidi || state.current.answerKey); // æ ¹éŸ³ï¼ˆç”¨äºæ˜¾ç¤ºå’Œå¼¦åç§°ï¼‰
          const chordType = state.current.chordType;
          
          // æ¿€æ´»ç­”æ¡ˆéŸ³çŠ¶æ€æç¤º
          updateStatusHint(hintAnswerEl, true);
          
          // å…ˆæ’­æ”¾åˆ†è§£å’Œå¼¦ï¼ˆæŒ‰é¡ºåºæ’­æ”¾æ¯ä¸ªéŸ³ï¼‰
          const arpeggioNoteDur = 300; // åˆ†è§£å’Œå¼¦æ¯ä¸ªéŸ³çš„æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
          const arpeggioGap = 0.1; // åˆ†è§£å’Œå¼¦éŸ³ä¹‹é—´çš„é—´éš”ï¼ˆç§’ï¼‰
          const harmonyDur = 900; // å’Œå£°æ’­æ”¾æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
          
          tones.forEach((tone, index) => {
            const when = index * (arpeggioNoteDur/1000 + arpeggioGap);
            playTone(midiToFreq(tone), arpeggioNoteDur, state.wave, 15, when);
            // é«˜äº®å½“å‰éŸ³
            setTimeout(() => {
              highlightKeysManual([tone]);
            }, when * 1000);
          });
          
          // å†æ’­æ”¾å’Œå£°ï¼ˆåŒæ—¶æ’­æ”¾æ‰€æœ‰éŸ³ï¼‰
          const harmonyWhen = tones.length * (arpeggioNoteDur/1000 + arpeggioGap) + 0.15;
          tones.forEach(tone => {
            playTone(midiToFreq(tone), harmonyDur, state.wave, 15, harmonyWhen);
          });
          setTimeout(() => {
            highlightKeysManual(tones);
          }, harmonyWhen * 1000);
          
          // æ’­æ”¾ç­”æ¡ˆéŸ³æ™‚æ‰é¡¯ç¤ºã€Œç­”æ¡ˆï¼šã€ä½¿ç”¨å’Œå¼¦åç¨±ï¼ˆä¸å¸¦éŸ³åŒºï¼‰
          const displayName = chordDisplayName(rootMidi, chordType, state.current.inversion, tones);
          solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+displayName+'</b>';
          
          // ç­‰å’Œå¼¦æ’­æ”¾å®Œæˆå¾Œå†å¿µèªéŸ³
          const totalDuration = harmonyWhen + harmonyDur / 1000;
          setTimeout(() => {
            const speechText = chordSpeechText(rootMidi, chordType, true);
            speakText(speechText, () => {
              // èªéŸ³æ’­ç•¢å¾Œï¼Œå…ˆè®“ç­”æ¡ˆç‡ˆè™Ÿå’Œç‹€æ…‹æç¤ºä¸€èµ·ç†„æ»…ï¼Œå†ç¨ç­‰å‡ºä¸‹ä¸€é¡Œ
              clearKeysHighlight(tones);
              updateStatusHint(null, false);
              setTimeout(()=>{ newQuestion(); }, 600);
            });
          }, totalDuration * 1000); // ç­‰å¾…å’Œå¼¦æ’­æ”¾å®Œæˆ
        }
      }, delayMs);
    }
    function setQuestion(q){
      state.current=q;
      state.current.__answered=false;
      state.current.__countedWrong=false; // å–®éŸ³æ¨¡å¼ï¼šæœ¬é¡ŒéŒ¯èª¤åªè¨ˆä¸€æ¬¡
      questionLabel.textContent=q.label;
      renderAnswers(q);
      solfegeEl.innerHTML='ç­”æ¡ˆï¼šâ€”';
      clearRevealTimer();
      
      // æ¸…é™¤æ‰€æœ‰é‹¼ç´éµçš„é«˜äº®
      const nodes = pianoEl.querySelectorAll('[data-midi]');
      nodes.forEach(n => n.classList.remove('active'));
      
      // å–®éŸ³æ¨¡å¼ã€éŸ³ç¨‹è¾¨è­˜ï¼ˆä¸Šè¡Œ/ä¸‹è¡Œ/å’Œè²ï¼‰å’Œå’Œå¼¦è¾¨è­˜ï¼ˆä¸‰å’Œå¼¦/ä¸ƒå’Œå¼¦ï¼‰æ˜¾ç¤ºæç¤ºå­—åŒºåŸŸ
      if(q.type === 'note' || q.type === 'interval_up' || q.type === 'interval_down' || q.type === 'interval_harm' || q.type === 'triad' || q.type === 'seventh'){
        showStatusHints(true);
        updateStatusHint(null, false); // åˆå§‹çŠ¶æ€ï¼šéƒ½ä¸äº®
      } else {
        showStatusHints(false);
      }
    }
    function newQuestion(){
      // å¼·åˆ¶åœæ­¢ä¸Šä¸€é¡Œå°šæœªçµæŸçš„è²éŸ³ã€èªéŸ³å’Œå®šæ™‚å™¨ï¼Œé¿å…éŸ³é »ç›¸æ’
      stopAllAudioAndSpeech();
      let q;
      const m=modeEl.value;
      if(m==='note') q=genNoteQuestion();
      else if(m==='interval_up') q=genInterval('up');
      else if(m==='interval_down') q=genInterval('down');
      else if(m==='interval_harm') q=genInterval('harm');
      else if(m==='triad') q=genTriad();
      else q=genSeventh();
      setQuestion(q);
      
      // è®°å½•æ’­æ”¾å¼€å§‹æ—¶é—´ï¼Œè®¡ç®—é¢˜ç›®éŸ³æ’­æ”¾å®Œæˆçš„ç»å¯¹æ—¶é—´
      ensureAudio();
      const playStartTime = audioCtx.currentTime;
      const questionEndTimeRelative = q.play();
      
      if(q.type==='note' || q.type==='interval_up' || q.type==='interval_down' || q.type==='interval_harm' || q.type==='triad' || q.type==='seventh'){
        // è®¡ç®—é¢˜ç›®éŸ³æ’­æ”¾å®Œæˆçš„ç»å¯¹æ—¶é—´
        const questionEndTimeAbsolute = playStartTime + questionEndTimeRelative;
        scheduleReveal(questionEndTimeAbsolute);
      }
    }

    function submitAnswer(chosen){
      const q=state.current; if(!q) return;
      clearRevealTimer();
      let ok=false;
      if(q.type==='note'){ 
        ok=Number(chosen)===Number(q.answerKey); 
      } else if(q.type==='interval_up' || q.type==='interval_down'){
        // éŸ³ç¨‹è¾¨è­˜ï¼šé»æ“Šçš„éŸ³æ‡‰è©²ç­‰æ–¼æ­£ç¢ºçš„ç›®æ¨™éŸ³
        const clickedMidi = Number(chosen);
        ok = clickedMidi === Number(q.answerKey);
      } else if(q.type==='interval_harm'){
        // å’Œè²éŸ³ç¨‹è¾¨è­˜ï¼šé»æ“Šçš„éŸ³æ‡‰è©²ç­‰æ–¼æ­£ç¢ºçš„baseéŸ³ï¼ˆè¼ƒä½çš„éŸ³ï¼‰
        const clickedMidi = Number(chosen);
        ok = clickedMidi === Number(q.answerKey);
      } else if(q.type==='triad' || q.type==='seventh'){
        // ä¸‰å’Œå¼¦/ä¸ƒå’Œå¼¦è¾¨è­˜ï¼šé»æ“Šçš„éŸ³æ‡‰è©²ç­‰æ–¼æ­£ç¢ºçš„æ ¹éŸ³
        const clickedMidi = Number(chosen);
        ok = clickedMidi === Number(q.answerKey);
      } else { 
        ok=String(chosen)===String(q.answerKey); 
      }
      
      // ç­”å°æ™‚æ¨™è¨˜ç‚ºå·²ç­”ï¼Œç­”éŒ¯æ™‚ä¸æ¨™è¨˜ï¼ˆå…è¨±ç¹¼çºŒå˜—è©¦ï¼‰
      if(ok) {
        q.__answered = true;
      }

      if (ok) {
        state.score.correct++;
        state.score.streak++;
        
        // å–®éŸ³æ¨¡å¼ï¼šç­”å°æ™‚é¡¯ç¤ºç­”æ¡ˆéŸ³æç¤ºä¸¦æ’­æ”¾ç­”æ¡ˆ
        if (q.type === 'note') {
          const ansMidi = Number(q.answerKey);
          const answerFreq = midiToFreq(ansMidi);
          playTone(answerFreq, 1000, state.wave, 15, 0);
          // ç­”æ¡ˆéŸ³éµèˆ‡æç¤ºå­—åŒæ­¥äº® 1000msï¼Œç„¶å¾Œä¸€èµ·ç†„æ»…
          highlightAnswer(ansMidi);
          setTimeout(()=>{ clearAnswerHighlight(ansMidi); }, 1000);
          // æ’­æ”¾ç­”æ¡ˆéŸ³æ™‚æ‰é¡¯ç¤ºã€Œç­”æ¡ˆï¼šã€ä½¿ç”¨éŸ³å
          solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+midiToNoteNameOnly(ansMidi)+'</b>';
        }
        // éŸ³ç¨‹è¾¨è­˜ï¼šç­”å°æ™‚é¡¯ç¤ºç­”æ¡ˆéŸ³æç¤ºä¸¦æ’­æ”¾é¡Œç›®éŸ³
        if (q.type === 'interval_up' || q.type === 'interval_down') {
          const ansMidi = Number(q.answerKey);
          const baseMidi = Number(q.baseMidi); // é¡Œç›®éŸ³çš„ç¬¬ä¸€å€‹éŸ³
          const intervalSteps = Number(q.intervalSteps);
          
          // æ¿€æ´»ç­”æ¡ˆéŸ³çŠ¶æ€æç¤º
          updateStatusHint(hintAnswerEl, true);
          
          // æ’­æ”¾é¡Œç›®éŸ³ï¼šå…ˆæ’­æ”¾é¡Œç›®éŸ³çš„ç¬¬ä¸€å€‹éŸ³ï¼Œå†æ’­æ”¾é¡Œç›®éŸ³çš„ç¬¬äºŒå€‹éŸ³
          // ä¸éŸ³é¢‘åŒæ­¥é«˜äº®ï¼šå…ˆé«˜äº®ç¬¬ä¸€ä¸ªéŸ³ï¼Œå†é«˜äº®ç¬¬äºŒä¸ªéŸ³ï¼Œä¿æŒé«˜äº®ç›´åˆ°è¯­éŸ³æ’­æ”¾å®Œæˆ
          if(q.type === 'interval_up'){
            // ä¸Šè¡Œï¼šbaseï¼ˆä½ï¼‰â†’ ansMidiï¼ˆé«˜ï¼‰
            playTone(midiToFreq(baseMidi), 600, state.wave, 15, 0);
            highlightKeysManual([baseMidi]);
            
            playTone(midiToFreq(ansMidi), 1000, state.wave, 15, 0.7);
            setTimeout(()=>highlightKeysManual([ansMidi]), 700);
            
            // æ’­æ”¾ç­”æ¡ˆéŸ³æ™‚æ‰é¡¯ç¤ºã€Œç­”æ¡ˆï¼šã€æ ¼å¼ç‚ºé¡Œç›®éŸ³çš„éŸ³ç¨‹ï¼Œä¾‹å¦‚ "A4 to B4 å¤§äºŒåº¦"
            const answerText = formatIntervalAnswer(baseMidi, ansMidi, intervalSteps);
            solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+answerText+'</b>';
          } else {
            // ä¸‹è¡Œï¼šbaseï¼ˆé«˜ï¼‰â†’ ansMidiï¼ˆä½ï¼‰
            playTone(midiToFreq(baseMidi), 600, state.wave, 15, 0);
            highlightKeysManual([baseMidi]);
            
            playTone(midiToFreq(ansMidi), 1000, state.wave, 15, 0.7);
            setTimeout(()=>highlightKeysManual([ansMidi]), 700);
            
            // æ’­æ”¾ç­”æ¡ˆéŸ³æ™‚æ‰é¡¯ç¤ºã€Œç­”æ¡ˆï¼šã€æ ¼å¼ç‚ºé¡Œç›®éŸ³çš„éŸ³ç¨‹ï¼Œä¾‹å¦‚ "D4 to G4 å®Œå…¨å››åº¦"
            const answerText = formatIntervalAnswer(baseMidi, ansMidi, intervalSteps);
            solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+answerText+'</b>';
          }
          
          // ç­‰éŸ³ç¨‹æ’­æ”¾å®Œæˆå¾Œå†å¿µèªéŸ³
          setTimeout(() => {
            const speechText = intervalSpeechText(baseMidi, ansMidi, intervalSteps);
            speakText(speechText, () => {
              // èªéŸ³æ’­ç•¢å¾Œï¼Œå…ˆè®“ç­”æ¡ˆç‡ˆè™Ÿå’Œç‹€æ…‹æç¤ºä¸€èµ·ç†„æ»…
              clearKeysHighlight([baseMidi, ansMidi]);
              updateStatusHint(null, false);
            });
          }, 1700); // ç­‰å¾…éŸ³ç¨‹æ’­æ”¾å®Œæˆï¼ˆ1700msï¼‰
        }
        // å’Œè²éŸ³ç¨‹è¾¨è­˜ï¼šç­”å°æ™‚é¡¯ç¤ºç­”æ¡ˆéŸ³æç¤ºä¸¦æ’­æ”¾é¡Œç›®éŸ³
        if (q.type === 'interval_harm') {
          const baseMidi = Number(q.baseMidi); // è¼ƒä½çš„éŸ³
          const otherMidi = Number(q.otherMidi); // è¼ƒé«˜çš„éŸ³
          const intervalSteps = Number(q.intervalSteps);
          
          // æ¿€æ´»ç­”æ¡ˆéŸ³çŠ¶æ€æç¤º
          updateStatusHint(hintAnswerEl, true);
          
          // æ’­æ”¾é¡Œç›®éŸ³ï¼šåŒæ™‚æ’­æ”¾baseå’Œotherï¼ˆå’Œè²éŸ³ç¨‹ï¼‰
          // ä¸éŸ³é¢‘åŒæ­¥é«˜äº®ï¼šåŒæ—¶é«˜äº®ä¸¤ä¸ªéŸ³ï¼Œä¿æŒé«˜äº®ç›´åˆ°è¯­éŸ³æ’­æ”¾å®Œæˆ
          const bf = midiToFreq(baseMidi), of = midiToFreq(otherMidi);
          playTone(bf, 1100, state.wave, 15, 0);
          playTone(of, 1100, state.wave, 15, 0);
          highlightKeysManual([baseMidi, otherMidi]);
          
          // æ’­æ”¾ç­”æ¡ˆéŸ³æ™‚æ‰é¡¯ç¤ºã€Œç­”æ¡ˆï¼šã€æ ¼å¼ç‚ºé¡Œç›®éŸ³çš„éŸ³ç¨‹ï¼Œä¾‹å¦‚ "C4 to E4 å¤§ä¸‰åº¦"
          const answerText = formatIntervalAnswer(baseMidi, otherMidi, intervalSteps);
          solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+answerText+'</b>';
          
          // ç­‰éŸ³ç¨‹æ’­æ”¾å®Œæˆå¾Œå†å¿µèªéŸ³
          setTimeout(() => {
            const speechText = intervalSpeechText(baseMidi, otherMidi, intervalSteps);
            speakText(speechText, () => {
              // èªéŸ³æ’­ç•¢å¾Œï¼Œå…ˆè®“ç­”æ¡ˆç‡ˆè™Ÿå’Œç‹€æ…‹æç¤ºä¸€èµ·ç†„æ»…
              clearKeysHighlight([baseMidi, otherMidi]);
              updateStatusHint(null, false);
            });
          }, 1100); // ç­‰å¾…éŸ³ç¨‹æ’­æ”¾å®Œæˆï¼ˆ1100msï¼‰
        }
        // ä¸‰å’Œå¼¦è¾¨è­˜ï¼šç­”å°æ™‚é¡¯ç¤ºç­”æ¡ˆéŸ³æç¤ºä¸¦æ’­æ”¾é¡Œç›®éŸ³
        if (q.type === 'triad') {
          const tones = q.tones || [];
          const rootMidi = Number(q.rootMidi || q.answerKey); // ä½¿ç”¨æ ¹éŸ³æ˜¾ç¤ºå’Œå¼¦åç§°
          const chordType = q.chordType;
          
          // æ¿€æ´»ç­”æ¡ˆéŸ³çŠ¶æ€æç¤º
          updateStatusHint(hintAnswerEl, true);
          
          // å…ˆæ’­æ”¾åˆ†è§£å’Œå¼¦ï¼ˆæŒ‰é¡ºåºæ’­æ”¾æ¯ä¸ªéŸ³ï¼‰
          const arpeggioNoteDur = 300; // åˆ†è§£å’Œå¼¦æ¯ä¸ªéŸ³çš„æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
          const arpeggioGap = 0.1; // åˆ†è§£å’Œå¼¦éŸ³ä¹‹é—´çš„é—´éš”ï¼ˆç§’ï¼‰
          const harmonyDur = 800; // å’Œå£°æ’­æ”¾æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
          
          tones.forEach((tone, index) => {
            const when = index * (arpeggioNoteDur/1000 + arpeggioGap);
            playTone(midiToFreq(tone), arpeggioNoteDur, state.wave, 15, when);
            // é«˜äº®å½“å‰éŸ³
            setTimeout(() => {
              highlightKeysManual([tone]);
            }, when * 1000);
          });
          
          // å†æ’­æ”¾å’Œå£°ï¼ˆåŒæ—¶æ’­æ”¾æ‰€æœ‰éŸ³ï¼‰
          const harmonyWhen = tones.length * (arpeggioNoteDur/1000 + arpeggioGap) + 0.15;
          tones.forEach(tone => {
            playTone(midiToFreq(tone), harmonyDur, state.wave, 15, harmonyWhen);
          });
          setTimeout(() => {
            highlightKeysManual(tones);
          }, harmonyWhen * 1000);
          
          // æ’­æ”¾ç­”æ¡ˆéŸ³æ™‚æ‰é¡¯ç¤ºã€Œç­”æ¡ˆï¼šã€ä½¿ç”¨å’Œå¼¦åç¨±
          const displayName = chordDisplayName(rootMidi, chordType, q.inversion, tones);
          solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+displayName+'</b>';
          
          // ç­‰å’Œå¼¦æ’­æ”¾å®Œæˆå¾Œå†å¿µèªéŸ³
          const totalDuration = harmonyWhen + harmonyDur / 1000;
          setTimeout(() => {
            const speechText = chordSpeechText(rootMidi, chordType, false);
            speakText(speechText, () => {
              // èªéŸ³æ’­ç•¢å¾Œï¼Œå…ˆè®“ç­”æ¡ˆç‡ˆè™Ÿå’Œç‹€æ…‹æç¤ºä¸€èµ·ç†„æ»…
              clearKeysHighlight(tones);
              updateStatusHint(null, false);
            });
          }, totalDuration * 1000);
        }
        // ä¸ƒå’Œå¼¦è¾¨è­˜ï¼šç­”å°æ™‚å…ˆæ’­æ”¾åˆ†è§£å’Œå¼¦ï¼Œå†æ’­æ”¾å’Œè²
        if (q.type === 'seventh') {
          const tones = q.tones || [];
          const rootMidi = Number(q.rootMidi || q.answerKey); // ä½¿ç”¨æ ¹éŸ³æ˜¾ç¤ºå’Œå¼¦åç§°
          const chordType = q.chordType;
          
          // æ¿€æ´»ç­”æ¡ˆéŸ³çŠ¶æ€æç¤º
          updateStatusHint(hintAnswerEl, true);
          
          // å…ˆæ’­æ”¾åˆ†è§£å’Œå¼¦ï¼ˆæŒ‰é¡ºåºæ’­æ”¾æ¯ä¸ªéŸ³ï¼‰
          const arpeggioNoteDur = 300; // åˆ†è§£å’Œå¼¦æ¯ä¸ªéŸ³çš„æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
          const arpeggioGap = 0.1; // åˆ†è§£å’Œå¼¦éŸ³ä¹‹é—´çš„é—´éš”ï¼ˆç§’ï¼‰
          const harmonyDur = 900; // å’Œå£°æ’­æ”¾æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
          
          tones.forEach((tone, index) => {
            const when = index * (arpeggioNoteDur/1000 + arpeggioGap);
            playTone(midiToFreq(tone), arpeggioNoteDur, state.wave, 15, when);
            // é«˜äº®å½“å‰éŸ³
            setTimeout(() => {
              highlightKeysManual([tone]);
            }, when * 1000);
          });
          
          // å†æ’­æ”¾å’Œå£°ï¼ˆåŒæ—¶æ’­æ”¾æ‰€æœ‰éŸ³ï¼‰
          const harmonyWhen = tones.length * (arpeggioNoteDur/1000 + arpeggioGap) + 0.15;
          tones.forEach(tone => {
            playTone(midiToFreq(tone), harmonyDur, state.wave, 15, harmonyWhen);
          });
          setTimeout(() => {
            highlightKeysManual(tones);
          }, harmonyWhen * 1000);
          
          // æ’­æ”¾ç­”æ¡ˆéŸ³æ™‚æ‰é¡¯ç¤ºã€Œç­”æ¡ˆï¼šã€ä½¿ç”¨å’Œå¼¦åç¨±
          const displayName = chordDisplayName(rootMidi, chordType, q.inversion, tones);
          solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+displayName+'</b>';
          
          // ç­‰å’Œå¼¦æ’­æ”¾å®Œæˆå¾Œå†å¿µèªéŸ³
          const totalDuration = harmonyWhen + harmonyDur / 1000;
          setTimeout(() => {
            const speechText = chordSpeechText(rootMidi, chordType, true);
            speakText(speechText, () => {
              // èªéŸ³æ’­ç•¢å¾Œï¼Œå…ˆè®“ç­”æ¡ˆç‡ˆè™Ÿå’Œç‹€æ…‹æç¤ºä¸€èµ·ç†„æ»…
              clearKeysHighlight(tones);
              updateStatusHint(null, false);
            });
          }, totalDuration * 1000);
        }
      } else {
        // ç­”éŒ¯æ™‚ä¹Ÿè¦æ’­æ”¾ç­”æ¡ˆéŸ³ä¸¦ç¹¼çºŒå¾ªç’°æ’­æ”¾
        // å–®éŸ³æ¨¡å¼ï¼šåŒä¸€é¡ŒéŒ¯èª¤åªè¨ˆä¸€æ¬¡
        if (q.type !== 'note' || !q.__countedWrong) {
          state.score.wrong++;
          if (q.type === 'note') q.__countedWrong = true;
        }
        // éŸ³ç¨‹è¾¨è­˜ï¼šåŒä¸€é¡ŒéŒ¯èª¤åªè¨ˆä¸€æ¬¡
        if ((q.type === 'interval_up' || q.type === 'interval_down') && !q.__countedWrong) {
          state.score.wrong++;
          q.__countedWrong = true;
        }
        // å’Œè²éŸ³ç¨‹è¾¨è­˜ï¼šåŒä¸€é¡ŒéŒ¯èª¤åªè¨ˆä¸€æ¬¡
        if (q.type === 'interval_harm' && !q.__countedWrong) {
          state.score.wrong++;
          q.__countedWrong = true;
        }
        // ä¸‰å’Œå¼¦è¾¨è­˜ï¼šåŒä¸€é¡ŒéŒ¯èª¤åªè¨ˆä¸€æ¬¡
        if (q.type === 'triad' && !q.__countedWrong) {
          state.score.wrong++;
          q.__countedWrong = true;
        }
        // ä¸ƒå’Œå¼¦è¾¨è­˜ï¼šåŒä¸€é¡ŒéŒ¯èª¤åªè¨ˆä¸€æ¬¡
        if (q.type === 'seventh' && !q.__countedWrong) {
          state.score.wrong++;
          q.__countedWrong = true;
        }
        state.score.streak = 0;
        
        // ç­”éŒ¯æ™‚ä¹Ÿæ’­æ”¾ç­”æ¡ˆéŸ³ï¼ˆå’Œç­”å°æ™‚ä¸€æ¨£ï¼‰
        // å–®éŸ³æ¨¡å¼ï¼šç­”éŒ¯æ™‚é¡¯ç¤ºç­”æ¡ˆéŸ³æç¤ºä¸¦æ’­æ”¾ç­”æ¡ˆ
        if (q.type === 'note') {
          const ansMidi = Number(q.answerKey);
          const answerFreq = midiToFreq(ansMidi);
          playTone(answerFreq, 1000, state.wave, 15, 0);
          // ç­”æ¡ˆéŸ³éµèˆ‡æç¤ºå­—åŒæ­¥äº® 1000msï¼Œç„¶å¾Œä¸€èµ·ç†„æ»…
          highlightAnswer(ansMidi);
          setTimeout(()=>{ clearAnswerHighlight(ansMidi); }, 1000);
          // æ’­æ”¾ç­”æ¡ˆéŸ³æ™‚æ‰é¡¯ç¤ºã€Œç­”æ¡ˆï¼šã€ä½¿ç”¨éŸ³å
          solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+midiToNoteNameOnly(ansMidi)+'</b>';
          
          // ç­‰éŸ³ç¬¦æ’­æ”¾å®Œæˆå¾Œå†å¿µèªéŸ³ï¼Œç„¶å¾Œå¾ªç’°æ’­æ”¾
          setTimeout(() => {
            const pc = Number(ansMidi) % 12;
            const sharpName = PCN[pc];
            const engName = sharpName.replace('#', '-Sharp');
            speakText(engName, () => {
              // èªéŸ³æ’­ç•¢å¾Œï¼Œå…ˆè®“ç­”æ¡ˆç‡ˆè™Ÿä¸€èµ·ç†„æ»…ï¼Œå†å¾ªç’°æ’­æ”¾
              clearAnswerHighlight(ansMidi);
              setTimeout(()=>{ 
                // å¾ªç’°æ’­æ”¾ï¼šé‡æ’­é¡Œç›®
                q.__answered = false; // é‡ç½®ç­”é¡Œç‹€æ…‹ï¼Œå…è¨±ç¹¼çºŒç­”é¡Œ
                stopAllAudioAndSpeech();
                ensureAudio();
                const playStartTime = audioCtx.currentTime;
                const questionEndTimeRelative = q.play();
                if(q.type==='note' || q.type==='interval_up' || q.type==='interval_down' || q.type==='interval_harm' || q.type==='triad' || q.type==='seventh'){
                  const questionEndTimeAbsolute = playStartTime + questionEndTimeRelative;
                  scheduleReveal(questionEndTimeAbsolute);
                }
              }, 600);
            });
          }, 1000);
        }
        // éŸ³ç¨‹è¾¨è­˜ï¼šç­”éŒ¯æ™‚é¡¯ç¤ºç­”æ¡ˆéŸ³æç¤ºä¸¦æ’­æ”¾é¡Œç›®éŸ³
        else if (q.type === 'interval_up' || q.type === 'interval_down') {
          const ansMidi = Number(q.answerKey);
          const baseMidi = Number(q.baseMidi);
          const intervalSteps = Number(q.intervalSteps);
          
          // æ¿€æ´»ç­”æ¡ˆéŸ³çŠ¶æ€æç¤º
          updateStatusHint(hintAnswerEl, true);
          
          // æ’­æ”¾é¡Œç›®éŸ³ï¼šå…ˆæ’­æ”¾é¡Œç›®éŸ³çš„ç¬¬ä¸€å€‹éŸ³ï¼Œå†æ’­æ”¾é¡Œç›®éŸ³çš„ç¬¬äºŒå€‹éŸ³
          if(q.type === 'interval_up'){
            playTone(midiToFreq(baseMidi), 600, state.wave, 15, 0);
            highlightKeysManual([baseMidi]);
            playTone(midiToFreq(ansMidi), 1000, state.wave, 15, 0.7);
            setTimeout(()=>highlightKeysManual([ansMidi]), 700);
            const answerText = formatIntervalAnswer(baseMidi, ansMidi, intervalSteps);
            solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+answerText+'</b>';
          } else {
            playTone(midiToFreq(baseMidi), 600, state.wave, 15, 0);
            highlightKeysManual([baseMidi]);
            playTone(midiToFreq(ansMidi), 1000, state.wave, 15, 0.7);
            setTimeout(()=>highlightKeysManual([ansMidi]), 700);
            const answerText = formatIntervalAnswer(baseMidi, ansMidi, intervalSteps);
            solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+answerText+'</b>';
          }
          
          // ç­‰éŸ³ç¨‹æ’­æ”¾å®Œæˆå¾Œå†å¿µèªéŸ³ï¼Œç„¶å¾Œå¾ªç’°æ’­æ”¾
          setTimeout(() => {
            const speechText = intervalSpeechText(baseMidi, ansMidi, intervalSteps);
            speakText(speechText, () => {
              // èªéŸ³æ’­ç•¢å¾Œï¼Œå…ˆè®“ç­”æ¡ˆç‡ˆè™Ÿå’Œç‹€æ…‹æç¤ºä¸€èµ·ç†„æ»…ï¼Œå†å¾ªç’°æ’­æ”¾
              clearKeysHighlight([baseMidi, ansMidi]);
              updateStatusHint(null, false);
              setTimeout(()=>{ 
                // å¾ªç’°æ’­æ”¾ï¼šé‡æ’­é¡Œç›®
                q.__answered = false; // é‡ç½®ç­”é¡Œç‹€æ…‹ï¼Œå…è¨±ç¹¼çºŒç­”é¡Œ
                stopAllAudioAndSpeech();
                ensureAudio();
                const playStartTime = audioCtx.currentTime;
                const questionEndTimeRelative = q.play();
                if(q.type==='note' || q.type==='interval_up' || q.type==='interval_down' || q.type==='interval_harm' || q.type==='triad' || q.type==='seventh'){
                  const questionEndTimeAbsolute = playStartTime + questionEndTimeRelative;
                  scheduleReveal(questionEndTimeAbsolute);
                }
              }, 600);
            });
          }, 1700);
        }
        // å’Œè²éŸ³ç¨‹è¾¨è­˜ï¼šç­”éŒ¯æ™‚é¡¯ç¤ºç­”æ¡ˆéŸ³æç¤ºä¸¦æ’­æ”¾é¡Œç›®éŸ³
        else if (q.type === 'interval_harm') {
          const baseMidi = Number(q.baseMidi);
          const otherMidi = Number(q.otherMidi);
          const intervalSteps = Number(q.intervalSteps);
          
          // æ¿€æ´»ç­”æ¡ˆéŸ³çŠ¶æ€æç¤º
          updateStatusHint(hintAnswerEl, true);
          
          // æ’­æ”¾é¡Œç›®éŸ³ï¼šåŒæ™‚æ’­æ”¾baseå’Œotherï¼ˆå’Œè²éŸ³ç¨‹ï¼‰
          const bf = midiToFreq(baseMidi), of = midiToFreq(otherMidi);
          playTone(bf, 1100, state.wave, 15, 0);
          playTone(of, 1100, state.wave, 15, 0);
          highlightKeysManual([baseMidi, otherMidi]);
          
          const answerText = formatIntervalAnswer(baseMidi, otherMidi, intervalSteps);
          solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+answerText+'</b>';
          
          // ç­‰éŸ³ç¨‹æ’­æ”¾å®Œæˆå¾Œå†å¿µèªéŸ³ï¼Œç„¶å¾Œå¾ªç’°æ’­æ”¾
          setTimeout(() => {
            const speechText = intervalSpeechText(baseMidi, otherMidi, intervalSteps);
            speakText(speechText, () => {
              // èªéŸ³æ’­ç•¢å¾Œï¼Œå…ˆè®“ç­”æ¡ˆç‡ˆè™Ÿå’Œç‹€æ…‹æç¤ºä¸€èµ·ç†„æ»…ï¼Œå†å¾ªç’°æ’­æ”¾
              clearKeysHighlight([baseMidi, otherMidi]);
              updateStatusHint(null, false);
              setTimeout(()=>{ 
                // å¾ªç’°æ’­æ”¾ï¼šé‡æ’­é¡Œç›®
                q.__answered = false; // é‡ç½®ç­”é¡Œç‹€æ…‹ï¼Œå…è¨±ç¹¼çºŒç­”é¡Œ
                stopAllAudioAndSpeech();
                ensureAudio();
                const playStartTime = audioCtx.currentTime;
                const questionEndTimeRelative = q.play();
                if(q.type==='note' || q.type==='interval_up' || q.type==='interval_down' || q.type==='interval_harm' || q.type==='triad' || q.type==='seventh'){
                  const questionEndTimeAbsolute = playStartTime + questionEndTimeRelative;
                  scheduleReveal(questionEndTimeAbsolute);
                }
              }, 600);
            });
          }, 1100);
        }
        // ä¸‰å’Œå¼¦è¾¨è­˜ï¼šç­”éŒ¯æ™‚é¡¯ç¤ºç­”æ¡ˆéŸ³æç¤ºä¸¦æ’­æ”¾é¡Œç›®éŸ³
        else if (q.type === 'triad') {
          const tones = q.tones || [];
          const rootMidi = Number(q.rootMidi || q.answerKey);
          const chordType = q.chordType;
          
          // æ¿€æ´»ç­”æ¡ˆéŸ³çŠ¶æ€æç¤º
          updateStatusHint(hintAnswerEl, true);
          
          // å…ˆæ’­æ”¾åˆ†è§£å’Œå¼¦ï¼ˆæŒ‰é¡ºåºæ’­æ”¾æ¯ä¸ªéŸ³ï¼‰
          const arpeggioNoteDur = 300;
          const arpeggioGap = 0.1;
          const harmonyDur = 800;
          
          tones.forEach((tone, index) => {
            const when = index * (arpeggioNoteDur/1000 + arpeggioGap);
            playTone(midiToFreq(tone), arpeggioNoteDur, state.wave, 15, when);
            setTimeout(() => {
              highlightKeysManual([tone]);
            }, when * 1000);
          });
          
          // å†æ’­æ”¾å’Œå£°ï¼ˆåŒæ—¶æ’­æ”¾æ‰€æœ‰éŸ³ï¼‰
          const harmonyWhen = tones.length * (arpeggioNoteDur/1000 + arpeggioGap) + 0.15;
          tones.forEach(tone => {
            playTone(midiToFreq(tone), harmonyDur, state.wave, 15, harmonyWhen);
          });
          setTimeout(() => {
            highlightKeysManual(tones);
          }, harmonyWhen * 1000);
          
          const displayName = chordDisplayName(rootMidi, chordType, q.inversion, tones);
          solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+displayName+'</b>';
          
          // ç­‰å’Œå¼¦æ’­æ”¾å®Œæˆå¾Œå†å¿µèªéŸ³ï¼Œç„¶å¾Œå¾ªç’°æ’­æ”¾
          const totalDuration = harmonyWhen + harmonyDur / 1000;
          setTimeout(() => {
            const speechText = chordSpeechText(rootMidi, chordType, false);
            speakText(speechText, () => {
              // èªéŸ³æ’­ç•¢å¾Œï¼Œå…ˆè®“ç­”æ¡ˆç‡ˆè™Ÿå’Œç‹€æ…‹æç¤ºä¸€èµ·ç†„æ»…ï¼Œå†å¾ªç’°æ’­æ”¾
              clearKeysHighlight(tones);
              updateStatusHint(null, false);
              setTimeout(()=>{ 
                // å¾ªç’°æ’­æ”¾ï¼šé‡æ’­é¡Œç›®
                q.__answered = false; // é‡ç½®ç­”é¡Œç‹€æ…‹ï¼Œå…è¨±ç¹¼çºŒç­”é¡Œ
                stopAllAudioAndSpeech();
                ensureAudio();
                const playStartTime = audioCtx.currentTime;
                const questionEndTimeRelative = q.play();
                if(q.type==='note' || q.type==='interval_up' || q.type==='interval_down' || q.type==='interval_harm' || q.type==='triad' || q.type==='seventh'){
                  const questionEndTimeAbsolute = playStartTime + questionEndTimeRelative;
                  scheduleReveal(questionEndTimeAbsolute);
                }
              }, 600);
            });
          }, totalDuration * 1000);
        }
        // ä¸ƒå’Œå¼¦è¾¨è­˜ï¼šç­”éŒ¯æ™‚å…ˆæ’­æ”¾åˆ†è§£å’Œå¼¦ï¼Œå†æ’­æ”¾å’Œè²
        else if (q.type === 'seventh') {
          const tones = q.tones || [];
          const rootMidi = Number(q.rootMidi || q.answerKey);
          const chordType = q.chordType;
          
          // æ¿€æ´»ç­”æ¡ˆéŸ³çŠ¶æ€æç¤º
          updateStatusHint(hintAnswerEl, true);
          
          // å…ˆæ’­æ”¾åˆ†è§£å’Œå¼¦ï¼ˆæŒ‰é¡ºåºæ’­æ”¾æ¯ä¸ªéŸ³ï¼‰
          const arpeggioNoteDur = 300;
          const arpeggioGap = 0.1;
          const harmonyDur = 900;
          
          tones.forEach((tone, index) => {
            const when = index * (arpeggioNoteDur/1000 + arpeggioGap);
            playTone(midiToFreq(tone), arpeggioNoteDur, state.wave, 15, when);
            setTimeout(() => {
              highlightKeysManual([tone]);
            }, when * 1000);
          });
          
          // å†æ’­æ”¾å’Œå£°ï¼ˆåŒæ—¶æ’­æ”¾æ‰€æœ‰éŸ³ï¼‰
          const harmonyWhen = tones.length * (arpeggioNoteDur/1000 + arpeggioGap) + 0.15;
          tones.forEach(tone => {
            playTone(midiToFreq(tone), harmonyDur, state.wave, 15, harmonyWhen);
          });
          setTimeout(() => {
            highlightKeysManual(tones);
          }, harmonyWhen * 1000);
          
          const displayName = chordDisplayName(rootMidi, chordType, q.inversion, tones);
          solfegeEl.innerHTML = 'ç­”æ¡ˆï¼š<b>'+displayName+'</b>';
          
          // ç­‰å’Œå¼¦æ’­æ”¾å®Œæˆå¾Œå†å¿µèªéŸ³ï¼Œç„¶å¾Œå¾ªç’°æ’­æ”¾
          const totalDuration = harmonyWhen + harmonyDur / 1000;
          setTimeout(() => {
            const speechText = chordSpeechText(rootMidi, chordType, true);
            speakText(speechText, () => {
              // èªéŸ³æ’­ç•¢å¾Œï¼Œå…ˆè®“ç­”æ¡ˆç‡ˆè™Ÿå’Œç‹€æ…‹æç¤ºä¸€èµ·ç†„æ»…ï¼Œå†å¾ªç’°æ’­æ”¾
              clearKeysHighlight(tones);
              updateStatusHint(null, false);
              setTimeout(()=>{ 
                // å¾ªç’°æ’­æ”¾ï¼šé‡æ’­é¡Œç›®
                q.__answered = false; // é‡ç½®ç­”é¡Œç‹€æ…‹ï¼Œå…è¨±ç¹¼çºŒç­”é¡Œ
                stopAllAudioAndSpeech();
                ensureAudio();
                const playStartTime = audioCtx.currentTime;
                const questionEndTimeRelative = q.play();
                if(q.type==='note' || q.type==='interval_up' || q.type==='interval_down' || q.type==='interval_harm' || q.type==='triad' || q.type==='seventh'){
                  const questionEndTimeAbsolute = playStartTime + questionEndTimeRelative;
                  scheduleReveal(questionEndTimeAbsolute);
                }
              }, 600);
            });
          }, totalDuration * 1000);
        }
      }
      correctEl.textContent=state.score.correct; wrongEl.textContent=state.score.wrong; streakEl.textContent=state.score.streak;

      // å–®éŸ³æ¨¡å¼ï¼šç­”å°è‡ªå‹•ä¸‹ä¸€é¡Œ
      if (q.type==='note' && ok) { setTimeout(()=>newQuestion(), 1500); }
      // éŸ³ç¨‹è¾¨è­˜ï¼šç­”å°è‡ªå‹•ä¸‹ä¸€é¡Œ
      if ((q.type==='interval_up' || q.type==='interval_down' || q.type==='interval_harm') && ok) { setTimeout(()=>newQuestion(), 1500); }
      // å’Œå¼¦è¾¨è­˜ï¼ˆä¸‰å’Œå¼¦/ä¸ƒå’Œå¼¦ï¼‰ï¼šç­”å°è‡ªå‹•ä¸‹ä¸€é¡Œ
      if ((q.type==='triad' || q.type==='seventh') && ok) { setTimeout(()=>newQuestion(), 1500); }
    }

    // ---------- Group switch ----------
    function setGroup(cMidi){
      state.groupC = Math.max(MIDI_C1, Math.min(MIDI_C7, cMidi));
      buildPiano();
      localStorage.setItem('ear_groupC', String(state.groupC));
      newQuestion(); // å³æ™‚å‡ºé¡Œ
    }

    // ---------- Events ----------
    modeEl.addEventListener('change', ()=>{
      buildPiano(); // é‡æ–°æ„å»ºé’¢ç´ï¼ˆå¯èƒ½éœ€è¦åœ¨1ä¸ªæˆ–2ä¸ªéŸ³åŒºä¹‹é—´åˆ‡æ¢ï¼‰
      newQuestion();
    });
    waveEl.addEventListener('change', ()=>state.wave=waveEl.value);
    volumeEl.addEventListener('input', ()=>{ ensureAudio(); masterGain.gain.setTargetAtTime(Number(volumeEl.value), audioCtx.currentTime, 0.01); });
    noteScopeEl.addEventListener('change', ()=>{ state.noteScope = noteScopeEl.value; if (modeEl.value==='note') newQuestion(); });
    revealEl.addEventListener('change', ()=>{ state.revealSeconds = Number(revealEl.value); localStorage.setItem('ear_revealSeconds', String(state.revealSeconds)); if ((modeEl.value==='note' || modeEl.value==='interval_up' || modeEl.value==='interval_down' || modeEl.value==='interval_harm' || modeEl.value==='triad' || modeEl.value==='seventh') && state.current) { ensureAudio(); const playStartTime = audioCtx.currentTime; const questionEndTimeRelative = state.current.play(); const questionEndTimeAbsolute = playStartTime + questionEndTimeRelative; scheduleReveal(questionEndTimeAbsolute); } });
    playBtn.addEventListener('click', ()=>{ 
      // å¼ºåˆ¶æ¿€æ´»è¯­éŸ³ï¼ˆç§»åŠ¨ç«¯éœ€è¦æ¯æ¬¡ç”¨æˆ·äº¤äº’åæ¿€æ´»ï¼‰
      __speechActivated = false;
      __speechTestAttempts = 0;
      activateSpeech(true);
      if(!state.current) newQuestion(); else { stopAllAudioAndSpeech(); ensureAudio(); const playStartTime = audioCtx.currentTime; const questionEndTimeRelative = state.current.play(); if(state.current.type==='note' || state.current.type==='interval_up' || state.current.type==='interval_down' || state.current.type==='interval_harm' || state.current.type==='triad' || state.current.type==='seventh') { const questionEndTimeAbsolute = playStartTime + questionEndTimeRelative; scheduleReveal(questionEndTimeAbsolute); } } 
    });
    repeatBtn.addEventListener('click', ()=>{ 
      // å¼ºåˆ¶æ¿€æ´»è¯­éŸ³
      __speechActivated = false;
      __speechTestAttempts = 0;
      activateSpeech(true);
      if(state.current) { stopAllAudioAndSpeech(); ensureAudio(); const playStartTime = audioCtx.currentTime; const questionEndTimeRelative = state.current.play(); if(state.current.type==='note' || state.current.type==='interval_up' || state.current.type==='interval_down' || state.current.type==='interval_harm' || state.current.type==='triad' || state.current.type==='seventh') { const questionEndTimeAbsolute = playStartTime + questionEndTimeRelative; scheduleReveal(questionEndTimeAbsolute); } } 
    });
    giveUpBtn.addEventListener('click', ()=>{ 
      // å¼ºåˆ¶æ¿€æ´»è¯­éŸ³
      __speechActivated = false;
      __speechTestAttempts = 0;
      activateSpeech(true);
      if(state.current){ showAnswerOnly(); } 
    });
    nextBtn.addEventListener('click', ()=>{ 
      // å¼ºåˆ¶æ¿€æ´»è¯­éŸ³
      __speechActivated = false;
      __speechTestAttempts = 0;
      activateSpeech(true);
      newQuestion(); 
    });
    prevGroupBtn.addEventListener('click', ()=>setGroup(state.groupC-12));
    nextGroupBtn.addEventListener('click', ()=>setGroup(state.groupC+12));
    document.addEventListener('keydown', (e)=>{
      if(['INPUT','SELECT','TEXTAREA'].includes(e.target.tagName)) return;
      // å¼ºåˆ¶æ¿€æ´»è¯­éŸ³ï¼ˆç§»åŠ¨ç«¯éœ€è¦æ¯æ¬¡ç”¨æˆ·äº¤äº’åæ¿€æ´»ï¼‰
      __speechActivated = false;
      __speechTestAttempts = 0;
      activateSpeech(true);
      if(e.code==='Space'){
        e.preventDefault();
        if(!state.current){
          newQuestion();
        }else{
          // é‡æ’­ï¼šå…ˆæ‰“æ–·æ‰€æœ‰è²éŸ³ã€èªéŸ³å’Œå®šæ™‚å™¨ï¼Œå†å¾é ­æ’­æ”¾ï¼Œä¸¦é‡æ–°å•Ÿå‹•è¨ˆæ™‚èˆ‡æç¤º
          stopAllAudioAndSpeech();
          ensureAudio();
          const playStartTime = audioCtx.currentTime;
          const questionEndTimeRelative = state.current.play();
          if(state.current.type==='note' || state.current.type==='interval_up' || state.current.type==='interval_down' || state.current.type==='interval_harm' || state.current.type==='triad' || state.current.type==='seventh') {
            const questionEndTimeAbsolute = playStartTime + questionEndTimeRelative;
            scheduleReveal(questionEndTimeAbsolute);
          }
        }
      }
      if(e.key.toLowerCase()==='r'){
        e.preventDefault();
        if(state.current){
          // é‡æ’­ï¼šå…ˆæ‰“æ–·æ‰€æœ‰è²éŸ³ã€èªéŸ³å’Œå®šæ™‚å™¨ï¼Œå†å¾é ­æ’­æ”¾ï¼Œä¸¦é‡æ–°å•Ÿå‹•è¨ˆæ™‚èˆ‡æç¤º
          stopAllAudioAndSpeech();
          ensureAudio();
          const playStartTime = audioCtx.currentTime;
          const questionEndTimeRelative = state.current.play();
          if(state.current.type==='note' || state.current.type==='interval_up' || state.current.type==='interval_down' || state.current.type==='interval_harm' || state.current.type==='triad' || state.current.type==='seventh') {
            const questionEndTimeAbsolute = playStartTime + questionEndTimeRelative;
            scheduleReveal(questionEndTimeAbsolute);
          }
        }
      }
      if(e.key.toLowerCase()==='n'){ e.preventDefault(); newQuestion(); }
      if(e.key==='ArrowLeft'){ e.preventDefault(); setGroup(state.groupC-12); }
      if(e.key==='ArrowRight'){ e.preventDefault(); setGroup(state.groupC+12); }
    });

    // ---------- Init ----------
    (function init(){
      const saved = Number(localStorage.getItem('ear_groupC'));
      if(!Number.isNaN(saved)) state.groupC = saved;
      const savedReveal = Number(localStorage.getItem('ear_revealSeconds'));
      if(!Number.isNaN(savedReveal) && [1,3,5,7].includes(savedReveal)) state.revealSeconds = savedReveal;
      buildPiano();
      groupLabelEl.textContent = nameRange(state.groupC);
      // åŒæ­¥ä¸‹æ‹‰ã€‚
      revealEl.value = String(state.revealSeconds);
      
      // é¢„åŠ è½½è¯­éŸ³åˆ—è¡¨ï¼Œç¡®ä¿è¯­éŸ³å¯ç”¨
      ensureVoicesLoaded(() => {
        // è¯­éŸ³åˆ—è¡¨å·²åŠ è½½
        // å°è¯•é¢„æ¿€æ´»è¯­éŸ³ï¼ˆæŸäº›ç§»åŠ¨æµè§ˆå™¨å¯èƒ½æ”¯æŒï¼‰
        if(isSpeechSynthesisSupported()){
          // å»¶è¿Ÿä¸€ç‚¹å†å°è¯•ï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
          setTimeout(() => {
            activateSpeech();
          }, 500);
        }
      });
      
      // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œå½“é¡µé¢é‡æ–°å¯è§æ—¶é‡æ–°æ¿€æ´»è¯­éŸ³
      document.addEventListener('visibilitychange', () => {
        if(!document.hidden && isSpeechSynthesisSupported()){
          // é¡µé¢é‡æ–°å¯è§æ—¶ï¼Œé‡ç½®æ¿€æ´»çŠ¶æ€å¹¶é‡æ–°å°è¯•
          __speechActivated = false;
          __speechTestAttempts = 0;
          setTimeout(() => {
            activateSpeech();
          }, 200);
        }
      });
    })();
  </script>
</body>
</html>
